<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T-Shop KDS | Caf√© Cloud Club</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Reusing KDS Styles */
        :root { 
            --bg: #0f172a; 
            --surface: #1e293b; 
            --surface-hover: #334155; 
            --border: #334155; 
            --primary: #10b981; /* Green/Teal for Tea Shop */ 
            --success: #10b981; 
            --warning: #f59e0b; 
            --danger: #ef4444; 
            --text-main: #ffffff; 
            --text-muted: #9ca3af; 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .kds-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; background: #1e293b; border-bottom: 1px solid var(--border); height: 70px; flex-shrink: 0; }
        .brand { font-size: 1.5rem; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--primary); }
        .clock { font-family: 'JetBrains Mono'; font-size: 1.2rem; font-weight: 700; color: var(--text-muted); }
        
        #pin-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.98); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-box { background: var(--surface); padding: 40px; border-radius: 16px; border: 1px solid var(--border); text-align: center; }
        .pin-input { background: var(--bg); border: 1px solid var(--border); color: white; font-size: 2rem; text-align: center; letter-spacing: 10px; padding: 10px; border-radius: 8px; width: 200px; margin: 20px 0; outline: none; font-family: 'JetBrains Mono'; }
        .btn-unlock { background: var(--primary); width: 100%; padding: 12px; border:none; border-radius:8px; color:white; font-weight:800; cursor:pointer; font-size: 1rem; }
        
        .kds-container { flex: 1; padding: 20px; overflow-y: auto; overflow-x: hidden; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; align-content: start; }
        
        .kot-card { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; animation: slideIn 0.3s ease-out; height: fit-content; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        
        /* Highlight cards that are fully ready but waiting for pickup/serving */
        .kot-card.card-done { border: 2px solid var(--success); opacity: 0.8; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .kot-header { padding: 12px 15px; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; user-select: none; }
        .kot-header:hover { background: rgba(255,255,255,0.05); }
        
        .kot-id { font-family: 'JetBrains Mono'; font-weight: 800; font-size: 1.1rem; }
        .kot-timer { font-family: 'JetBrains Mono'; font-weight: 700; font-size: 1rem; padding: 4px 8px; border-radius: 4px; background: rgba(0,0,0,0.2); }
        .timer-fresh { color: var(--success); }
        .timer-warn { color: var(--warning); }
        .timer-late { color: var(--danger); animation: pulse 2s infinite; }
        .timer-done { color: var(--text-main); background: var(--success); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        
        .kot-info { padding: 10px 15px; font-size: 0.9rem; color: var(--text-muted); border-bottom: 1px dashed var(--border); display: flex; justify-content: space-between; }
        .kot-type-badge { font-weight: 700; text-transform: uppercase; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border); }
        
        .kot-items { padding: 5px 0; }
        .kot-item { padding: 12px 15px; border-bottom: 1px solid #334155; cursor: pointer; display: flex; justify-content: space-between; align-items: flex-start; transition: background 0.1s; font-size: 1.05rem; line-height: 1.4; }
        .kot-item:last-child { border-bottom: none; }
        .kot-item:hover { background: var(--surface-hover); }
        
        .item-qty { font-weight: 800; color: var(--primary); margin-right: 10px; min-width: 25px; }
        .item-name { flex: 1; font-weight: 500; }
        
        .kot-note { padding: 10px 15px; background: rgba(245, 158, 11, 0.1); color: var(--warning); font-size: 0.85rem; font-weight: 600; border-top: 1px solid var(--border); }
        .ready-msg { padding: 20px; text-align: center; color: var(--success); font-weight: 800; background: rgba(16, 185, 129, 0.1); font-size: 0.9rem; }
        .waiting-msg { padding: 20px; text-align: center; color: var(--warning); font-weight: 800; background: rgba(245, 158, 11, 0.1); font-size: 0.9rem; }

        .header-hint { font-size: 0.7rem; color: var(--success); text-transform: uppercase; letter-spacing: 1px; opacity: 0; transition: opacity 0.2s; text-align: right; }
        .kot-header:hover .header-hint { opacity: 1; }
        
        .empty-msg { width: 100%; text-align: center; margin-top: 100px; color: var(--border); font-size: 1.5rem; font-weight: 700; opacity: 0.5; }
    </style>
</head>
<body>
    <div id="pin-overlay">
        <div class="pin-box">
            <h2 style="margin-top:0;">üçµ T-Shop KDS</h2>
            <input type="password" id="pin-input" class="pin-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" autofocus>
            <button class="btn-unlock" onclick="checkPin()">OPEN T-SHOP</button>
        </div>
    </div>

    <header class="kds-header">
        <div class="brand"><i class="fas fa-mug-hot"></i> T-SHOP <span>KDS</span></div>
        <div id="clock" class="clock">00:00</div>
    </header>

    <div id="active-container" class="kds-container">
        <div class="empty-msg">NO ORDERS<br>BREW SOME TEA</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9d8Seuez7ihaTSAuPyoCwqjKIR1-VFKg",
            authDomain: "cafe-orders-1afa1.firebaseapp.com",
            databaseURL: "https://cafe-orders-1afa1-default-rtdb.firebaseio.com",
            projectId: "cafe-orders-1afa1",
            messagingSenderId: "274410745480",
            appId: "1:274410745480:web:9964c3914d512aed8d793d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- CONFIGURATION ---
        // T-Shop KDS shows ONLY this category
        const INCLUDED_CATEGORY = "Cafe Botanical Brews";
        const ACCESS_PIN = "2024";
        
        const bell = new Audio('kdsound.mp3'); 
        let activeOrders = [];
        let previousTotalItems = 0;
        let isFirstLoad = true;

        // Wake Lock
        async function requestWakeLock() {
            try { if ('wakeLock' in navigator) await navigator.wakeLock.request('screen'); } catch (err) {}
        }
        document.addEventListener('click', () => requestWakeLock(), { once: true });
        
        // --- LOGIC ---
        window.checkPin = function() {
            if(document.getElementById('pin-input').value === ACCESS_PIN) {
                bell.play().then(() => { bell.pause(); bell.currentTime = 0; }).catch(e=>{});
                document.getElementById('pin-overlay').style.display = 'none';
                initKDS();
            } else { 
                alert("Incorrect PIN"); 
                document.getElementById('pin-input').value = ""; 
            }
        }

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }, 1000);

        function initKDS() {
            onValue(ref(db, 'orders'), (snapshot) => {
                const data = snapshot.val();
                activeOrders = [];
                let currentTotalItems = 0;
                
                if (data) {
                    Object.entries(data).forEach(([key, order]) => {
                        // 1. FILTER: HIDE IF SERVED/COMPLETED/REJECTED/PENDING
                        // We KEEP 'cooking' and 'done' (Ready but waiting for service)
                        if (order.status === 'completed' || order.status === 'rejected' || order.status === 'pending' || order.status === 'served') return;
                        
                        // FILTER: ONLY GET RELEVANT ITEMS
                        let relevantItems = [];
                        if(order.items) {
                            relevantItems = order.items.filter(i => i.category === INCLUDED_CATEGORY);
                        }
                        
                        if (relevantItems.length > 0) {
                             // Show if status is cooking OR done
                            if (order.status === 'cooking' || order.status === 'done') {
                                activeOrders.push({ key, ...order });
                                
                                // Only count items that aren't done for the notification sound
                                const pendingItems = relevantItems.filter(i => !i.kitchenDone).length;
                                currentTotalItems += pendingItems;
                            }
                        }
                    });
                }
                activeOrders.sort((a, b) => a.timestamp - b.timestamp);

                if (!isFirstLoad && currentTotalItems > previousTotalItems) {
                    bell.currentTime = 0;
                    bell.play().catch(e => console.log("Audio blocked"));
                }
                previousTotalItems = currentTotalItems;
                isFirstLoad = false;
                renderActiveOrders();
            });
        }

        function renderActiveOrders() {
            const container = document.getElementById('active-container');
            container.innerHTML = "";
            if (activeOrders.length === 0) {
                container.innerHTML = `<div class="empty-msg">NO ORDERS<br>BREW SOME TEA</div>`;
                return;
            }

            activeOrders.forEach(order => {
                const elapsedMin = Math.floor((Date.now() - order.timestamp) / 60000);
                let timerClass = 'timer-fresh';
                if(elapsedMin > 10) timerClass = 'timer-warn';
                if(elapsedMin > 20) timerClass = 'timer-late';
                if(order.status === 'done') timerClass = 'timer-done';

                let itemsHtml = "";
                let visibleItemCount = 0;

                if (order.items) {
                    order.items.forEach((item, index) => {
                        // FILTER: SHOW ONLY BREWS
                        if (item.category !== INCLUDED_CATEGORY) return;

                        if (item.kitchenDone === true && !item.deleted) return; 

                        visibleItemCount++;
                        
                        let variantHtml = '';
                        if(item.variant && item.variant.trim() !== "") {
                            variantHtml = `<div style="font-size:0.8rem; color:var(--success); margin-top:4px; font-weight:600;">${item.variant}</div>`;
                        }

                        itemsHtml += `
                            <div class="kot-item" onclick="toggleItem('${order.key}', ${index}, ${!item.kitchenDone})">
                                <span class="item-qty">${item.qty}</span>
                                <div class="item-name">
                                    ${item.name}
                                    ${variantHtml}
                                </div>
                            </div>`;
                    });
                }

                if (visibleItemCount === 0) {
                    if (order.status === 'done') {
                        itemsHtml = `<div class="waiting-msg">READY<br>WAITING FOR SERVICE</div>`;
                    } else {
                        itemsHtml = `<div class="ready-msg">BREWS READY<br>TAP HEADER TO COMPLETE</div>`;
                    }
                }

                let noteHtml = (order.globalNote && order.globalNote !== "-" && order.globalNote.trim() !== "") ? `<div class="kot-note">üìù ${order.globalNote}</div>` : "";
                
                let cardClass = "kot-card";
                if(order.status === 'done') cardClass += " card-done";

                const card = document.createElement('div');
                card.className = cardClass;
                card.innerHTML = `
                    <div class="kot-header" onclick="completeOrder('${order.key}')">
                        <span class="kot-id">#${order.orderId}</span>
                        <div><span class="header-hint">TAP TO MARK READY ‚úì</span> <span class="kot-timer ${timerClass}">${elapsedMin}m</span></div>
                    </div>
                    <div class="kot-info"><span style="font-weight:700">${order.customer.name}</span><span class="kot-type-badge">${order.orderType || 'Dine-In'}</span></div>
                    <div class="kot-items">${itemsHtml}</div>
                    ${noteHtml}
                `;
                container.appendChild(card);
            });
        }

        window.toggleItem = (key, index, status) => {
            update(ref(db, `orders/${key}/items/${index}`), { kitchenDone: status });
        };

        window.completeOrder = (key) => {
            const order = activeOrders.find(o => o.key === key);
            if(!order) return;

             // If it's already done, prevent toggling again
             if(order.status === 'done') {
                alert("This order is already marked READY.\nWaiting for Manager/Waiter to serve.");
                return;
            }

            if(confirm(`Mark T-Shop Items for #${order.orderId} as READY?`)) {
                const updates = {};
                let allItemsWillBeDone = true;

                order.items.forEach((item, index) => {
                    // Check if this item belongs to T-Shop
                    if (item.category === INCLUDED_CATEGORY) {
                        updates[`items/${index}/kitchenDone`] = true;
                    } else {
                        // This is a Chef item. Check if it is done.
                        if (!item.kitchenDone && !item.deleted) allItemsWillBeDone = false;
                    }
                });

                // Only complete the whole order if Chef is also done
                if (allItemsWillBeDone) {
                    updates['status'] = 'done';
                }

                update(ref(db, `orders/${key}`), updates);
            }
        };
    </script>
</body>
</html>
