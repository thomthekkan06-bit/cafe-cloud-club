<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales History | Cafe Cloud Club</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --border: #333;
            --accent-green: #27ae60;
            --accent-blue: #2980b9;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); padding: 20px; }
        
        /* PIN LOCK STYLES */
        #pin-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-box { background: #1e1e1e; padding: 40px; border-radius: 12px; border: 1px solid #333; text-align: center; width: 300px; }
        .pin-input { width: 100%; padding: 15px; margin: 20px 0; background: #121212; border: 1px solid #333; color: white; font-size: 1.5rem; text-align: center; letter-spacing: 5px; border-radius: 8px; }
        .pin-btn { width: 100%; padding: 15px; background: var(--accent-blue); color: white; border: none; font-weight: 800; border-radius: 8px; cursor: pointer; }

        /* STICKY HEADER */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            border-bottom: 1px solid var(--border); 
            padding-bottom: 20px;
            /* Sticky Props */
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 100;
            padding-top: 10px;
        }
        
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border); }
        .stat-val { font-size: 2rem; font-weight: 800; color: #fff; font-family: 'Roboto Mono', monospace; }
        .stat-label { color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; color: var(--text-muted); padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.8rem; text-transform: uppercase; }
        td { padding: 15px 10px; border-bottom: 1px solid #222; }
        tr:hover { background: #1a1a1a; }
        .mono { font-family: 'Roboto Mono', monospace; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .del { background: rgba(52, 152, 219, 0.2); color: #3498db; }
        .pick { background: rgba(243, 156, 18, 0.2); color: #f39c12; }
        .money { color: var(--accent-green); font-weight: bold; }
    </style>
</head>
<body>

    <div id="pin-overlay">
        <div class="pin-box">
            <h2>ðŸ“Š Report Access</h2>
            <input type="password" id="pin-input" class="pin-input" placeholder="****" maxlength="4">
            <button class="pin-btn" id="unlock-btn">View Reports</button>
        </div>
    </div>

    <div class="header">
        <h1>ðŸ“œ Sales History</h1>
        <div><a href="manager.html" style="color:#aaa; text-decoration:none;">&larr; Back to Kitchen</a></div>
    </div>

    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-val" id="total-revenue">â‚¹0</div>
            <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-card">
            <div class="stat-val" id="total-orders">0</div>
            <div class="stat-label">Total Orders</div>
        </div>
    </div>

    <div style="overflow-x:auto;">
        <table id="history-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Order ID</th>
                    <th>Type</th>
                    <th>Customer</th>
                    <th>Items</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <tr><td colspan="6" style="text-align:center; padding:30px; color:#555;">Loading records...</td></tr>
            </tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9d8Seuez7ihaTSAuPyoCwqjKIR1-VFKg",
            authDomain: "cafe-orders-1afa1.firebaseapp.com",
            databaseURL: "https://cafe-orders-1afa1-default-rtdb.firebaseio.com",
            projectId: "cafe-orders-1afa1",
            storageBucket: "cafe-orders-1afa1.firebasestorage.app",
            messagingSenderId: "274410745480",
            appId: "1:274410745480:web:9964c3914d512aed8d793d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // PIN LOGIC - UPDATED
        const KITCHEN_PIN = "2024"; 
        
        document.getElementById('unlock-btn').addEventListener('click', () => {
            if(document.getElementById('pin-input').value === KITCHEN_PIN) {
                document.getElementById('pin-overlay').style.display = 'none';
                loadHistory();
            } else {
                alert("Wrong PIN");
            }
        });

        function loadHistory() {
            onValue(ref(db, 'history'), (snapshot) => {
                const data = snapshot.val();
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = "";
                
                if (!data) {
                    tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:30px;'>No history found.</td></tr>";
                    return;
                }

                let totalRev = 0;
                let count = 0;
                const orders = Object.values(data).sort((a,b) => b.completedAt - a.completedAt);

                orders.forEach(order => {
                    count++;
                    const grandTotal = order.financials ? order.financials.grandTotal : 0;
                    totalRev += grandTotal;

                    const dateObj = new Date(order.completedAt || order.timestamp);
                    const dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    
                    let itemsSummary = "Unknown";
                    if(Array.isArray(order.items)) {
                        itemsSummary = order.items.map(i => `${i.qty}x ${i.name}`).join(", ");
                    }

                    const typeClass = order.orderType === 'Delivery' ? 'del' : 'pick';

                    const row = `
                        <tr>
                            <td class="mono" style="color:#aaa;">${dateStr}</td>
                            <td class="mono">#${order.orderId}</td>
                            <td><span class="badge ${typeClass}">${order.orderType}</span></td>
                            <td>
                                <strong>${order.customer.name}</strong><br>
                                <span style="font-size:0.8rem; color:#666;">${order.customer.phone}</span>
                            </td>
                            <td style="max-width:300px; color:#ccc;">${itemsSummary}</td>
                            <td class="mono money">â‚¹${grandTotal}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                document.getElementById('total-revenue').innerText = "â‚¹" + totalRev.toLocaleString();
                document.getElementById('total-orders').innerText = count;
            });
        }
    </script>
</body>
</html>
