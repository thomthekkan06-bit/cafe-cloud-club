<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales Analytics | Cafe Cloud Club</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1115;
            --surface: #181b21;
            --surface-hover: #22262e;
            --border: #2f3542;
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: var(--text-main); 
            margin: 0; padding: 20px;
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        /* --- UTILITIES --- */
        .mono { font-family: 'JetBrains Mono', monospace; }
        .flex { display: flex; align-items: center; }
        .justify-between { justify-content: space-between; }

        /* --- PIN LOCK --- */
        #pin-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 9999; 
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .pin-box { background: var(--surface); padding: 30px; border-radius: 16px; border: 1px solid var(--border); text-align: center; width: 90%; max-width: 320px; }
        .pin-input { 
            background: var(--bg); border: 1px solid var(--border); 
            color: white; font-size: 2rem; text-align: center; 
            letter-spacing: 10px; padding: 10px; border-radius: 8px; width: 100%;
            margin: 20px 0; outline: none; transition: border-color 0.2s;
        }
        .pin-input:focus { border-color: var(--primary); }
        .btn-primary { 
            background: var(--primary); color: white; border: none; padding: 12px 24px; 
            border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%;
        }

        /* --- HEADER & CONTROLS --- */
        .header-section { 
            margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; 
            flex-shrink: 0;
        }
        .page-title { margin: 0; font-size: 1.5rem; font-weight: 800; }
        .back-link { color: var(--text-muted); text-decoration: none; font-size: 0.9rem; transition: color 0.2s; }
        .back-link:hover { color: var(--primary); }

        .controls-row {
            display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;
            background: var(--surface); padding: 15px; border-radius: 12px; border: 1px solid var(--border);
            flex-shrink: 0;
        }
        .search-box { flex: 1; min-width: 250px; }
        .input-field {
            width: 100%; background: var(--bg); border: 1px solid var(--border);
            color: white; padding: 10px 15px; border-radius: 8px; outline: none;
        }
        .date-group { display: flex; gap: 10px; align-items: center; }
        .btn-action {
            background: var(--surface-hover); color: var(--text-main); border: 1px solid var(--border);
            padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;
        }
        .btn-action:hover { background: var(--border); }

        /* --- STATS GRID --- */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px; margin-bottom: 20px;
            flex-shrink: 0;
        }
        .stat-card {
            background: var(--surface); padding: 20px; border-radius: 12px;
            border: 1px solid var(--border); position: relative; overflow: hidden;
        }
        .stat-card::after { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
        .stat-card.green::after { background: var(--success); }
        .stat-card.blue::after { background: var(--primary); }
        .stat-card.orange::after { background: #f59e0b; }
        
        .stat-value { font-size: 2rem; font-weight: 800; font-family: 'JetBrains Mono'; margin-bottom: 5px; }
        .stat-label { color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }

        /* --- TABLE AREA --- */
        .table-container { 
            background: var(--surface); 
            border-radius: 12px; border: 1px solid var(--border);
            flex: 1; overflow-y: auto; overflow-x: auto; position: relative;
        }
        
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        
        th { 
            position: sticky; top: 0; z-index: 10;
            background: var(--surface); box-shadow: 0 1px 0 var(--border);
            text-align: left; padding: 15px 20px; color: var(--text-muted); 
            font-size: 0.75rem; text-transform: uppercase; 
        }
        
        td { padding: 15px 20px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: var(--surface-hover); }

        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .badge-del { background: rgba(59, 130, 246, 0.15); color: var(--primary); }
        .badge-pick { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        .badge-rej { background: rgba(239, 68, 68, 0.15); color: var(--danger); }

        .btn-icon {
            background: transparent; border: none; cursor: pointer; font-size: 1.1rem;
            padding: 8px; border-radius: 6px; transition: background 0.2s;
        }
        .btn-view { color: var(--text-muted); }
        .btn-view:hover { background: rgba(255,255,255,0.1); color: white; }
        .btn-trash { color: var(--danger); opacity: 0.7; }
        .btn-trash:hover { background: rgba(239, 68, 68, 0.1); opacity: 1; }

        /* --- MODAL --- */
        .modal-backdrop {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 500; justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--surface); width: 500px; max-width: 90%;
            border-radius: 16px; border: 1px solid var(--border); 
            position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
            max-height: 85vh; overflow: hidden; padding: 0;
        }

        .modal-top-section { padding: 25px 30px 0 30px; flex-shrink: 0; }
        .modal-header-row { display: flex; justify-content: space-between; margin-bottom: 20px; padding-right: 30px; }
        .customer-info-box { background: #121212; padding: 15px; border-radius: 8px; margin-bottom: 15px; flex-shrink: 0; }
        .modal-scroll-area { padding: 0 30px; overflow-y: auto; flex-grow: 1; min-height: 100px; }
        .modal-bottom-section { padding: 20px 30px 30px 30px; border-top: 1px solid var(--border); background: var(--surface); flex-shrink: 0; z-index: 5; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; }
        .receipt-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #333; }
        .total-row { font-size: 1.2rem; font-weight: 800; border-top: 2px dashed var(--border); padding-top: 15px; margin-top: 15px; }
        .close-modal { position: absolute; top: 20px; right: 25px; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); z-index: 20; }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) {
            body { height: auto; overflow-y: auto; display: block; padding: 15px; padding-bottom: 30px; }
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            .stat-card { padding: 15px; }
            .stat-value { font-size: 1.5rem; }
            .stat-label { font-size: 0.7rem; }
            .table-container { height: auto; overflow-x: auto; margin-bottom: 50px; border: 1px solid var(--border); display: block; }
            .search-box { min-width: 100%; }
            .date-group { width: 100%; }
            .input-field { width: 100%; }
        }

    </style>
</head>
<body>

    <div id="pin-overlay">
        <div class="pin-box">
            <h3 style="margin-top:0;">üîí Admin Access</h3>
            <p style="color:var(--text-muted); font-size:0.9rem;">Enter security PIN to view financials</p>
            <input type="password" id="pin-input" class="pin-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" pattern="[0-9]*" autofocus>
            <button class="btn-primary" id="unlock-btn">UNLOCK DASHBOARD</button>
        </div>
    </div>

    <div class="modal-backdrop" id="details-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div class="modal-top-section">
                <div class="modal-header-row">
                    <div>
                        <h2 style="margin:0;">Receipt</h2>
                        <span class="mono" style="color:var(--text-muted)" id="m-order-id">#000000</span>
                    </div>
                    <div style="text-align:right;">
                        <div id="m-date">Date</div>
                        <div id="m-time" style="color:var(--text-muted); font-size:0.8rem;">Time</div>
                    </div>
                </div>
                <div class="customer-info-box">
                    <div style="color:var(--text-muted); font-size:0.8rem; margin-bottom:5px;">CUSTOMER</div>
                    <strong id="m-customer" style="font-size:1.1rem;">Name</strong><br>
                    <span class="mono" id="m-phone">Phone</span>
                </div>
            </div>
            <div id="m-items-list" class="modal-scroll-area"></div>
            <div class="modal-bottom-section">
                <div class="receipt-row">
                    <span>Subtotal (Kitchen)</span>
                    <span class="mono" id="m-kitchen">‚Çπ0</span>
                </div>
                <div class="receipt-row">
                    <span>Delivery Fee</span>
                    <span class="mono" id="m-fee">‚Çπ0</span>
                </div>
                <div class="receipt-row total-row">
                    <span>TOTAL PAID</span>
                    <span class="mono" style="color:var(--success);" id="m-total">‚Çπ0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="header-section flex justify-between">
        <div>
            <h1 class="page-title">Sales History</h1>
            <p style="color:var(--text-muted); margin:5px 0 0 0; font-size:0.9rem;">Detailed transaction logs and financial breakdown.</p>
        </div>
        <div>
            <a href="manager.html" class="back-link">&larr; Back to Kitchen</a>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card green">
            <div class="stat-value" id="stat-kitchen" style="color:var(--success)">‚Çπ0</div>
            <div class="stat-label">Net Kitchen Revenue</div>
        </div>
        <div class="stat-card orange">
            <div class="stat-value" id="stat-fees" style="color:#f59e0b">‚Çπ0</div>
            <div class="stat-label">Delivery Fees</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-total">‚Çπ0</div>
            <div class="stat-label">Total Cash Collected</div>
        </div>
        <div class="stat-card blue">
            <div class="stat-value" id="stat-count" style="color:var(--primary)">0</div>
            <div class="stat-label">Total Orders</div>
        </div>
    </div>

    <div class="controls-row">
        <div class="search-box">
            <input type="text" id="search-input" class="input-field" placeholder="üîç Search Customer, ID, Phone...">
        </div>
        <div class="date-group">
            <input type="date" id="date-start" class="input-field">
            <span style="color:var(--text-muted)">to</span>
            <input type="date" id="date-end" class="input-field">
        </div>
        <button class="btn-action" onclick="applyFilters()">Filter</button>
        <button class="btn-action" onclick="resetFilters()">Reset</button>
        <button class="btn-action" style="margin-left:auto; border-color:var(--success); color:var(--success);" onclick="exportToCSV()">üì• Export CSV</button>
    </div>

    <div class="table-container">
        <table id="history-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Type</th>
                    <th>Kitchen Rev</th>
                    <th>Total</th>
                    <th style="text-align:right;">Actions</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <tr><td colspan="7" style="text-align:center; padding:40px; color:var(--text-muted);">Locked. Enter PIN to view data.</td></tr>
            </tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, remove, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9d8Seuez7ihaTSAuPyoCwqjKIR1-VFKg",
            authDomain: "cafe-orders-1afa1.firebaseapp.com",
            databaseURL: "https://cafe-orders-1afa1-default-rtdb.firebaseio.com",
            projectId: "cafe-orders-1afa1",
            storageBucket: "cafe-orders-1afa1.firebasestorage.app",
            messagingSenderId: "274410745480",
            appId: "1:274410745480:web:9964c3914d512aed8d793d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // CONFIG
        const ACCESS_PIN = "2024";
        const DELETE_PIN = "2021";
        
        let allOrders = [];

        // --- PIN LOGIC ---
        const pinInput = document.getElementById('pin-input');
        const unlockBtn = document.getElementById('unlock-btn');

        // Allow pressing "Enter" key to unlock
        pinInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                checkPin();
            }
        });

        unlockBtn.addEventListener('click', checkPin);

        function checkPin() {
            if(pinInput.value === ACCESS_PIN) {
                document.getElementById('pin-overlay').style.display = 'none';
                loadHistory(); 
            } else {
                alert("‚ùå Access Denied");
                pinInput.value = '';
                pinInput.focus();
            }
        }

        function loadHistory() {
            document.getElementById('table-body').innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px;">Loading full history...</td></tr>`;
            
            // FETCH EVERYTHING (No Limit)
            const historyQuery = query(ref(db, 'history'));

            onValue(historyQuery, (snapshot) => {
                const data = snapshot.val();
                if (!data) { renderTable([]); return; }
                allOrders = Object.entries(data).map(([key, val]) => ({
                    key: key, ...val
                })).sort((a,b) => (b.completedAt || b.timestamp) - (a.completedAt || a.timestamp));
                renderTable(allOrders);
            });
        }

        window.renderTable = function(ordersData) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = "";
            let sumKitchen = 0; let sumFees = 0; let sumTotal = 0; let count = 0;

            if (ordersData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:40px; color:var(--text-muted);">No records found matching filters.</td></tr>`;
                updateStats(0,0,0,0);
                return;
            }

            ordersData.forEach(order => {
                const isRejected = order.status === 'rejected';
                const fins = order.financials || { grandTotal: 0, deliveryFee: 0 };
                const total = fins.grandTotal || 0;
                const fee = fins.deliveryFee || 0;
                const kitchen = total - fee;

                if(!isRejected) { sumKitchen += kitchen; sumFees += fee; sumTotal += total; count++; }

                const dateObj = new Date(order.completedAt || order.timestamp);
                const dateStr = dateObj.toLocaleDateString('en-IN');
                const timeStr = dateObj.toLocaleTimeString('en-IN', {hour:'2-digit', minute:'2-digit'});
                const rowClass = isRejected ? 'opacity:0.5; text-decoration:line-through;' : '';
                const typeBadge = order.orderType === 'Delivery' ? 'badge-del' : 'badge-pick';
                const typeLabel = isRejected ? 'REJECTED' : order.orderType;
                const badgeClass = isRejected ? 'badge-rej' : typeBadge;

                const row = `
                    <tr style="${rowClass}">
                        <td class="mono" style="font-size:0.85rem; color:var(--text-muted);">
                            ${dateStr}<br>${timeStr}
                        </td>
                        <td class="mono">#${order.orderId}</td>
                        <td>
                            <div style="font-weight:600;">${order.customer.name}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">${order.customer.phone}</div>
                        </td>
                        <td><span class="status-badge ${badgeClass}">${typeLabel}</span></td>
                        <td class="mono" style="color:var(--success);">‚Çπ${kitchen}</td>
                        <td class="mono" style="font-weight:bold;">‚Çπ${total}</td>
                        <td style="text-align:right;">
                            <button class="btn-icon btn-view" onclick='viewDetails("${order.key}")' title="View Receipt">üìÑ</button>
                            <button class="btn-icon btn-trash" onclick="deleteOrder('${order.key}')" title="Delete Record">üóë</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            updateStats(sumKitchen, sumFees, sumTotal, count);
        }

        function updateStats(k, f, t, c) {
            document.getElementById('stat-kitchen').innerText = "‚Çπ" + k.toLocaleString('en-IN');
            document.getElementById('stat-fees').innerText = "‚Çπ" + f.toLocaleString('en-IN');
            document.getElementById('stat-total').innerText = "‚Çπ" + t.toLocaleString('en-IN');
            document.getElementById('stat-count').innerText = c;
        }

        window.applyFilters = function() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const start = document.getElementById('date-start').valueAsDate;
            const end = document.getElementById('date-end').valueAsDate;
            if(end) end.setHours(23,59,59);

            const filtered = allOrders.filter(o => {
                const oDate = new Date(o.completedAt || o.timestamp);
                let dateMatch = true;
                if(start && oDate < start) dateMatch = false;
                if(end && oDate > end) dateMatch = false;
                let searchMatch = true;
                if(search) {
                    const str = `${o.orderId} ${o.customer.name} ${o.customer.phone}`.toLowerCase();
                    if(!str.includes(search)) searchMatch = false;
                }
                return dateMatch && searchMatch;
            });
            renderTable(filtered);
        }

        window.resetFilters = function() {
            document.getElementById('search-input').value = "";
            document.getElementById('date-start').value = "";
            document.getElementById('date-end').value = "";
            renderTable(allOrders);
        }

        window.viewDetails = function(key) {
            const order = allOrders.find(o => o.key === key);
            if(!order) return;
            document.getElementById('m-order-id').innerText = "#" + order.orderId;
            const d = new Date(order.completedAt || order.timestamp);
            document.getElementById('m-date').innerText = d.toLocaleDateString();
            document.getElementById('m-time').innerText = d.toLocaleTimeString();
            document.getElementById('m-customer').innerText = order.customer.name;
            document.getElementById('m-phone').innerText = order.customer.phone;
            const itemsContainer = document.getElementById('m-items-list');
            itemsContainer.innerHTML = "";
            if(order.items) {
                order.items.forEach(i => {
                    itemsContainer.innerHTML += `
                        <div class="receipt-item">
                            <span>${i.qty}x ${i.name}</span>
                            <span>‚Çπ${i.price * i.qty}</span>
                        </div>
                    `;
                });
            }
            const fins = order.financials || {grandTotal:0, deliveryFee:0};
            document.getElementById('m-kitchen').innerText = "‚Çπ" + (fins.grandTotal - (fins.deliveryFee||0));
            document.getElementById('m-fee').innerText = "‚Çπ" + (fins.deliveryFee||0);
            document.getElementById('m-total').innerText = "‚Çπ" + fins.grandTotal;
            document.getElementById('details-modal').style.display = 'flex';
        }

        window.closeModal = function() { document.getElementById('details-modal').style.display = 'none'; }
        window.onclick = function(event) {
            const modal = document.getElementById('details-modal');
            if (event.target == modal) { modal.style.display = "none"; }
        }

        window.deleteOrder = function(key) {
            const password = prompt("‚ö† DELETE CONFIRMATION ‚ö†\nEnter Admin Password:");
            if (password === DELETE_PIN) {
                if(confirm("Are you sure? This cannot be undone.")) {
                    remove(ref(db, 'history/' + key)).then(() => alert("Record deleted.")).catch(err => alert("Error: " + err));
                }
            } else if (password !== null) { alert("‚ùå WRONG PASSWORD."); }
        }

        window.exportToCSV = function() {
            if(allOrders.length === 0) return alert("No data to export.");
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Time,OrderID,Customer,Phone,Type,KitchenRevenue,DeliveryFee,TotalAmount\n";
            allOrders.forEach(o => {
                const d = new Date(o.completedAt || o.timestamp);
                const fins = o.financials || {grandTotal:0, deliveryFee:0};
                const row = [
                    d.toLocaleDateString(), d.toLocaleTimeString(), o.orderId,
                    o.customer.name, o.customer.phone, o.orderType,
                    (fins.grandTotal - (fins.deliveryFee||0)), (fins.deliveryFee||0), fins.grandTotal
                ].join(",");
                csvContent += row + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "cafe_sales_history.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
