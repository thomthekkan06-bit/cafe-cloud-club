<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales History | Cafe Cloud Club</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #27ae60; --red: #e74c3c; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        
        /* --- SECURE PIN MODALS --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        
        .pin-box { background: #1a1a1a; padding: 30px; border-radius: 12px; border: 1px solid #333; text-align: center; width: 90%; max-width: 320px; }
        .pin-input { font-size: 2rem; background: #111; border: 1px solid #444; color: white; text-align: center; padding: 10px; border-radius: 8px; margin-bottom: 20px; width: 100%; letter-spacing: 5px; box-sizing: border-box; outline: none;}
        .pin-input:focus { border-color: var(--accent); }

        .btn { padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 1rem; width: 100%; margin-top: 10px; }
        .btn-green { background: var(--accent); color: white; }
        .btn-red { background: var(--red); color: white; }
        .btn-cancel { background: #333; color: white; }

        /* --- HEADER --- */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .back-link { text-decoration: none; color: #FF4500; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; font-weight: 600; }
        .page-title { margin: 0; font-size: 1.5rem; letter-spacing: -1px; }

        /* --- DASHBOARD STATS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .stat-val { font-size: 1.5rem; font-weight: 800; font-family: 'Roboto Mono', monospace; margin-top: 5px; }
        .stat-label { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        /* --- TABLE --- */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; min-width: 800px; }
        th { text-align: left; color: #888; padding: 12px; border-bottom: 1px solid #333; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; }
        td { padding: 15px 12px; border-bottom: 1px solid #222; vertical-align: top; }
        
        .status-badge { padding: 6px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; display: inline-block; }
        .st-delivered { background: rgba(39, 174, 96, 0.2); color: #27ae60; }
        .st-rejected { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
        .st-done { background: rgba(41, 128, 185, 0.2); color: #3498db; }
        
        .btn-trash { background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.5; transition: 0.2s; color: #666; }
        .btn-trash:hover { opacity: 1; transform: scale(1.1); color: var(--red); }
    </style>
</head>
<body>

    <div id="access-overlay" class="overlay">
        <div class="pin-box">
            <h2 style="margin-top:0">Restricted Access</h2>
            <p style="color:#888; margin-bottom: 20px;">Owner History Log</p>
            <input type="password" id="access-pin" class="pin-input" placeholder="••••" maxlength="4">
            <button class="btn btn-green" onclick="checkAccess()">UNLOCK</button>
            <p id="access-err" style="color:var(--red); display:none; margin-top:10px;">Access Denied</p>
        </div>
    </div>

    <div id="delete-overlay" class="overlay hidden" style="background: rgba(0,0,0,0.9);">
        <div class="pin-box" style="border-color: var(--red);">
            <h2 style="margin-top:0; color: var(--red);">DANGER</h2>
            <p style="color:#ccc; margin-bottom: 20px;">Enter Admin PIN to permanently delete.</p>
            <input type="password" id="delete-pin" class="pin-input" placeholder="••••" maxlength="4">
            <button class="btn btn-red" onclick="confirmDelete()">CONFIRM DELETE</button>
            <button class="btn btn-cancel" onclick="closeDeleteModal()">CANCEL</button>
            <p id="delete-err" style="color:var(--red); display:none; margin-top:10px;">Wrong PIN</p>
        </div>
    </div>

    <div class="header-bar">
        <div style="display:flex; align-items:center; gap:15px;">
            <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Order</a>
            <h1 class="page-title">Sales History</h1>
        </div>
        <div style="text-align:right;">
            <div style="font-size:0.75rem; color:#888;">LOGGED IN</div>
            <div style="font-weight:700; color:#27ae60; font-size:0.9rem;">OWNER</div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Total Orders</div><div class="stat-val" id="total-orders">0</div></div>
        <div class="stat-card"><div class="stat-label">Kitchen Rev</div><div class="stat-val" style="color:#27ae60;" id="total-kitchen">₹0</div></div>
        <div class="stat-card"><div class="stat-label">Fees Collected</div><div class="stat-val" style="color:#f39c12;" id="total-fees">₹0</div></div>
        <div class="stat-card"><div class="stat-label">Net Collected</div><div class="stat-val" style="color:#fff;" id="total-collected">₹0</div></div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Date & Time</th>
                    <th>Status</th>
                    <th>Customer</th>
                    <th>Order Details</th>
                    <th>Financials</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="history-body">
                </tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9d8Seuez7ihaTSAuPyoCwqjKIR1-VFKg",
            authDomain: "cafe-orders-1afa1.firebaseapp.com",
            databaseURL: "https://cafe-orders-1afa1-default-rtdb.firebaseio.com",
            projectId: "cafe-orders-1afa1",
            storageBucket: "cafe-orders-1afa1.firebasestorage.app",
            messagingSenderId: "274410745480",
            appId: "1:274410745480:web:9964c3914d512aed8d793d"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- 1. ACCESS CONTROL ---
        window.checkAccess = () => {
            const pin = document.getElementById('access-pin').value;
            if(pin === "2024") {
                document.getElementById('access-overlay').classList.add('hidden');
                loadHistory(); 
            } else {
                document.getElementById('access-err').style.display = 'block';
                document.getElementById('access-pin').value = '';
            }
        }

        // --- 2. DELETE LOGIC ---
        let itemToDelete = null;

        window.requestDelete = (key) => {
            itemToDelete = key;
            document.getElementById('delete-overlay').classList.remove('hidden');
            document.getElementById('delete-pin').value = ""; 
            document.getElementById('delete-pin').focus();
        }

        window.closeDeleteModal = () => {
            itemToDelete = null;
            document.getElementById('delete-overlay').classList.add('hidden');
            document.getElementById('delete-err').style.display = 'none';
        }

        window.confirmDelete = () => {
            const pin = document.getElementById('delete-pin').value;
            if(pin === "2021") {
                if(itemToDelete) {
                    remove(ref(db, 'history/' + itemToDelete));
                    closeDeleteModal();
                }
            } else {
                document.getElementById('delete-err').style.display = 'block';
                document.getElementById('delete-pin').value = '';
            }
        }

        // --- 3. LOAD DATA ---
        function loadHistory() {
            onValue(ref(db, 'history'), (snapshot) => {
                const tbody = document.getElementById('history-body');
                tbody.innerHTML = "";
                let count = 0, sumKitchen = 0, sumFees = 0, sumCollected = 0;

                const data = snapshot.val();
                if(!data) {
                    tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:30px; color:#666;'>No history records found.</td></tr>";
                    // Update Stats to 0
                    document.getElementById('total-orders').innerText = "0";
                    document.getElementById('total-kitchen').innerText = "₹0";
                    document.getElementById('total-fees').innerText = "₹0";
                    document.getElementById('total-collected').innerText = "₹0";
                    return;
                }

                // Sort: Newest First
                const entries = Object.entries(data).sort((a,b) => b[1].createdAt - a[1].createdAt);

                entries.forEach(([key, order]) => {
                    count++;
                    const fins = order.financials || { grandTotal:0, deliveryFee:0 };
                    const kitchenVal = (fins.grandTotal) - (fins.deliveryFee);
                    
                    sumKitchen += kitchenVal;
                    sumFees += (fins.deliveryFee);
                    sumCollected += (fins.grandTotal);

                    const dateObj = new Date(order.createdAt);
                    const dateStr = dateObj.toLocaleDateString('en-IN', { day:'numeric', month:'short' });
                    const timeStr = dateObj.toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit' });

                    // Item Summary
                    let itemsHtml = "";
                    if(order.items) {
                        itemsHtml = Object.values(order.items).map(i => 
                            `<div style='color:#bbb; font-size:0.85rem'>${i.qty}x ${i.name}</div>`
                        ).join('');
                    }

                    const row = `
                        <tr>
                            <td>
                                <div style="font-weight:700; color:#fff;">${dateStr}</div>
                                <div style="font-size:0.8rem; color:#666;">${timeStr}</div>
                            </td>
                            <td>
                                <span class="status-badge st-${order.status || 'delivered'}">${order.status || 'DONE'}</span>
                            </td>
                            <td>
                                <div style="font-weight:600; font-size:0.9rem">${order.customer?.name || 'Unknown'}</div>
                                <div style="font-size:0.8rem; margin-top:2px; color:#888;">${order.customer?.phone || ''}</div>
                            </td>
                            <td>
                                ${itemsHtml}
                            </td>
                            <td>
                                <div style="color:#888; font-size:0.8rem">Food: ₹${kitchenVal}</div>
                                <div style="color:#f39c12; font-size:0.8rem">Fee: ₹${fins.deliveryFee}</div>
                                <div style="font-weight:700; color:#fff; font-size:1rem; margin-top:4px;">₹${fins.grandTotal}</div>
                            </td>
                            <td>
                                <button class="btn-trash" onclick="requestDelete('${key}')" title="Delete Record">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                // Update Stats
                document.getElementById('total-orders').innerText = count;
                document.getElementById('total-kitchen').innerText = "₹" + sumKitchen.toLocaleString('en-IN');
                document.getElementById('total-fees').innerText = "₹" + sumFees.toLocaleString('en-IN');
                document.getElementById('total-collected').innerText = "₹" + sumCollected.toLocaleString('en-IN');
            });
        }
    </script>
</body>
</html>
