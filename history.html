<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales History | Cafe Cloud Club</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --border: #333;
            --accent-green: #27ae60;
            --accent-blue: #2980b9;
            --accent-orange: #e67e22;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); padding: 20px; }
        
        /* PIN LOCK STYLES */
        #pin-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-box { background: #1e1e1e; padding: 40px; border-radius: 12px; border: 1px solid #333; text-align: center; width: 300px; }
        .pin-input { width: 100%; padding: 15px; margin: 20px 0; background: #121212; border: 1px solid #333; color: white; font-size: 1.5rem; text-align: center; letter-spacing: 5px; border-radius: 8px; }
        .pin-btn { width: 100%; padding: 15px; background: var(--accent-blue); color: white; border: none; font-weight: 800; border-radius: 8px; cursor: pointer; }

        /* HEADER */
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px;
            position: sticky; top: 0; background: var(--bg); z-index: 100; padding-top: 10px;
        }
        
        /* STATS CARDS */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border); }
        .stat-val { font-size: 1.8rem; font-weight: 800; color: #fff; font-family: 'Roboto Mono', monospace; }
        .stat-label { color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        /* TABLE */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; color: var(--text-muted); padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.8rem; text-transform: uppercase; white-space: nowrap; }
        td { padding: 15px 10px; border-bottom: 1px solid #222; vertical-align: middle; }
        tr:hover { background: #1a1a1a; }
        
        .mono { font-family: 'Roboto Mono', monospace; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .del { background: rgba(52, 152, 219, 0.2); color: #3498db; }
        .pick { background: rgba(243, 156, 18, 0.2); color: #f39c12; }
        
        .money-kitchen { color: var(--accent-green); font-weight: bold; }
        .money-fee { color: var(--text-muted); font-size: 0.85rem; }
        .money-total { color: #fff; font-weight: bold; }

        .btn-trash {
            background: rgba(231, 76, 60, 0.1); color: #e74c3c;
            border: 1px solid #e74c3c; padding: 6px 10px; border-radius: 6px;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-trash:hover { background: #e74c3c; color: white; }
    </style>
</head>
<body>

    <div id="pin-overlay">
        <div class="pin-box">
            <h2>üìä Report Access</h2>
            <input type="password" id="pin-input" class="pin-input" placeholder="****" maxlength="4">
            <button class="pin-btn" id="unlock-btn">View Reports</button>
        </div>
    </div>

    <div class="header">
        <h1>üìú Sales History</h1>
        <div><a href="manager.html" style="color:#aaa; text-decoration:none;">&larr; Back to Kitchen</a></div>
    </div>

    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-val" id="total-kitchen" style="color: #27ae60;">‚Çπ0</div>
            <div class="stat-label">Kitchen Revenue (Food Only)</div>
        </div>
        <div class="stat-card">
            <div class="stat-val" id="total-fees" style="color: #e67e22;">‚Çπ0</div>
            <div class="stat-label">Delivery Fees Collected</div>
        </div>
        <div class="stat-card">
            <div class="stat-val" id="total-collected">‚Çπ0</div>
            <div class="stat-label">Total Cash Handled</div>
        </div>
        <div class="stat-card">
            <div class="stat-val" id="total-orders">0</div>
            <div class="stat-label">Total Orders (Last 50)</div>
        </div>
    </div>

    <div style="overflow-x:auto;">
        <table id="history-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>ID / Type</th>
                    <th>Customer</th>
                    <th>Items</th>
                    <th>Kitchen Rev</th>
                    <th>Del. Fee</th>
                    <th>Total Cash</th>
                    <th>Action</th> 
                </tr>
            </thead>
            <tbody id="table-body">
                <tr><td colspan="8" style="text-align:center; padding:30px; color:#555;">Loading records...</td></tr>
            </tbody>
        </table>
    </div>

    <script type="module">
        // FIXED: Added 'query' and 'limitToLast' to imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, remove, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9d8Seuez7ihaTSAuPyoCwqjKIR1-VFKg",
            authDomain: "cafe-orders-1afa1.firebaseapp.com",
            databaseURL: "https://cafe-orders-1afa1-default-rtdb.firebaseio.com",
            projectId: "cafe-orders-1afa1",
            storageBucket: "cafe-orders-1afa1.firebasestorage.app",
            messagingSenderId: "274410745480",
            appId: "1:274410745480:web:9964c3914d512aed8d793d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // PIN LOGIC - FIXED: Standardized to 2025
        const KITCHEN_PIN = "2025";
        
        document.getElementById('unlock-btn').addEventListener('click', () => {
            if(document.getElementById('pin-input').value === KITCHEN_PIN) {
                document.getElementById('pin-overlay').style.display = 'none';
                loadHistory();
            } else {
                alert("Wrong PIN");
            }
        });

        window.deleteHistoryItem = function(key) {
            const password = prompt("‚ö† DELETE CONFIRMATION ‚ö†\nEnter Admin Password to permanently delete this record:");
            // FIXED: Standardized to 2025
            if (password === "2025") {
                if(confirm("Are you sure? This cannot be undone.")) {
                    remove(ref(db, 'history/' + key))
                        .then(() => alert("Record deleted."))
                        .catch(err => alert("Error: " + err));
                }
            } else if (password !== null) {
                alert("‚ùå WRONG PASSWORD. Access Denied.");
            }
        }

        function loadHistory() {
            // FIXED: Added Query to limit to last 50 items to prevent crashing
            const historyQuery = query(ref(db, 'history'), limitToLast(50));
            
            onValue(historyQuery, (snapshot) => {
                const data = snapshot.val();
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = "";
                
                if (!data) {
                    tbody.innerHTML = "<tr><td colspan='8' style='text-align:center; padding:30px;'>No history found.</td></tr>";
                    document.getElementById('total-kitchen').innerText = "‚Çπ0";
                    document.getElementById('total-fees').innerText = "‚Çπ0";
                    document.getElementById('total-collected').innerText = "‚Çπ0";
                    document.getElementById('total-orders').innerText = "0";
                    return;
                }

                let sumKitchen = 0;
                let sumFees = 0;
                let sumCollected = 0;
                let count = 0;
                
                // Sort by completedAt descending (Newest first)
                const orders = Object.entries(data).sort((a,b) => b[1].completedAt - a[1].completedAt);
                
                orders.forEach(([key, order]) => {
                    count++;
                    const fins = order.financials || { grandTotal: 0, deliveryFee: 0 };
                    
                    const totalCash = fins.grandTotal || 0;
                    const fee = fins.deliveryFee || 0;
                    const kitchenRev = totalCash - fee;

                    sumKitchen += kitchenRev;
                    sumFees += fee;
                    sumCollected += totalCash;

                    const dateObj = new Date(order.completedAt || order.timestamp);
                    const dateStr = dateObj.toLocaleDateString();
                    const timeStr = dateObj.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    
                    let itemsSummary = "Unknown";
                    if(Array.isArray(order.items)) {
                        itemsSummary = order.items.map(i => `${i.qty}x ${i.name}`).join(", ");
                    }

                    const typeClass = order.orderType === 'Delivery' ? 'del' : 'pick';
                    const displayFee = fee > 0 ? `+‚Çπ${fee}` : '-';

                    const row = `
                        <tr>
                            <td class="mono" style="color:#aaa; font-size:0.8rem;">
                                ${dateStr}<br>${timeStr}
                            </td>
                            <td>
                                <div class="mono">#${order.orderId}</div>
                                <span class="badge ${typeClass}" style="margin-top:4px; display:inline-block;">${order.orderType}</span>
                            </td>
                            <td>
                                <strong>${order.customer.name}</strong><br>
                                <span style="font-size:0.8rem; color:#666;">${order.customer.phone}</span>
                            </td>
                            <td style="max-width:250px; color:#ccc; font-size:0.85rem;">${itemsSummary}</td>
                            
                            <td class="mono money-kitchen">‚Çπ${kitchenRev}</td>
                            <td class="mono money-fee">${displayFee}</td>
                            <td class="mono money-total">‚Çπ${totalCash}</td>
                            
                            <td>
                                <button class="btn-trash" onclick="deleteHistoryItem('${key}')">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                document.getElementById('total-kitchen').innerText = "‚Çπ" + sumKitchen.toLocaleString();
                document.getElementById('total-fees').innerText = "‚Çπ" + sumFees.toLocaleString();
                document.getElementById('total-collected').innerText = "‚Çπ" + sumCollected.toLocaleString();
                document.getElementById('total-orders').innerText = count;
            });
        }
    </script>
</body>
</html>
