<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales History | Cafe Cloud Club</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #27ae60; --red: #e74c3c; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        
        /* --- SECURE OVERLAYS --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        
        .pin-box { background: #1a1a1a; padding: 30px; border-radius: 12px; border: 1px solid #333; text-align: center; }
        .pin-input { font-size: 2rem; background: #111; border: 1px solid #444; color: white; text-align: center; padding: 10px; border-radius: 8px; margin-bottom: 20px; width: 200px; letter-spacing: 5px; }
        .btn { padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 1rem; }
        .btn-green { background: var(--accent); color: white; }
        .btn-red { background: var(--red); color: white; }

        /* --- TABLE STYLES --- */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        th { text-align: left; color: #888; padding: 10px; border-bottom: 1px solid #333; }
        td { padding: 15px 10px; border-bottom: 1px solid #222; vertical-align: top; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .st-delivered { background: rgba(39, 174, 96, 0.2); color: #27ae60; }
        .st-rejected { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
        
        /* HEADER STATS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .stat-val { font-size: 1.5rem; font-weight: 800; font-family: 'Roboto Mono', monospace; margin-top: 5px; }
        .stat-label { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        .btn-trash { background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.5; transition: 0.2s; }
        .btn-trash:hover { opacity: 1; transform: scale(1.1); }
    </style>
</head>
<body>

    <div id="access-overlay" class="overlay">
        <div class="pin-box">
            <h2 style="margin-top:0">Restricted Access</h2>
            <p style="color:#888; margin-bottom:20px;">Owner History Log</p>
            <input type="password" id="access-pin" class="pin-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
            <br>
            <button class="btn btn-green" onclick="checkAccess()">UNLOCK</button>
            <p id="access-err" style="color:var(--red); display:none; margin-top:10px;">Access Denied</p>
        </div>
    </div>

    <div id="delete-overlay" class="overlay hidden" style="background: rgba(0,0,0,0.9);">
        <div class="pin-box" style="border-color: var(--red);">
            <h2 style="margin-top:0; color: var(--red);">DANGER ZONE</h2>
            <p style="color:#ccc; margin-bottom:20px;">Enter Admin PIN to permanently delete record.</p>
            <input type="password" id="delete-pin" class="pin-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
            <br>
            <div style="display:flex; gap:10px; justify-content: center;">
                <button class="btn" style="background:#333; color:#fff;" onclick="closeDeleteModal()">CANCEL</button>
                <button class="btn btn-red" onclick="confirmDelete()">CONFIRM DELETE</button>
            </div>
            <p id="delete-err" style="color:var(--red); display:none; margin-top:10px;">Wrong PIN</p>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Total Orders</div><div class="stat-val" id="total-orders">0</div></div>
        <div class="stat-card"><div class="stat-label">Kitchen Rev</div><div class="stat-val" style="color:#27ae60;" id="total-kitchen">‚Çπ0</div></div>
        <div class="stat-card"><div class="stat-label">Fees Collected</div><div class="stat-val" style="color:#f39c12;" id="total-fees">‚Çπ0</div></div>
        <div class="stat-card"><div class="stat-label">Net Collected</div><div class="stat-val" style="color:#fff;" id="total-collected">‚Çπ0</div></div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Time/Status</th>
                <th>Customer</th>
                <th>Order Summary</th>
                <th>Kitchen</th>
                <th>Fees</th>
                <th>Total</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="history-body">
            </tbody>
    </table>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9d8Seuez7ihaTSAuPyoCwqjKIR1-VFKg",
            authDomain: "cafe-orders-1afa1.firebaseapp.com",
            databaseURL: "https://cafe-orders-1afa1-default-rtdb.firebaseio.com",
            projectId: "cafe-orders-1afa1",
            storageBucket: "cafe-orders-1afa1.firebasestorage.app",
            messagingSenderId: "274410745480",
            appId: "1:274410745480:web:9964c3914d512aed8d793d"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- 1. ACCESS CONTROL ---
        window.checkAccess = () => {
            const pin = document.getElementById('access-pin').value;
            if(pin === "2024") {
                document.getElementById('access-overlay').classList.add('hidden');
                loadHistory(); // Only load data after PIN is correct
            } else {
                document.getElementById('access-err').style.display = 'block';
            }
        }

        // --- 2. DELETE LOGIC ---
        let itemToDelete = null;

        window.requestDelete = (key) => {
            itemToDelete = key;
            document.getElementById('delete-overlay').classList.remove('hidden');
            document.getElementById('delete-pin').value = ""; // Clear previous
            document.getElementById('delete-pin').focus();
        }

        window.closeDeleteModal = () => {
            itemToDelete = null;
            document.getElementById('delete-overlay').classList.add('hidden');
        }

        window.confirmDelete = () => {
            const pin = document.getElementById('delete-pin').value;
            if(pin === "2021") {
                if(itemToDelete) {
                    remove(ref(db, 'history/' + itemToDelete));
                    closeDeleteModal();
                }
            } else {
                document.getElementById('delete-err').style.display = 'block';
            }
        }

        // --- 3. DATA LOADING ---
        function loadHistory() {
            onValue(ref(db, 'history'), (snapshot) => {
                const tbody = document.getElementById('history-body');
                tbody.innerHTML = "";
                let count = 0, sumKitchen = 0, sumFees = 0, sumCollected = 0;

                const data = snapshot.val();
                if(!data) return;

                // Sort by time (newest first)
                const entries = Object.entries(data).sort((a,b) => b[1].createdAt - a[1].createdAt);

                entries.forEach(([key, order]) => {
                    count++;
                    const fins = order.financials || {};
                    const kitchenVal = (fins.grandTotal || 0) - (fins.deliveryFee || 0);
                    
                    sumKitchen += kitchenVal;
                    sumFees += (fins.deliveryFee || 0);
                    sumCollected += (fins.grandTotal || 0);

                    const date = new Date(order.createdAt).toLocaleString('en-IN', {
                        month:'short', day:'numeric', hour:'numeric', minute:'2-digit'
                    });

                    // Format Items
                    let itemsHtml = "";
                    if(order.items) {
                        itemsHtml = Object.values(order.items).map(i => 
                            `<div>${i.qty}x ${i.name}</div>`
                        ).join('');
                    }

                    const row = `
                        <tr>
                            <td>
                                <div style="font-weight:600">${date}</div>
                                <span class="status-badge st-${order.status || 'delivered'}">${order.status || 'DONE'}</span>
                            </td>
                            <td>${order.customer?.name || 'Unknown'}<br><small>${order.customer?.phone || ''}</small></td>
                            <td style="color:#aaa">${itemsHtml}</td>
                            <td style="font-family:'Roboto Mono'">‚Çπ${kitchenVal}</td>
                            <td style="font-family:'Roboto Mono'">‚Çπ${fins.deliveryFee || 0}</td>
                            <td style="font-family:'Roboto Mono'; font-weight:700; color:#fff;">‚Çπ${fins.grandTotal || 0}</td>
                            <td>
                                <button class="btn-trash" onclick="requestDelete('${key}')">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                // Update Header Stats
                document.getElementById('total-orders').innerText = count;
                document.getElementById('total-kitchen').innerText = "‚Çπ" + sumKitchen;
                document.getElementById('total-fees').innerText = "‚Çπ" + sumFees;
                document.getElementById('total-collected').innerText = "‚Çπ" + sumCollected;
            });
        }
    </script>
</body>
</html>
