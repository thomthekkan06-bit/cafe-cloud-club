<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9d8Seuez7ihaTSAuPyoCwqjKIR1-VFKg",
            authDomain: "cafe-orders-1afa1.firebaseapp.com",
            databaseURL: "https://cafe-orders-1afa1-default-rtdb.firebaseio.com",
            projectId: "cafe-orders-1afa1",
            storageBucket: "cafe-orders-1afa1.firebasestorage.app",
            messagingSenderId: "274410745480",
            appId: "1:274410745480:web:9964c3914d512aed8d793d"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- GLOBAL DATA STORE ---
        // We use a Map to merge 'history' and 'orders' without duplicates
        let allOrdersMap = new Map();

        // --- 1. ACCESS CONTROL ---
        window.checkAccess = () => {
            const pin = document.getElementById('access-pin').value;
            if(pin === "2024") {
                document.getElementById('access-overlay').classList.add('hidden');
                initListeners(); 
            } else {
                document.getElementById('access-err').style.display = 'block';
                document.getElementById('access-pin').value = '';
            }
        }

        // --- 2. DELETE LOGIC ---
        let itemToDeleteKey = null;
        let itemToDeleteSource = null; // We need to know WHICH folder to delete from

        window.requestDelete = (key, source) => {
            itemToDeleteKey = key;
            itemToDeleteSource = source;
            document.getElementById('delete-overlay').classList.remove('hidden');
            document.getElementById('delete-pin').value = ""; 
            document.getElementById('delete-pin').focus();
        }

        window.closeDeleteModal = () => {
            itemToDeleteKey = null;
            itemToDeleteSource = null;
            document.getElementById('delete-overlay').classList.add('hidden');
            document.getElementById('delete-err').style.display = 'none';
        }

        window.confirmDelete = () => {
            const pin = document.getElementById('delete-pin').value;
            if(pin === "2021") {
                if(itemToDeleteKey && itemToDeleteSource) {
                    // Delete from the correct source folder
                    remove(ref(db, itemToDeleteSource + '/' + itemToDeleteKey));
                    closeDeleteModal();
                }
            } else {
                document.getElementById('delete-err').style.display = 'block';
                document.getElementById('delete-pin').value = '';
            }
        }

        // --- 3. DUAL DATA LOADING ---
        function initListeners() {
            // Listener A: The Old 'history' folder
            onValue(ref(db, 'history'), (snapshot) => {
                processSnapshot(snapshot, 'history');
            });

            // Listener B: The New 'orders' folder
            onValue(ref(db, 'orders'), (snapshot) => {
                processSnapshot(snapshot, 'orders');
            });
        }

        function processSnapshot(snapshot, sourceName) {
            const data = snapshot.val();
            
            // If data is null/empty, we must clear entries belonging to this source
            // to handle deletions correctly.
            if (!data) {
                // Remove all entries from this source in our local map
                for (const [key, val] of allOrdersMap) {
                    if (val.source === sourceName) allOrdersMap.delete(key);
                }
            } else {
                Object.entries(data).forEach(([key, order]) => {
                    // Tag the order with its source so we know where to delete it from later
                    order._source = sourceName; 
                    order._key = key;
                    allOrdersMap.set(key, order);
                });
            }
            
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = "";
            let count = 0, sumKitchen = 0, sumFees = 0, sumCollected = 0;

            if (allOrdersMap.size === 0) {
                tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:30px; color:#666;'>No history records found.</td></tr>";
                updateStats(0,0,0,0);
                return;
            }

            // Convert Map to Array and Sort by Date (Newest First)
            const sortedOrders = Array.from(allOrdersMap.values()).sort((a, b) => {
                const timeA = a.timestamp || a.createdAt || 0;
                const timeB = b.timestamp || b.createdAt || 0;
                // Handle complex date objects if necessary
                const dateA = (typeof timeA.toDate === 'function') ? timeA.toDate() : new Date(timeA);
                const dateB = (typeof timeB.toDate === 'function') ? timeB.toDate() : new Date(timeB);
                return dateB - dateA;
            });

            sortedOrders.forEach((order) => {
                count++;
                
                // --- FINANCIAL MATH ---
                const fins = order.financials || {};
                const grandTotal = parseFloat(fins.grandTotal) || 0;
                // Try to find fee in deliveryFee OR packingTotal
                const feeVal = parseFloat(fins.deliveryFee) || parseFloat(fins.packingTotal) || 0;
                const kitchenVal = grandTotal - feeVal;
                
                sumKitchen += kitchenVal;
                sumFees += feeVal;
                sumCollected += grandTotal;

                // --- DATE PARSING ---
                let dateObj;
                let rawTime = order.timestamp || order.createdAt;
                
                if (rawTime) {
                    if (typeof rawTime.toDate === 'function') {
                        dateObj = rawTime.toDate(); 
                    } else {
                        dateObj = new Date(rawTime);
                    }
                } else {
                    dateObj = new Date();
                }

                // Check for Invalid Date
                let dateStr = "Unknown Date";
                let timeStr = "--:--";
                if (!isNaN(dateObj.getTime())) {
                    dateStr = dateObj.toLocaleDateString('en-IN', { day:'numeric', month:'short' });
                    timeStr = dateObj.toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit' });
                }

                // --- ITEMS PARSING ---
                let itemsHtml = "";
                if(order.items) {
                    const itemList = Array.isArray(order.items) ? order.items : Object.values(order.items);
                    itemsHtml = itemList.map(i => 
                        `<div style='color:#bbb; font-size:0.85rem'>${i.qty}x ${i.name}</div>`
                    ).join('');
                } else {
                    itemsHtml = "<span style='color:#555'>No items data</span>";
                }

                // --- CUSTOMER PARSING ---
                const custName = order.customer?.name || "Unknown";
                const custPhone = order.customer?.phone || "";

                const row = `
                    <tr>
                        <td>
                            <div style="font-weight:700; color:#fff;">${dateStr}</div>
                            <div style="font-size:0.8rem; color:#666;">${timeStr}</div>
                            <div style="font-size:0.7rem; color:#444; margin-top:4px;">${order._source.toUpperCase()}</div>
                        </td>
                        <td>
                            <span class="status-badge st-${order.status || 'delivered'}">${order.status || 'DONE'}</span>
                        </td>
                        <td>
                            <div style="font-weight:600; font-size:0.9rem">${custName}</div>
                            <div style="font-size:0.8rem; margin-top:2px; color:#888;">${custPhone}</div>
                        </td>
                        <td>
                            ${itemsHtml}
                        </td>
                        <td>
                            <div style="color:#888; font-size:0.8rem">Food: ₹${kitchenVal}</div>
                            <div style="color:#f39c12; font-size:0.8rem">Fee/Pack: ₹${feeVal}</div>
                            <div style="font-weight:700; color:#fff; font-size:1rem; margin-top:4px;">₹${grandTotal}</div>
                        </td>
                        <td>
                            <button class="btn-trash" onclick="requestDelete('${order._key}', '${order._source}')" title="Delete Record">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            updateStats(count, sumKitchen, sumFees, sumCollected);
        }

        function updateStats(count, kitchen, fees, collected) {
            document.getElementById('total-orders').innerText = count;
            document.getElementById('total-kitchen').innerText = "₹" + kitchen.toLocaleString('en-IN');
            document.getElementById('total-fees').innerText = "₹" + fees.toLocaleString('en-IN');
            document.getElementById('total-collected').innerText = "₹" + collected.toLocaleString('en-IN');
        }
    </script>
