const sheetName = 'Orders';

function doPost(e) {
  const lock = LockService.getScriptLock();
  lock.tryLock(10000);

  try {
    const doc = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = doc.getSheetByName(sheetName);
    
    // Check if we are UPDATING an order or CREATING a new one
    const action = e.parameter.action;

    if (action === 'update') {
      // --- UPDATE LOGIC (Staff clicked Accept/Ready) ---
      const orderId = e.parameter.orderId;
      const newStatus = e.parameter.status;
      
      const data = sheet.getDataRange().getValues();
      // Loop through rows to find the matching Order ID
      for (let i = 1; i < data.length; i++) {
        // data[i][1] is Column B (OrderID)
        if (data[i][1] == orderId) { 
          // Column I (Index 9) is the "Status" column.
          // Note: Row number is i + 1. Column number is 9 (I).
          sheet.getRange(i + 1, 9).setValue(newStatus); 
          return ContentService.createTextOutput(JSON.stringify({ 'result': 'updated', 'id': orderId }))
            .setMimeType(ContentService.MimeType.JSON);
        }
      }
      return ContentService.createTextOutput(JSON.stringify({ 'result': 'error', 'message': 'Order ID not found' }))
        .setMimeType(ContentService.MimeType.JSON);

    } else {
      // --- CREATE LOGIC (New Order from Website) ---
      const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
      const nextRow = sheet.getLastRow() + 1;

      const newRow = headers.map(function(header) {
        if (header === 'Date') return new Date();
        if (header === 'Status') return 'New'; // Default status
        return e.parameter[header];
      });

      sheet.getRange(nextRow, 1, 1, newRow.length).setValues([newRow]);
      return ContentService.createTextOutput(JSON.stringify({ 'result': 'success', 'row': nextRow }))
        .setMimeType(ContentService.MimeType.JSON);
    }

  } catch (e) {
    return ContentService.createTextOutput(JSON.stringify({ 'result': 'error', 'error': e.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

function doGet(e){
  const doc = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = doc.getSheetByName(sheetName);
  const data = sheet.getDataRange().getValues();
  return ContentService.createTextOutput(JSON.stringify(data))
      .setMimeType(ContentService.MimeType.JSON);
}
