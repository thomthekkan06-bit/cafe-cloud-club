<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbx_6dCuYMLPAQq8j9AsMHzjIkcugifCOfCYQnI49eVUughBQlBYmdIY6LPf5PQ7EDmv/exec';
    
    let isSystemStarted = false;
    let knownOrderIds = new Set();

    // CLOCK
    function updateClock() {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-US', { hour12: true, hour: 'numeric', minute: 'numeric' });
    }
    setInterval(updateClock, 1000);
    updateClock();

    // START SYSTEM
    function startSystem() {
        document.getElementById('start-overlay').style.display = 'none';
        document.getElementById('loading').innerText = "Connecting...";
        
        // Unlock audio context
        const audio = document.getElementById('notification-sound');
        audio.volume = 1.0;
        audio.play().then(() => {
            audio.pause();
            audio.currentTime = 0;
        }).catch(e => console.log("Audio permission issue:", e));

        isSystemStarted = true;
        loadTickets(); 
        setInterval(loadTickets, 10000); // Poll every 10s
    }

    function playSound() {
        const audio = document.getElementById('notification-sound');
        audio.currentTime = 0;
        audio.play().catch(e => console.error("Sound failed:", e));
    }

    // SECURITY: Prevent script injection (XSS)
    // This cleans the data coming from the sheet so it can't break your HTML
    function escapeHtml(text) {
        if (!text) return '';
        return text.toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function loadTickets() {
        if(!isSystemStarted) return;

        fetch(scriptURL)
        .then(res => res.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            const container = document.getElementById('orders-container');
            
            // 1. FILTER: Last 12h
            const now = new Date();
            const twelveHoursAgo = new Date(now.getTime() - (12 * 60 * 60 * 1000));
            
            // 2. REVERSE: Newest first so they appear at top
            const rows = data.slice(1).reverse(); 

            let activeOrderIds = new Set();
            let hasNewOrder = false;

            // Check if no active orders
            const hasActiveOrders = rows.some(row => {
                const d = new Date(row[0]);
                const s = row[9] ? row[9].toString().trim() : 'New';
                return d > twelveHoursAgo && s !== 'Ready';
            });

            if (!hasActiveOrders) {
                container.innerHTML = '<div style="color:#444; text-align:center; padding:40px; grid-column:1/-1;">NO ACTIVE ORDERS</div>';
                return;
            }

            // Remove "No Active Orders" msg if real orders exist
            if (container.innerText.includes("NO ACTIVE ORDERS")) {
                container.innerHTML = '';
            }

            rows.forEach(row => {
                // 0:Date, 1:ID, ... 
                const orderDate = new Date(row[0]);
                const orderId = row[1];
                const rawName = row[2];
                const phone = row[3];
                const items = row[4];
                const type = row[6];
                const note = row[8];
                const status = row[9] ? row[9].toString().trim() : 'New';

                // Skip old or completed
                if (orderDate < twelveHoursAgo || status === 'Ready') return;

                activeOrderIds.add(orderId);

                // --- CRITICAL FIX: MISSING NAME HANDLER ---
                // If name is blank, use "Guest"
                const customerName = (rawName && rawName.toString().trim() !== "") 
                                     ? escapeHtml(rawName) 
                                     : "Guest";

                // --- CRITICAL FIX: DOM DIFFING ---
                // We check if the card exists. If yes, we leave it alone. If no, we create it.
                // This stops the flashing and phantom clicks.
                let card = document.getElementById(`card-${orderId}`);

                // 1. CREATE CARD IF IT DOESN'T EXIST
                if (!card) {
                    if (status === 'New') hasNewOrder = true;

                    const timeString = orderDate.toLocaleTimeString('en-IN', { hour: 'numeric', minute: 'numeric', hour12: true });
                    const itemsHtml = escapeHtml(items).replace(/, /g, '<br>');
                    const typeDisplay = escapeHtml(type).toUpperCase();
                    const noteHtml = note && note !== '-' ? `<div class="note-box">NOTE: ${escapeHtml(note)}</div>` : '';
                    
                    // Button logic
                    let btnHtml = '';
                    let statusClass = 'status-new';
                    let statusLabel = '';

                    if (status === 'Accepted') {
                        statusClass = 'status-accepted';
                        statusLabel = '<span style="color:#f1c40f; font-size:0.8rem; float:right;">COOKING...</span>';
                        btnHtml = `<button class="action-btn btn-ready" onclick="updateStatus('${orderId}', 'Ready', this)">Mark Ready (Done)</button>`;
                    } else {
                        btnHtml = `<button class="action-btn btn-accept" onclick="updateStatus('${orderId}', 'Accepted', this)">Accept Order</button>`;
                    }

                    const newCardHtml = `
                        <div class="ticket ${statusClass}" id="card-${orderId}">
                            <div class="ticket-header">
                                <span>#${orderId}</span>
                                <span>${typeDisplay}</span>
                            </div>
                            <div class="ticket-meta">
                                ðŸ•’ ${timeString} ${statusLabel}<br>
                                ðŸ‘¤ ${customerName} (${escapeHtml(phone)})
                            </div>
                            <div class="ticket-items">
                                ${itemsHtml}
                            </div>
                            ${noteHtml}
                            <div id="btn-container-${orderId}">
                                ${btnHtml}
                            </div>
                        </div>
                    `;
                    // Add to container
                    container.insertAdjacentHTML('beforeend', newCardHtml);
                
                // 2. UPDATE CARD STATUS IF CHANGED EXTERNALLY
                } else {
                    const currentClass = card.classList.contains('status-accepted') ? 'Accepted' : 'New';
                    if (status !== currentClass && status === 'Accepted') {
                        card.classList.remove('status-new');
                        card.classList.add('status-accepted');
                        const btnContainer = document.getElementById(`btn-container-${orderId}`);
                        btnContainer.innerHTML = `<button class="action-btn btn-ready" onclick="updateStatus('${orderId}', 'Ready', this)">Mark Ready (Done)</button>`;
                    }
                }
            });

            // Cleanup: Remove cards that are no longer in the active list (e.g. marked ready on another device)
            const allCards = document.querySelectorAll('.ticket');
            allCards.forEach(card => {
                const id = card.id.replace('card-', '');
                // Check if this ID is in the current batch of active orders
                if (!activeOrderIds.has(parseInt(id)) && !activeOrderIds.has(id)) {
                    card.remove();
                }
            });

            if (hasNewOrder && !knownOrderIds.has([...activeOrderIds][0])) { 
                 playSound();
            }
            knownOrderIds = activeOrderIds;
        })
        .catch(err => {
            console.error(err);
        });
    }

    function updateStatus(orderId, newStatus, btnElement) {
        const card = document.getElementById(`card-${orderId}`);
        const originalBtnText = btnElement.innerText;
        
        // VISUAL UPDATE (Optimistic)
        btnElement.innerText = "SAVING...";
        btnElement.style.opacity = "0.7";
        btnElement.disabled = true;

        const formData = new FormData();
        formData.append('action', 'update');
        formData.append('orderId', orderId);
        formData.append('status', newStatus);

        fetch(scriptURL, { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => {
            if(data.result === 'updated') {
                if (newStatus === 'Accepted') {
                    card.classList.remove('status-new');
                    card.classList.add('status-accepted');
                    // Replace button
                    const btnContainer = document.getElementById(`btn-container-${orderId}`);
                    btnContainer.innerHTML = `<button class="action-btn btn-ready" onclick="updateStatus('${orderId}', 'Ready', this)">Mark Ready (Done)</button>`;
                } else if (newStatus === 'Ready') {
                    card.style.transition = "all 0.5s";
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.9)';
                    setTimeout(() => card.remove(), 500);
                }
            } else {
                throw new Error("Sync failed");
            }
        })
        .catch(err => {
            console.error(err);
            alert("Connection Lost! Status NOT saved.");
            // --- CRITICAL FIX: ROLLBACK ---
            // If internet fails, we reset the button so the chef can try again
            btnElement.innerText = originalBtnText;
            btnElement.style.opacity = "1";
            btnElement.disabled = false;
        });
    }
</script>
