<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KITCHEN DISPLAY | Caf√© Cloud Club</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- KITCHEN MODE STYLES --- */
        :root {
            --bg: #000000;
            --card-bg: #1a1a1a;
            --text: #ffffff;
            --accent: #FF4500; /* Brand Orange */
            --green: #2ecc71;
            --border: #333;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Roboto Mono', monospace;
            margin: 0;
            padding: 10px;
        }

        /* Top Status Bar */
        .kitchen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px; height: 12px;
            border-radius: 50%;
            background: #555;
            margin-right: 5px;
        }
        .status-indicator.online { background: var(--green); box-shadow: 0 0 10px var(--green); }
        .status-indicator.offline { background: red; }

        /* The Grid Layout */
        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        /* Individual Ticket Card */
        .ticket {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-top: 6px solid #555; /* Default color */
            border-radius: 6px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            animation: popIn 0.3s ease-out;
        }

        /* Color Code by Order Type */
        .ticket.type-Delivery { border-top-color: var(--accent); } /* Orange for Delivery */
        .ticket.type-Pickup { border-top-color: var(--green); } /* Green for Pickup */

        .ticket-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed #444;
            padding-bottom: 8px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #aaa;
        }

        .ticket-id { font-size: 1.4rem; font-weight: bold; color: white; }
        
        .customer-details { margin-bottom: 15px; font-size: 0.95rem; }
        .customer-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 2px; }
        .customer-address { font-size: 0.8rem; color: #888; margin-top: 4px; }
        .note-box { 
            background: #4a1c1c; 
            color: #ffaaaa; 
            padding: 5px; 
            margin-top: 5px; 
            border-radius: 4px; 
            font-weight: bold; 
            font-size: 0.85rem;
        }

        .item-list { flex-grow: 1; }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #333;
            font-size: 1.05rem;
        }
        .order-item:last-child { border-bottom: none; }
        .qty-badge {
            background: #333;
            color: var(--accent);
            padding: 0 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-right: 8px;
        }

        /* Action Button */
        .done-btn {
            margin-top: 15px;
            padding: 12px;
            background: #333;
            color: white;
            border: 1px solid #555;
            width: 100%;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
        }
        .done-btn:hover { background: #444; }
        
        /* Completed State (Dimmed) */
        .ticket.completed { opacity: 0.3; order: 100; /* Push to end */ }

        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div class="kitchen-header">
        <div>
            <h1 style="margin:0; font-size:1.5rem;">KITCHEN DISPLAY</h1>
            <div style="font-size:0.8rem; color:#666;">Refreshes every 10s</div>
        </div>
        <div>
            <span class="status-indicator" id="connection-dot"></span>
            <span id="connection-text" style="font-size:0.8rem;">Connecting...</span>
        </div>
    </div>

    <div id="tickets-container" class="orders-grid">
        <div style="color: #666; grid-column: 1/-1; text-align: center; margin-top: 50px;">
            Waiting for order data...
        </div>
    </div>

    <audio id="alert-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.m4a"></audio>

<script>
    // URL Updated as per request
    const API_URL = "https://script.google.com/macros/s/AKfycbyXl0eoAoUyn3GgxrDpoE4glfpLNKVKAZ3yNSH8wVw5-vSLSjqpaehqWgmRIlrm_Bgngg/exec";

    let knownOrderIDs = []; // Track IDs to play sound only for new ones
    let firstLoad = true;

    async function fetchOrders() {
        const container = document.getElementById('tickets-container');
        const statusDot = document.getElementById('connection-dot');
        const statusText = document.getElementById('connection-text');

        try {
            const response = await fetch(API_URL);
            const data = await response.json();

            // Connection Success
            statusDot.className = "status-indicator online";
            statusText.innerText = "Live";

            renderTickets(data.orders);

        } catch (error) {
            console.error("Fetch Error:", error);
            statusDot.className = "status-indicator offline";
            statusText.innerText = "Error (Retrying...)";
        }
    }

    function renderTickets(orders) {
        const container = document.getElementById('tickets-container');
        
        if (!orders || orders.length === 0) {
            container.innerHTML = '<div style="color:#444; text-align:center;">No recent orders.</div>';
            return;
        }

        // 1. Play Sound for New Orders
        const incomingIDs = orders.map(o => o.OrderID); // Get all IDs from server
        let hasNew = false;
        
        if (!firstLoad) {
            // Check if any incoming ID is NOT in our known list
            hasNew = incomingIDs.some(id => !knownOrderIDs.includes(id));
        }
        
        if (hasNew) {
            const audio = document.getElementById('alert-sound');
            audio.play().catch(e => console.log("Click page to enable audio"));
        }

        // Update known list
        knownOrderIDs = incomingIDs;
        firstLoad = false;

        // 2. Clear current list (Simple refresh method)
        container.innerHTML = '';

        // 3. Loop through orders and create cards
        orders.forEach(order => {
            // Check Local Storage to see if we marked this as done
            const isDone = localStorage.getItem(`done_${order.OrderID}`);

            // Create Card HTML
            const card = document.createElement('div');
            card.className = `ticket type-${order.Type} ${isDone ? 'completed' : ''}`;
            card.id = `ticket-${order.OrderID}`;

            // Format Items (Assumes string like "Burger (1), Fries (2)")
            let itemsHtml = '';
            if (order.Items) {
                // Remove trailing comma
                const cleanItems = order.Items.replace(/,\s*$/, "");
                const itemArray = cleanItems.split(', ');
                
                itemArray.forEach(itm => {
                    // Try to split quantity from name "Burger (1)"
                    const match = itm.match(/(.*)\s\((\d+)\)/);
                    if (match) {
                        itemsHtml += `<div class="order-item"><span class="qty-badge">${match[2]}</span> <span>${match[1]}</span></div>`;
                    } else {
                        itemsHtml += `<div class="order-item"><span>${itm}</span></div>`;
                    }
                });
            }

            // Parse Time from Timestamp
            let timeDisplay = order.Date;
            try {
                // If it's a full date string, just grab the time part if possible
                if(timeDisplay.includes(',')) timeDisplay = timeDisplay.split(',')[1];
            } catch(e) {}

            card.innerHTML = `
                <div class="ticket-header">
                    <span class="ticket-id">#${order.OrderID}</span>
                    <span>${timeDisplay}</span>
                </div>
                <div class="customer-details">
                    <div style="color: ${order.Type === 'Delivery' ? 'var(--accent)' : 'var(--green)'}; font-weight:bold; text-transform:uppercase; margin-bottom:5px;">${order.Type}</div>
                    <div class="customer-name">${order.CustomerName}</div>
                    <div>${order.Phone}</div>
                    ${order.Address && order.Type === 'Delivery' ? `<div class="customer-address">${order.Address}</div>` : ''}
                    ${order.Note && order.Note !== '-' ? `<div class="note-box">NOTE: ${order.Note}</div>` : ''}
                </div>
                <div class="item-list">
                    ${itemsHtml}
                </div>
                <button class="done-btn" onclick="toggleDone('${order.OrderID}')">
                    ${isDone ? 'COMPLETED' : 'MARK DONE'}
                </button>
            `;

            container.appendChild(card);
        });
    }

    function toggleDone(orderID) {
        const card = document.getElementById(`ticket-${orderID}`);
        const btn = card.querySelector('.done-btn');
        const key = `done_${orderID}`;

        if (localStorage.getItem(key)) {
            // Undo
            localStorage.removeItem(key);
            card.classList.remove('completed');
            btn.innerText = "MARK DONE";
        } else {
            // Mark Done
            localStorage.setItem(key, 'true');
            card.classList.add('completed');
            btn.innerText = "COMPLETED";
        }
    }

    // Start Polling
    fetchOrders(); // Run immediately
    setInterval(fetchOrders, 10000); // Run every 10 seconds

</script>
</body>
</html>