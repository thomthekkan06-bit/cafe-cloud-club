<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Captain | Cloud Club</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="kitchen-icon.jpg" type="image/jpeg">

    <style>
        :root {
            --bg: #000000;
            --card: #1a1a1a;
            --text: #ffffff;
            --accent: #FF4500; 
            --map-blue: #3498db;
            --call-green: #2ecc71;
            --border: #333;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 15px;
            padding-bottom: 80px;
        }

        /* HEADER */
        .app-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border);
        }
        .brand { display: flex; align-items: center; gap: 12px; }
        .logo { width: 45px; height: 45px; border-radius: 10px; border: 2px solid #333; }
        .title { font-weight: 800; font-size: 1.4rem; letter-spacing: -0.5px; }
        .subtitle { color: #888; font-size: 0.8rem; font-weight: 500; text-transform: uppercase; }
        .refresh-btn {
            background: #333; color: white; border: none; width: 40px; height: 40px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer;
        }

        /* CARDS */
        .order-card {
            background: var(--card); border-radius: 16px; margin-bottom: 20px;
            overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid var(--border);
            animation: slideIn 0.3s ease-out;
        }

        .card-top {
            padding: 15px; background: linear-gradient(180deg, rgba(255, 69, 0, 0.1) 0%, rgba(0,0,0,0) 100%);
            border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;
        }
        .order-id { font-size: 1.2rem; font-weight: 800; color: #fff; }
        .time-badge { font-size: 0.8rem; background: #333; padding: 4px 8px; border-radius: 6px; color: #aaa; }

        .card-body { padding: 20px 15px; }
        /* Customer Info */
        .customer-row { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 15px; }
        .icon-box { width: 35px; height: 35px; background: #252525; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; color: #888; flex-shrink: 0;
        }
        .info-text { flex: 1; }
        .c-name { font-size: 1.1rem; font-weight: 700; margin-bottom: 2px; }
        .c-addr { font-size: 0.95rem; color: #bbb; line-height: 1.4; }
        .c-note { margin-top: 8px; font-size: 0.85rem; color: #e74c3c; background: rgba(231, 76, 60, 0.1); padding: 8px; border-radius: 6px; }

        /* Action Grid */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .act-btn {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            padding: 12px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 0.9rem;
            border: 1px solid transparent; transition: transform 0.1s;
        }
        .btn-map { background: rgba(52, 152, 219, 0.15); color: var(--map-blue); border-color: rgba(52, 152, 219, 0.3); }
        .btn-call { background: rgba(46, 204, 113, 0.15); color: var(--call-green); border-color: rgba(46, 204, 113, 0.3); }

        /* Bill Section */
        .bill-area {
            background: #222; border-top: 1px dashed #444; padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .bill-label { color: #888; font-size: 0.9rem; text-transform: uppercase; font-weight: 600; }
        .bill-amount { color: var(--text); font-size: 1.5rem; font-weight: 800; }

        /* Finish Button */
        .finish-btn {
            width: 100%; border: none; background: var(--call-green); color: black;
            padding: 15px; font-size: 1rem; font-weight: 700; text-transform: uppercase;
            cursor: pointer; transition: 0.2s;
        }

        /* STATUS DISPLAY */
        .status-pill {
            background: #444; color: #fff; padding: 4px 8px; border-radius: 4px; font-weight: 700; font-size: 0.8rem;
            text-align: center; margin-top: 10px;
        }
        .status-pill.out-for-delivery { background: var(--accent); }
        .status-pill.delivered { background: var(--call-green); color: black; }

        /* EMPTY STATE */
        .empty-state { text-align: center; padding: 60px 20px; color: #444; }
        .empty-icon { font-size: 4rem; margin-bottom: 15px; opacity: 0.3; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="brand">
            <img src="kitchen-icon.jpg" class="logo" alt="Logo">
            <div>
                <div class="title">Captain (Delivery)</div>
                <div class="subtitle">All Pending Orders</div>
            </div>
        </div>
        <button class="refresh-btn" onclick="fetchOrders(true)"><i class="fas fa-sync-alt"></i></button>
    </div>

    <div id="orders-container">
        </div>

    <audio id="alert-sound" src="bell.mp3"></audio>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyXl0eoAoUyn3GgxrDpoE4glfpLNKVKAZ3yNSH8wVw5-vSLSjqpaehqWgmRIlrm_Bgngg/exec";
    const STATUS_API_URL = "https://script.google.com/macros/s/AKfycbwv6bdmYHU6uNqt-NS88cIfz_xAhWmxa72J_XHXR5wtrjs63fh2-ZIJVo7vetkkPfgt4w/exec";

    let knownOrderIDs = [];
    let firstLoad = true;
    
    // --- CENTRAL STATUS UPDATER (Called by buttons) ---
    async function updateCentralStatus(orderId, newStatus) {
        if (!confirm(`Confirm order ${orderId} status change to: ${newStatus}?`)) return;

        const formData = new FormData();
        formData.append('orderId', orderId);
        formData.append('newStatus', newStatus);

        try {
            const response = await fetch(STATUS_API_URL, { 
                method: 'POST', 
                body: formData, 
                mode: 'no-cors' 
            });
            // Clear local state immediately for instant feedback
            // (We will use a temporary local flag to hide the order until the next refresh)
            localStorage.setItem(`del_temp_${orderId}`, 'true');
            fetchOrders(); 

        } catch (e) {
            alert("Error updating status. Check API link or network.");
            console.error("Status Update Failed:", e);
        }
    }

    async function fetchOrders(manual = false) {
        if (manual) {
            document.querySelector('.refresh-btn i').classList.add('spin');
        }

        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            renderOrders(data.orders);
        } catch (error) {
            console.log("Connection Error:", error);
        } finally {
            if (manual) document.querySelector('.refresh-btn i').style.animation = "none";
        }
    }

    function renderOrders(orders) {
        const container = document.getElementById('orders-container');
        
        // Filter: 1. ONLY Delivery orders AND 2. Status is NOT 'Delivered'
        const ordersToShow = orders.filter(order => {
            if (order.Type !== 'Delivery') return false;
            
            // Central Status Check: If manager set status to Delivered, hide it.
            if (order.Status && order.Status.toLowerCase().includes('delivered')) return false;

            // Temporary Local Check: Hide if the driver just clicked 'Mark Delivered'
            if (localStorage.getItem(`del_temp_${order.OrderID}`)) return false;

            return true;
        });

        if (ordersToShow.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-check-circle empty-icon"></i>
                    <p>No pending deliveries.</p>
                </div>`;
            return;
        }

        // Sound Logic (plays for any new delivery order)
        const incomingIDs = ordersToShow.map(o => o.OrderID);
        let hasNew = false;
        if (!firstLoad) hasNew = incomingIDs.some(id => !knownOrderIDs.includes(id));
        if (hasNew) {
             const audio = document.getElementById('alert-sound');
             audio.currentTime = 0;
             audio.play().catch(()=>{});
        }
        knownOrderIDs = incomingIDs;
        firstLoad = false;

        container.innerHTML = '';

        ordersToShow.forEach(order => {
            const card = document.createElement('div');
            card.className = 'order-card';
            card.id = `card-${order.OrderID}`;

            // Clean Note Logic
            let rawUserNote = order.Note || '';
            rawUserNote = rawUserNote.replace(/\[PACKING:\s*\d+\]/g, '').replace(/\[OFFER:\s*.*?\]/g, '').replace(/\[Assigned:\s*.*?\]/g, '').trim(); 
            
            // Format Status Pill
            let statusClass = 'out-for-delivery'; 
            let statusText = 'Pending Pickup';
            if (order.Status && order.Status.toLowerCase().includes('delivery')) {
                statusText = 'Out for Delivery';
                statusClass = 'out-for-delivery';
            }


            // Generate Map Link 
            const mapQuery = encodeURIComponent(order.Address);
            const mapLink = `http://maps.google.com/?q=${mapQuery}`;

            card.innerHTML = `
                <div class="card-top">
                    <div class="order-id">#${order.OrderID}</div>
                    <div class="time-badge">${order.Date.split(',')[1] || 'Today'}</div>
                </div>
                <div class="card-body">
                    <div class="customer-row">
                        <div class="icon-box"><i class="fas fa-user"></i></div>
                        <div class="info-text">
                            <div class="c-name">${order.CustomerName}</div>
                        </div>
                    </div>
                    
                    <div class="customer-row">
                        <div class="icon-box"><i class="fas fa-map-marker-alt"></i></div>
                        <div class="info-text">
                            <div class="c-addr">${order.Address}</div>
                            ${rawUserNote && rawUserNote !== '-' ? `<div class="c-note"><i class="fas fa-exclamation-triangle"></i> ${rawUserNote}</div>` : ''}
                        </div>
                    </div>

                    <div class="action-grid">
                        <a href="tel:${order.Phone}" class="act-btn btn-call">
                            <i class="fas fa-phone-alt"></i> Call
                        </a>
                        <a href="${mapLink}" target="_blank" class="act-btn btn-map">
                            <i class="fas fa-location-arrow"></i> Navigate
                        </a>
                    </div>
                    <div class="status-pill ${statusClass}">${statusText}</div>
                </div>
                <div class="bill-area">
                    <div class="bill-label">Collect Cash</div>
                    <div class="bill-amount">â‚¹${order.Total}</div>
                </div>
                <button class="finish-btn" onclick="updateCentralStatus('${order.OrderID}', 'Delivered')">
                    Mark Delivered <i class="fas fa-check"></i>
                </button>
            `;
            container.appendChild(card);
        });
    }
</script>
<style>
@keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</body>
</html>
