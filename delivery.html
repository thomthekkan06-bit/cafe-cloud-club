<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Delivery Partner | Caf√© Cloud Club</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background: #121212; 
            color: #fff; 
            margin: 0; 
        }

        /* --- LOGIN SCREEN --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .login-inp { padding: 12px; margin: 5px; width: 250px; background: #222; border: 1px solid #444; color: white; border-radius: 6px; }
        
        /* --- STICKY HEADER --- */
        .sticky-wrapper {
            position: sticky; top: 0; z-index: 1000;
            background: #121212; border-bottom: 1px solid #333;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5); padding: 15px;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .logo { font-weight: 900; color: #3498db; letter-spacing: -0.5px; font-size: 1.2rem; }
        
        /* --- ORDERS --- */
        #orders-list { padding: 15px; padding-bottom: 80px; }
        .d-card {
            background: #1e1e1e; border: 1px solid #333; border-radius: 12px;
            padding: 15px; margin-bottom: 20px; position: relative;
        }
        .d-status {
            position: absolute; top: 15px; right: 15px;
            font-size: 0.75rem; font-weight: 800; color: #f39c12;
            background: rgba(243, 156, 18, 0.15); padding: 4px 8px; border-radius: 4px;
        }
        .d-address { 
            background: #252525; padding: 10px; border-radius: 8px; 
            margin: 10px 0; font-size: 0.9rem; line-height: 1.4; border-left: 3px solid #3498db; 
        }
        
        /* --- ACTION BAR --- */
        .action-bar { display: flex; gap: 10px; margin-top: 15px; }
        .btn-action {
            flex: 1; padding: 12px; border-radius: 8px; border: none;
            font-weight: 700; cursor: pointer; color: white; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-map { background: #34495e; }
        .btn-done { background: #2ecc71; }
        .btn-pickup { background: #e67e22; }

    </style>
</head>
<body>

    <div id="login-overlay">
        <h2 style="color: #3498db;">Delivery Login</h2>
        <input type="email" id="d-email" class="login-inp" placeholder="Email">
        <input type="password" id="d-pass" class="login-inp" placeholder="Password">
        <button onclick="deliveryLogin()" class="btn-action" style="background:#3498db; width:200px; margin-top:15px;">START SHIFT</button>
        <p id="login-msg" style="color:red; margin-top:10px;"></p>
    </div>

    <div id="app" style="display:none;">
        <div class="sticky-wrapper">
            <div class="header-top">
                <div class="logo">üöÄ CCC Delivery</div>
                <button onclick="logout()" style="background:#333; border:none; color:#aaa; padding:5px 10px; border-radius:4px;">Logout</button>
            </div>
            <div style="font-size: 0.8rem; color: #888;">Active Orders</div>
        </div>

        <div id="orders-list"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, update, remove, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9d8Seuez7ihaTSAuPyoCwqjKIR1-VFKg",
            authDomain: "cafe-orders-1afa1.firebaseapp.com",
            databaseURL: "https://cafe-orders-1afa1-default-rtdb.firebaseio.com",
            projectId: "cafe-orders-1afa1",
            storageBucket: "cafe-orders-1afa1.firebasestorage.app",
            messagingSenderId: "274410745480",
            appId: "1:274410745480:web:9964c3914d512aed8d793d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            if(user) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                startDeliveryListener();
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        window.deliveryLogin = () => {
            const e = document.getElementById('d-email').value;
            const p = document.getElementById('d-pass').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => document.getElementById('login-msg').innerText = "Auth Failed");
        }
        window.logout = () => signOut(auth).then(() => location.reload());

        // --- DATA STREAM ---
        function startDeliveryListener() {
            onValue(ref(db, 'orders'), (snap) => {
                const list = document.getElementById('orders-list');
                list.innerHTML = "";
                const data = snap.val();
                if(!data) {
                    list.innerHTML = "<p style='text-align:center; color:#555; margin-top:40px;'>No pending deliveries.</p>";
                    return;
                }

                Object.entries(data).forEach(([key, order]) => {
                    // Show orders that are Ready (done) OR Out for Delivery
                    if(order.status !== 'done' && order.status !== 'out_for_delivery') return;

                    const isOut = order.status === 'out_for_delivery';
                    const bg = isOut ? 'border-color: #e67e22;' : '';
                    
                    // Safe checks for customer data
                    const cName = order.customer ? order.customer.name : 'Unknown';
                    const cPhone = order.customer ? order.customer.phone : '';
                    const cAddress = order.customer ? order.customer.address : 'No Address';
                    const gMapLink = order.customer && order.customer.location ? order.customer.location : null;

                    let btnHtml = "";
                    if (!isOut) {
                        // Order is Ready -> Driver picks it up
                        btnHtml = `<button class="btn-action btn-pickup" onclick="markPickedUp('${key}')"><i class="fas fa-box"></i> PICK UP ORDER</button>`;
                    } else {
                        // Order is Out -> Driver delivers it
                        btnHtml = `<button class="btn-action btn-done" onclick="completeDelivery('${key}')"><i class="fas fa-check"></i> COMPLETE & CASH</button>`;
                    }

                    const card = document.createElement('div');
                    card.className = 'd-card';
                    card.style = bg;
                    card.innerHTML = `
                        <div class="d-status">${isOut ? 'ON WAY' : 'READY'}</div>
                        <h3 style="margin:0; font-size:1.1rem;">#${order.orderId} <span style="font-weight:400; font-size:0.9rem; color:#aaa;">(${cName})</span></h3>
                        <div style="margin-top:5px; color:#2ecc71; font-weight:bold;">‚Çπ${order.financials ? order.financials.grandTotal : '0'} <span style="color:#aaa; font-weight:400; font-size:0.8rem;">(Cash to Collect)</span></div>
                        
                        <div class="d-address">
                            üìç ${cAddress}<br>
                            <a href="tel:${cPhone}" style="color:#3498db; text-decoration:none; display:inline-block; margin-top:5px;">üìû ${cPhone}</a>
                        </div>

                        <div class="action-bar">
                            ${gMapLink ? `<a href="${gMapLink}" target="_blank" class="btn-action btn-map" style="text-decoration:none;"><i class="fas fa-map-marked-alt"></i> MAP</a>` : ''}
                            ${btnHtml}
                        </div>
                    `;
                    list.appendChild(card);
                });
            });
        }

        // --- ACTIONS ---
        window.markPickedUp = (key) => {
            update(ref(db, 'orders/' + key), { status: 'out_for_delivery' });
        }

        window.completeDelivery = (key) => {
            if(!confirm("Confirm CASH Collected & Delivered?")) return;
            
            const orderRef = ref(db, 'orders/' + key);
            get(orderRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    data.completedAt = Date.now(); 
                    data.status = 'delivered'; 

                    set(ref(db, 'history/' + key), data)
                        .then(() => { remove(orderRef); })
                        .catch((err) => alert("Error: " + err));
                }
            });
        }
    </script>
</body>
</html>
