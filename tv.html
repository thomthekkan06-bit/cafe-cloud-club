<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen Display System (TV) | Caf√© Cloud Club</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --primary: #3b82f6; 
            --accent: #FFD700;
            --danger: #ef4444;
            --success: #10b981;
            --pending-border: #f59e0b;
            --cooking-border: #3b82f6;
            --done-border: #10b981;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER --- */
        .tv-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px 20px 20px;
            border-bottom: 2px solid #333;
            margin-bottom: 20px;
        }

        .brand-area {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .brand-logo {
            height: 60px;
            width: auto;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }

        /* REMOVED: .brand-title class and element */

        .clock {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-color);
            background: #222;
            padding: 5px 20px;
            border-radius: 10px;
            border: 1px solid #444;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* --- KANBAN BOARD --- */
        .kanban-board {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            flex: 1;
            overflow: hidden;
        }

        .column {
            background: #1a1a1a;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-top: 5px solid transparent;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .col-pending { border-top-color: var(--pending-border); background: linear-gradient(180deg, #1a1a1a 0%, #251805 100%); }
        .col-cooking { border-top-color: var(--cooking-border); background: linear-gradient(180deg, #1a1a1a 0%, #051025 100%); }
        .col-done { border-top-color: var(--done-border); background: linear-gradient(180deg, #1a1a1a 0%, #052515 100%); }

        .col-header {
            padding: 15px;
            font-size: 1.5rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .count-badge {
            background: rgba(255,255,255,0.1);
            padding: 2px 12px;
            border-radius: 20px;
            font-size: 1rem;
        }

        .orders-list {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* --- ORDER CARD --- */
        .order-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            position: relative;
            border-left: 5px solid #555;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            animation: slideIn 0.4s ease-out;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .order-card.priority-high {
            border-left-color: var(--danger);
            animation: pulseBorder 2s infinite;
        }

        @keyframes pulseBorder {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            border-bottom: 1px dashed #444;
            padding-bottom: 8px;
        }

        .order-id { font-size: 1.4rem; font-weight: 800; color: var(--primary); }
        .order-timer { font-family: monospace; font-size: 1rem; color: #aaa; font-weight: 600; }
        .order-timer.late { color: var(--danger); }

        .customer-name { font-size: 0.9rem; color: #888; margin-top: 2px; font-weight: 600; }

        .items-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 1.1rem;
            color: #eee;
            border-bottom: 1px solid #333;
        }
        .order-item:last-child { border-bottom: none; }
        
        .item-qty {
            background: #333;
            color: var(--accent);
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 4px;
            margin-right: 10px;
        }

        .item-note {
            display: block;
            font-size: 0.85rem;
            color: #f59e0b;
            margin-top: 2px;
            font-style: italic;
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }

    </style>
</head>
<body>

    <div class="tv-header">
        <div class="brand-area">
            <img src="icon.png" alt="Logo" class="brand-logo">
            </div>
        <div class="clock" id="clock">00:00:00</div>
    </div>

    <div class="kanban-board">
        <div class="column col-pending">
            <div class="col-header">
                Incoming <span class="count-badge" id="count-pending">0</span>
            </div>
            <div class="orders-list" id="list-pending">
                </div>
        </div>

        <div class="column col-cooking">
            <div class="col-header">
                Preparing <span class="count-badge" id="count-cooking">0</span>
            </div>
            <div class="orders-list" id="list-cooking">
                </div>
        </div>

        <div class="column col-done">
            <div class="col-header">
                Ready <span class="count-badge" id="count-done">0</span>
            </div>
            <div class="orders-list" id="list-done">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9d8Seuez7ihaTSAuPyoCwqjKIR1-VFKg",
            authDomain: "cafe-orders-1afa1.firebaseapp.com",
            databaseURL: "https://cafe-orders-1afa1-default-rtdb.firebaseio.com",
            projectId: "cafe-orders-1afa1",
            storageBucket: "cafe-orders-1afa1.firebasestorage.app",
            messagingSenderId: "274410745480",
            appId: "1:274410745480:web:9964c3914d512aed8d793d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const ordersRef = ref(db, 'orders');

        // --- CLOCK ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('en-US', { hour12: true });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- AUDIO SYSTEM (LOOPING LOGIC) ---
        const bell = new Audio('bell.mp3');
        bell.loop = true; // IMPORTANT: Sound will loop continuously
        let isRinging = false;

        function updateAudioState(hasPendingOrders) {
            if (hasPendingOrders) {
                if (!isRinging) {
                    bell.currentTime = 0; // Start from beginning
                    bell.play().catch(e => console.log("Audio play failed (user interaction needed):", e));
                    isRinging = true;
                }
            } else {
                if (isRinging) {
                    bell.pause();
                    bell.currentTime = 0;
                    isRinging = false;
                }
            }
        }

        // --- RENDER LOGIC ---
        onValue(ordersRef, (snapshot) => {
            const data = snapshot.val() || {};
            
            // Clear Lists
            document.getElementById('list-pending').innerHTML = '';
            document.getElementById('list-cooking').innerHTML = '';
            document.getElementById('list-done').innerHTML = '';

            let pendingCount = 0;
            let cookingCount = 0;
            let doneCount = 0;
            
            // Convert to array and sort by time
            const orders = Object.entries(data).map(([key, val]) => ({ key, ...val }));
            orders.sort((a, b) => a.timestamp - b.timestamp);

            orders.forEach(order => {
                if(order.status === 'completed' || order.status === 'rejected') return;

                const card = createOrderCard(order);

                if (order.status === 'pending') {
                    document.getElementById('list-pending').appendChild(card);
                    pendingCount++;
                } else if (order.status === 'cooking') {
                    document.getElementById('list-cooking').appendChild(card);
                    cookingCount++;
                } else if (order.status === 'done' || order.status === 'out_for_delivery') {
                    document.getElementById('list-done').appendChild(card);
                    doneCount++;
                }
            });

            // Update Badges
            document.getElementById('count-pending').innerText = pendingCount;
            document.getElementById('count-cooking').innerText = cookingCount;
            document.getElementById('count-done').innerText = doneCount;

            // --- AUDIO TRIGGER ---
            // If there are ANY pending orders, ring the bell.
            // If pendingCount goes to 0 (all moved to preparing), sound stops.
            updateAudioState(pendingCount > 0);
        });

        function createOrderCard(order) {
            const el = document.createElement('div');
            el.className = 'order-card';
            
            // Timer Logic
            const elapsed = Math.floor((Date.now() - order.timestamp) / 60000);
            const isLate = elapsed > 20; // Red text if waiting > 20 mins
            if(isLate && order.status !== 'done') el.classList.add('priority-high');

            let itemsHtml = '';
            if(order.items) {
                order.items.forEach(item => {
                    itemsHtml += `
                        <li class="order-item">
                            <span><span class="item-qty">${item.qty}</span> ${item.name}</span>
                        </li>
                    `;
                });
            }

            // Note logic
            let noteHtml = '';
            if(order.globalNote && order.globalNote !== '-') {
                noteHtml = `<div style="background:#333; padding:8px; margin-top:10px; border-radius:6px; font-size:0.9rem; border-left:3px solid #f59e0b; color:#fff;">
                    <strong>Note:</strong> ${order.globalNote}
                </div>`;
            }

            el.innerHTML = `
                <div class="card-header">
                    <div>
                        <div class="order-id">#${order.orderId}</div>
                        <div class="customer-name">${order.customer?.name || 'Guest'}</div>
                    </div>
                    <div class="order-timer ${isLate ? 'late' : ''}">${elapsed}m</div>
                </div>
                <ul class="items-list">
                    ${itemsHtml}
                </ul>
                ${noteHtml}
            `;
            return el;
        }
    </script>
</body>
</html>
