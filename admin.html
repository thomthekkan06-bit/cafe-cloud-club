<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Admin | Café Cloud Club</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #FF4500; --border: #333; --sidebar-w: 240px; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; }
        
        /* LOGIN OVERLAY (Replaces PIN) */
        #login-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }

        /* --- LAYOUT STRUCTURE --- */
        .sidebar { width: var(--sidebar-w); background: #0a0a0a; border-right: 1px solid var(--border); overflow-y: auto; display: flex; flex-direction: column; padding: 20px 0; flex-shrink: 0; transition: transform 0.3s ease; }
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative; }
        
        /* HEADER (STICKY) */
        .top-bar { background: rgba(18, 18, 18, 0.95); border-bottom: 1px solid var(--border); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100; backdrop-filter: blur(5px); }
        .top-bar-left { display: flex; align-items: center; gap: 15px; }
        .top-bar h1 { margin: 0; font-size: 1.2rem; color: var(--accent); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .menu-toggle-btn { display: none; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0; }

        /* SCROLLABLE CONTENT AREA */
        .content-scroll { padding: 20px; overflow-y: auto; scroll-behavior: smooth; flex: 1; }

        /* SIDEBAR LINKS */
        .nav-header { padding: 0 20px; font-size: 0.8rem; text-transform: uppercase; color: #666; margin-bottom: 10px; letter-spacing: 1px; font-weight: 800; }
        .nav-btn { padding: 12px 20px; cursor: pointer; color: #aaa; transition: 0.2s; font-size: 0.9rem; border-left: 3px solid transparent; }
        .nav-btn:hover { background: #1a1a1a; color: white; }
        .nav-btn.active { background: #1e1e1e; color: var(--accent); border-left-color: var(--accent); font-weight: 700; }

        /* STOCK WATCH (TOP STATUS) */
        .stock-watch { background: #2c0b05; border: 1px solid #c0392b; border-radius: 8px; padding: 15px; margin-bottom: 30px; display: none; }
        .stock-watch h3 { margin: 0 0 10px 0; color: #e74c3c; font-size: 0.9rem; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
        .alert-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .alert-item { background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; }

        /* CATEGORY SECTIONS */
        .category-section { margin-bottom: 40px; scroll-margin-top: 80px; }
        .cat-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .cat-stock-btn { font-size: 0.7rem; background: #222; border: 1px solid #444; color: #ccc; padding: 6px 10px; border-radius: 4px; cursor: pointer; text-transform: uppercase; font-weight: 700; }
        .cat-stock-btn:hover { background: #333; border-color: #666; color: white; }

        /* ITEMS GRID */
        .items-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .item-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.2s, border-color 0.2s; height: 100%; box-sizing: border-box; }
        .item-card:hover { transform: translateY(-3px); border-color: #555; }
        
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; gap: 10px; }
        .card-name { font-size: 0.95rem; font-weight: 600; color: #fff; line-height: 1.3; }
        
        .type-badge { font-size: 0.65rem; font-weight: 800; padding: 2px 5px; border-radius: 3px; letter-spacing: 0.5px; border: 1px solid transparent; white-space: nowrap; height: fit-content; }
        .type-veg { color: #2ecc71; border-color: #2ecc71; background: rgba(46, 204, 113, 0.1); }
        .type-non { color: #e74c3c; border-color: #e74c3c; background: rgba(231, 76, 60, 0.1); }

        .card-price { font-family: monospace; font-size: 1.1rem; color: var(--accent); font-weight: 700; margin-bottom: 15px; }
        .card-actions { margin-top: auto; }
        
        .status-badge { font-size: 0.75rem; padding: 6px; border-radius: 4px; font-weight: 800; cursor: pointer; text-transform: uppercase; border: 1px solid transparent; width: 100%; text-align: center; display: block; box-sizing: border-box; }
        .st-active { background: rgba(39, 174, 96, 0.15); color: #2ecc71; border-color: #27ae60; }
        .st-off { background: rgba(192, 57, 43, 0.15); color: #e74c3c; border-color: #c0392b; }
        .st-timer { background: rgba(243, 156, 18, 0.15); color: #f39c12; border-color: #e67e22; }

        .edit-link { text-align: center; margin-top: 8px; font-size: 0.75rem; color: #666; text-decoration: underline; cursor: pointer; }

        /* BUTTONS */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; color: white; font-size: 0.9rem; }
        .btn-green { background: #27ae60; } .btn-green:hover { background: #219150; }
        .btn-blue { background: #2980b9; } .btn-blue:hover { background: #21618c; }
        .btn-red { background: #c0392b; }
        
        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-card { background: #1e1e1e; padding: 25px; border-radius: 16px; width: 90%; max-width: 450px; text-align: center; border: 1px solid #444; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .stock-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 20px; }
        .stock-btn { padding: 12px; background: #2c2c2c; border: 1px solid #333; color: #ddd; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 0.9rem; }
        .stock-btn:hover { background: #333; border-color: #555; color: white; transform: translateY(-2px); }
        .btn-manual { border-color: #8e2b22; color: #ff6b6b; background: rgba(192, 57, 43, 0.1); }
        .btn-reset { grid-column: 1 / -1; background: #27ae60; color: white; border-color: #27ae60; font-size: 1rem; }

        /* EDITOR */
        .edit-form { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; background: #222; padding: 25px; border: 1px solid var(--accent); border-radius: 12px; z-index: 2001; display: none; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .form-group { margin-bottom: 15px; }
        label { display: block; color: #888; margin-bottom: 5px; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select { width: 100%; padding: 12px; background: #111; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        input:focus, select:focus { border-color: var(--accent); outline: none; }

        /* SIDEBAR OVERLAY */
        #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 4999; backdrop-filter: blur(2px); }

        /* --- RESPONSIVE --- */
        @media (max-width: 800px) {
            body { flex-direction: column; overflow: hidden; }
            #app { display: flex !important; flex-direction: column; height: 100%; overflow: hidden; }
            .main-content { width: 100%; height: 100%; overflow: hidden; }
            .sidebar { position: fixed; top: 0; left: -280px; width: 260px; height: 100%; z-index: 5000; background: #0a0a0a; border-right: 1px solid #333; box-shadow: 5px 0 15px rgba(0,0,0,0.5); padding-top: 60px; }
            .sidebar.open { transform: translateX(280px); }
            .menu-toggle-btn { display: block; }
            .content-scroll { padding: 15px; }
            .items-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <h2 style="color: var(--accent);">Admin Access</h2>
        <input type="email" id="login-email" placeholder="Email" style="padding: 10px; margin: 5px; width: 250px; background: #222; border: 1px solid #444; color: white;">
        <input type="password" id="login-pass" placeholder="Password" style="padding: 10px; margin: 5px; width: 250px; background: #222; border: 1px solid #444; color: white;">
        <button onclick="adminLogin()" class="btn btn-blue" style="margin-top: 15px; padding: 10px 30px;">LOGIN</button>
        <p id="login-error" style="color: red; margin-top: 10px;"></p>
        
        <div style="margin-top: 40px; font-size: 0.7rem; color: #666; font-family: sans-serif;">
            Admin Console by <span style="color: var(--accent); font-weight: bold;">Thomsons Networks</span>
        </div>
    </div>
    
    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div id="app" style="display:none; width:100%; height:100%;">
        
        <div class="sidebar" id="main-sidebar">
            <div class="nav-header">Select Category</div>
            <div id="nav-list"></div>
            <button onclick="logout()" style="background:none; border:none; color:#666; padding:20px; cursor:pointer; text-align:left; font-size:0.8rem; margin-top:auto;">← Logout</button>
        </div>

        <div class="main-content">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="menu-toggle-btn" onclick="toggleSidebar()">☰</button>
                    <h1>Menu Manager</h1>
                </div>
                <button onclick="showAddForm()" class="btn btn-green">+ New</button>
            </div>

            <div class="content-scroll" id="scroll-area">
                <div id="stock-watch" class="stock-watch">
                    <h3>⚠️ Currently Unavailable Items</h3>
                    <div id="stock-watch-list" class="alert-grid"></div>
                </div>
                <div id="menu-root"></div>
            </div>
        </div>

    </div>

    <div id="editor-overlay" class="modal-overlay" style="z-index: 2000;">
        <div id="editor" class="edit-form" style="display:block; position:relative; top:auto; left:auto; transform:none; margin:auto;">
            <h3 id="form-title" style="margin-top:0; color:white;">Edit Item</h3>
            <input type="hidden" id="edit-key">
            <div class="form-group"><label>Name</label><input type="text" id="inp-name"></div>
            <div class="form-group"><label>Price</label><input type="number" id="inp-price"></div>
            <div class="form-group">
                <label>Category</label>
                <select id="inp-cat">
                    <option>Bun-Tastic Burgers</option><option>Butcher's Best</option><option>Italian Indulgence</option>
                    <option>Freshly Folded</option><option>Rice Harmony</option><option>Salad Symphony</option>
                    <option>Toasty Treats</option><option>Warm Whispers</option><option>Nibbles & Bits</option>
                    <option>Icy Sips</option><option>Mojito Magic</option><option>Nature's Nectar</option>
                    <option>Whipped Wonders</option><option>Frosted Leaf</option><option>ADD-ON</option>
                </select>
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="inp-type"><option value="veg">Veg</option><option value="non-veg">Non-Veg</option></select>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="saveItem()" class="btn btn-green" style="flex:1;">SAVE</button>
                <button onclick="hideForm()" class="btn btn-red" style="background:#444; flex:1;">CANCEL</button>
            </div>
            <div style="margin-top:15px; text-align:center;">
                <button onclick="deleteItem()" style="background:none; border:none; color:#e74c3c; cursor:pointer; text-decoration:underline;">Delete Item permanently</button>
            </div>
        </div>
    </div>

    <div id="stock-modal" class="modal-overlay">
        <div class="modal-card">
            <h3 id="stock-title" style="margin-top:0; color:#fff;">Manage Stock</h3>
            <p style="font-size:0.9rem; color:#aaa; margin-bottom:20px;">How long should this stay off the menu?</p>
            
            <div class="stock-grid">
                <button class="stock-btn" onclick="applyStock('1h')">1 Hour</button>
                <button class="stock-btn" onclick="applyStock('2h')">2 Hours</button>
                <button class="stock-btn" onclick="applyStock('3h')">3 Hours</button>
                <button class="stock-btn" onclick="applyStock('next_open')">Till Next Open (2 PM)</button>
                <button class="stock-btn btn-manual" onclick="applyStock('manual')">Manual OFF (Forever)</button>
                <button class="stock-btn btn-reset" onclick="applyStock('reset')">TURN ON (In Stock)</button>
            </div>
            <br>
            <button onclick="closeStockModal()" style="background:none; border:none; color:#666; cursor:pointer; margin-top:10px;">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        // ADDED AUTH MODULES
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9d8Seuez7ihaTSAuPyoCwqjKIR1-VFKg",
            authDomain: "cafe-orders-1afa1.firebaseapp.com",
            databaseURL: "https://cafe-orders-1afa1-default-rtdb.firebaseio.com",
            projectId: "cafe-orders-1afa1",
            storageBucket: "cafe-orders-1afa1.firebasestorage.app",
            messagingSenderId: "274410745480",
            appId: "1:274410745480:web:9964c3914d512aed8d793d"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app); // Init Auth

        // --- AUTH LOGIC (REPLACES PIN) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // LOGGED IN
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                loadMenu(); // Only load data if allowed
            } else {
                // LOGGED OUT
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        window.adminLogin = () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const errorMsg = document.getElementById('login-error');
            errorMsg.innerText = "Verifying...";

            signInWithEmailAndPassword(auth, email, pass)
                .catch((error) => {
                    console.error(error);
                    errorMsg.innerText = "Access Denied: " + error.message;
                });
        }

        window.logout = () => {
            if(confirm("Logout from Admin Console?")) {
                signOut(auth).then(() => location.reload());
            }
        }

        // --- SIDEBAR LOGIC ---
        window.toggleSidebar = () => {
            const sidebar = document.getElementById('main-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.style.display = sidebar.classList.contains('open') ? 'block' : 'none';
        }

        // --- CORE LOGIC ---
        function loadMenu() {
            onValue(ref(db, 'menu'), (snap) => {
                const root = document.getElementById('menu-root');
                const navList = document.getElementById('nav-list');
                const stockWatch = document.getElementById('stock-watch');
                const stockList = document.getElementById('stock-watch-list');
                
                root.innerHTML = "";
                navList.innerHTML = "";
                stockList.innerHTML = "";
                
                const data = snap.val();
                if(!data) return;

                const items = Object.entries(data).map(([key, val]) => ({ ...val, key }));
                let outOfStockCount = 0;

                // Group by Category
                const grouped = items.reduce((acc, item) => {
                    const cat = item.category || "Other";
                    if (!acc[cat]) acc[cat] = [];
                    acc[cat].push(item);
                    return acc;
                }, {});

                // Render
                Object.keys(grouped).sort().forEach(cat => {
                    // 1. Sidebar Link
                    const navBtn = document.createElement('div');
                    navBtn.className = 'nav-btn';
                    navBtn.innerText = cat;
                    navBtn.onclick = () => {
                        const target = document.getElementById(`cat-${cat}`);
                        if(target) target.scrollIntoView({ behavior: 'smooth' });
                        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                        navBtn.classList.add('active');
                        if(window.innerWidth <= 800) window.toggleSidebar();
                    };
                    navList.appendChild(navBtn);

                    // 2. Main Content Section
                    const section = document.createElement('div');
                    section.className = 'category-section';
                    section.id = `cat-${cat}`;
                    
                    section.innerHTML = `
                        <div class="cat-title">
                            ${cat}
                            <button class="cat-stock-btn" onclick="openBatchModal('${cat}')">Category Options</button>
                        </div>
                    `;
                    // Create Grid Container
                    const grid = document.createElement('div');
                    grid.className = 'items-grid';

                    grouped[cat].sort((a,b) => a.name.localeCompare(b.name)).forEach(item => {
                        // Status Logic
                        let badgeClass = 'st-active';
                        let badgeText = 'IN STOCK';
                        let isOff = false;

                        if (item.stockStatus === 'MANUAL_OFF') {
                            badgeClass = 'st-off'; badgeText = 'OFF (MANUAL)'; isOff = true;
                        } else if (item.stockStatus === 'TEMP_OFF') {
                            if (Date.now() < item.stockReturnTime) {
                                badgeClass = 'st-timer';
                                const minsLeft = Math.ceil((item.stockReturnTime - Date.now()) / 60000);
                                badgeText = `OFF (${minsLeft}m)`;
                                isOff = true;
                            }
                        } else if (item.inStock === false) { 
                            badgeClass = 'st-off'; badgeText = 'OFF'; isOff = true;
                        }

                        if(isOff) {
                            outOfStockCount++;
                            const alert = document.createElement('div');
                            alert.className = 'alert-item';
                            alert.innerHTML = `<span>${item.name}</span> <span style="color:#e74c3c; font-weight:bold;">${badgeText}</span>`;
                            stockList.appendChild(alert);
                        }

                        // Color Logic
                        const typeClass = (item.type === 'veg') ? 'type-veg' : 'type-non';

                        const card = document.createElement('div');
                        card.className = 'item-card';
                        card.innerHTML = `
                            <div class="card-top">
                                <div class="card-name">${item.name}</div>
                                <span class="type-badge ${typeClass}">${item.type === 'veg' ? 'VEG' : 'NON'}</span>
                            </div>
                            <div class="card-price">₹${item.price}</div>
                            <div class="card-actions">
                                <div class="status-badge ${badgeClass}" onclick="openSingleModal('${item.key}', '${item.name}')">${badgeText}</div>
                                <div class="edit-link" onclick="editItem('${item.key}')">Edit Details</div>
                            </div>
                        `;
                        grid.appendChild(card);
                    });

                    section.appendChild(grid);
                    root.appendChild(section);
                });

                if(outOfStockCount > 0) stockWatch.style.display = 'block';
                else stockWatch.style.display = 'none';
            });
        }

        // --- STOCK LOGIC ---
        let targetKeys = [];
        window.openSingleModal = (key, name) => {
            targetKeys = [key];
            document.getElementById('stock-title').innerText = `${name}`;
            document.getElementById('stock-modal').style.display = 'flex';
        }

        window.openBatchModal = (categoryName) => {
            onValue(ref(db, 'menu'), (snap) => {
                const data = snap.val();
                targetKeys = [];
                Object.entries(data).forEach(([key, val]) => {
                    if (val.category === categoryName) targetKeys.push(key);
                });
                document.getElementById('stock-title').innerText = `Whole Category: ${categoryName}`;
                document.getElementById('stock-modal').style.display = 'flex';
            }, { onlyOnce: true });
        }

        window.closeStockModal = () => document.getElementById('stock-modal').style.display = 'none';
        window.applyStock = (mode) => {
            const updates = {};
            targetKeys.forEach(key => {
                if (mode === 'reset') {
                    updates[`menu/${key}/stockStatus`] = 'ACTIVE';
                } else if (mode === 'manual') {
                    updates[`menu/${key}/stockStatus`] = 'MANUAL_OFF';
                } else {
                    let duration = 0;
                    if (mode === '1h') duration = 3600000;
                    if (mode === '2h') duration = 7200000;
                    if (mode === '3h') duration = 10800000;
                    
                    let returnTime = Date.now() + duration;

                    if (mode === 'next_open') {
                        const target = new Date();
                        target.setHours(14, 0, 0, 0); // 2 PM
                        if (Date.now() > target.getTime()) target.setDate(target.getDate() + 1);
                        returnTime = target.getTime();
                    }

                    updates[`menu/${key}/stockStatus`] = 'TEMP_OFF';
                    updates[`menu/${key}/stockReturnTime`] = returnTime;
                }
            });
            update(ref(db), updates).then(() => closeStockModal());
        }

        // --- CRUD ACTIONS ---
        window.saveItem = () => {
            const key = document.getElementById('edit-key').value;
            const data = {
                name: document.getElementById('inp-name').value,
                price: parseInt(document.getElementById('inp-price').value),
                category: document.getElementById('inp-cat').value,
                type: document.getElementById('inp-type').value,
                stockStatus: 'ACTIVE'
            };
            if(key) update(ref(db, 'menu/' + key), data);
            else push(ref(db, 'menu'), data);
            hideForm();
        }
        window.deleteItem = () => { if(confirm("Delete this item permanently?")) remove(ref(db, 'menu/' + document.getElementById('edit-key').value)).then(hideForm); }
        
        window.showAddForm = () => { 
            document.getElementById('editor-overlay').style.display='flex';
            document.getElementById('form-title').innerText = "New Item";
            document.getElementById('edit-key').value = "";
            document.getElementById('inp-name').value = "";
            document.getElementById('inp-price').value = "";
        }
        window.hideForm = () => document.getElementById('editor-overlay').style.display='none';
        window.editItem = (key) => {
            onValue(ref(db, 'menu/'+key), (s) => {
                const d=s.val();
                document.getElementById('editor-overlay').style.display='flex';
                document.getElementById('form-title').innerText = "Edit Details";
                document.getElementById('edit-key').value=key;
                document.getElementById('inp-name').value=d.name;
                document.getElementById('inp-price').value=d.price;
                document.getElementById('inp-cat').value=d.category;
                document.getElementById('inp-type').value=d.type;
            }, {onlyOnce:true});
        }
    </script>
</body>
</html>
