<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Admin | Caf√© Cloud Club</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #FF4500; --border: #333; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; padding-bottom: 80px; }
        
        /* PIN LOCK */
        #pin-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-input { font-size: 2rem; background: #111; border: 1px solid #333; color: white; text-align: center; padding: 10px; border-radius: 8px; margin-bottom: 20px; letter-spacing: 5px; }
        
        /* UI ELEMENTS */
        h1 { color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; color: white; }
        .btn-green { background: #27ae60; }
        .btn-red { background: #c0392b; }
        .btn-blue { background: #2980b9; }
        
        /* CATEGORIES */
        .category-header { background: #222; color: var(--accent); padding: 15px; margin-top: 30px; margin-bottom: 10px; border-radius: 8px; font-size: 1.2rem; font-weight: 800; border-left: 5px solid var(--accent); text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; }
        .cat-stock-btn { font-size: 0.7rem; background: #333; border: 1px solid #555; color: #ccc; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        
        /* ITEMS */
        .menu-item { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .item-info { flex: 1; }
        .item-name { font-weight: bold; font-size: 1.1rem; }
        .item-meta { color: #888; font-size: 0.85rem; margin-top: 4px; }
        .item-price { color: var(--accent); font-weight: bold; font-family: monospace; font-size: 1rem; }
        
        /* BADGES */
        .stock-toggle { margin-left: 10px; font-size: 0.75rem; cursor: pointer; padding: 4px 8px; border-radius: 4px; border: 1px solid transparent; font-weight: 800; text-transform: uppercase; display: inline-block; }
        .status-active { background: rgba(39, 174, 96, 0.2); color: #2ecc71; border-color: #2ecc71; }
        .status-manual { background: rgba(192, 57, 43, 0.2); color: #e74c3c; border-color: #e74c3c; }
        .status-timer { background: rgba(243, 156, 18, 0.2); color: #f39c12; border-color: #f39c12; }

        /* STOCK MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-card { background: #1e1e1e; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #444; }
        .stock-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stock-btn { padding: 15px; background: #333; border: 1px solid #444; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .stock-btn:hover { background: #444; }
        .btn-manual { border-color: #e74c3c; color: #e74c3c; }
        .btn-reset { grid-column: 1 / -1; background: #27ae60; color: white; border-color: #27ae60; }
        
        /* EDITOR FORM */
        .edit-form { background: #222; padding: 20px; border-radius: 8px; border: 1px solid var(--accent); margin-bottom: 20px; display: none; }
        .form-group { margin-bottom: 15px; }
        label { display: block; color: #888; margin-bottom: 5px; font-size: 0.9rem; }
        input, select { width: 100%; padding: 10px; background: #111; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="pin-overlay">
        <h2>üõ†Ô∏è Menu Admin</h2>
        <input type="tel" id="pin" class="pin-input" maxlength="4" placeholder="****">
        <button onclick="checkPin()" class="btn btn-blue">UNLOCK</button>
    </div>

    <div id="app" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>Menu Manager</h1>
            <button onclick="showAddForm()" class="btn btn-green">+ New Item</button>
        </div>

        <div id="editor" class="edit-form">
            <h3 id="form-title" style="margin-top:0;">Edit Item</h3>
            <input type="hidden" id="edit-key">
            <div class="form-group"><label>Name</label><input type="text" id="inp-name"></div>
            <div class="form-group"><label>Price</label><input type="number" id="inp-price"></div>
            <div class="form-group">
                <label>Category</label>
                <select id="inp-cat">
                    <option>Bun-Tastic Burgers</option><option>Butcher's Best</option><option>Italian Indulgence</option>
                    <option>Freshly Folded</option><option>Rice Harmony</option><option>Salad Symphony</option>
                    <option>Toasty Treats</option><option>Warm Whispers</option><option>Nibbles & Bits</option>
                    <option>Icy Sips</option><option>Mojito Magic</option><option>Nature's Nectar</option>
                    <option>Whipped Wonders</option><option>Frosted Leaf</option><option>ADD-ON</option>
                </select>
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="inp-type"><option value="veg">Veg</option><option value="non-veg">Non-Veg</option></select>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="saveItem()" class="btn btn-green">SAVE</button>
                <button onclick="hideForm()" class="btn btn-red" style="background:#555;">CANCEL</button>
                <button onclick="deleteItem()" class="btn btn-red" id="btn-delete" style="margin-left:auto;">DELETE</button>
            </div>
        </div>

        <div id="menu-list"></div>
    </div>

    <div id="stock-modal" class="modal-overlay">
        <div class="modal-card">
            <h3 id="stock-title" style="margin-top:0; color:#ccc;">Manage Stock</h3>
            <p style="font-size:0.8rem; color:#888;">Select how long this item should remain unavailable.</p>
            
            <div class="stock-grid">
                <button class="stock-btn" onclick="applyStock('1h')">1 Hour</button>
                <button class="stock-btn" onclick="applyStock('2h')">2 Hours</button>
                <button class="stock-btn" onclick="applyStock('3h')">3 Hours</button>
                <button class="stock-btn" onclick="applyStock('next_open')">Till Next Open (2 PM)</button>
                <button class="stock-btn btn-manual" onclick="applyStock('manual')">Manual OFF (Forever)</button>
                <button class="stock-btn btn-reset" onclick="applyStock('reset')">TURN ON (In Stock)</button>
            </div>
            <br>
            <button onclick="closeStockModal()" style="background:none; border:none; color:#666; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9d8Seuez7ihaTSAuPyoCwqjKIR1-VFKg",
            authDomain: "cafe-orders-1afa1.firebaseapp.com",
            databaseURL: "https://cafe-orders-1afa1-default-rtdb.firebaseio.com",
            projectId: "cafe-orders-1afa1",
            storageBucket: "cafe-orders-1afa1.firebasestorage.app",
            messagingSenderId: "274410745480",
            appId: "1:274410745480:web:9964c3914d512aed8d793d"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- AUTH ---
        window.checkPin = () => {
            if(document.getElementById('pin').value === "2021") {
                document.getElementById('pin-overlay').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                loadMenu();
            } else alert("Wrong PIN");
        }

        // --- MENU LOADING ---
        function loadMenu() {
            onValue(ref(db, 'menu'), (snap) => {
                const list = document.getElementById('menu-list');
                list.innerHTML = "";
                const data = snap.val();
                if(!data) { list.innerHTML = "<div style='text-align:center; padding:20px; color:#666;'>No Items.</div>"; return; }

                const items = Object.entries(data).map(([key, val]) => ({ ...val, key }));
                
                // Group by Category
                const grouped = items.reduce((acc, item) => {
                    const cat = item.category || "Other";
                    if (!acc[cat]) acc[cat] = [];
                    acc[cat].push(item);
                    return acc;
                }, {});

                // Render Categories
                Object.keys(grouped).sort().forEach(cat => {
                    // Header with "Disable Category" button
                    const header = document.createElement('div');
                    header.className = 'category-header';
                    header.innerHTML = `
                        <span>${cat}</span>
                        <button class="cat-stock-btn" onclick="openBatchModal('${cat}')">‚ö° CONTROL</button>
                    `;
                    list.appendChild(header);

                    grouped[cat].sort((a,b) => a.name.localeCompare(b.name)).forEach(item => {
                        // Logic to determine status badge
                        let badgeClass = 'status-active';
                        let badgeText = 'IN STOCK';
                        
                        // Check logic (mirrors customer app)
                        if (item.stockStatus === 'MANUAL_OFF') {
                            badgeClass = 'status-manual';
                            badgeText = 'OFF (MANUAL)';
                        } else if (item.stockStatus === 'TEMP_OFF') {
                            if (Date.now() < item.stockReturnTime) {
                                badgeClass = 'status-timer';
                                const minsLeft = Math.ceil((item.stockReturnTime - Date.now()) / 60000);
                                badgeText = `OFF (${minsLeft}m)`;
                            }
                        }

                        const div = document.createElement('div');
                        div.className = 'menu-item';
                        div.style.opacity = (badgeText === 'IN STOCK') ? '1' : '0.5';
                        div.innerHTML = `
                            <div class="item-info">
                                <div class="item-name">
                                    ${item.name} 
                                    <span class="stock-toggle ${badgeClass}" onclick="openSingleModal('${item.key}', '${item.name}')">${badgeText}</span>
                                </div>
                                <div class="item-meta">${item.type.toUpperCase()}</div>
                            </div>
                            <div class="item-price">‚Çπ${item.price}</div>
                            <button onclick="editItem('${item.key}')" class="btn btn-blue" style="margin-left:15px; padding:5px 10px; font-size:0.8rem;">EDIT</button>
                        `;
                        list.appendChild(div);
                    });
                });
            });
        }

        // --- STOCK LOGIC ---
        let targetKeys = []; // Stores keys to update (single or batch)

        window.openSingleModal = (key, name) => {
            targetKeys = [key];
            document.getElementById('stock-title').innerText = `Manage: ${name}`;
            document.getElementById('stock-modal').style.display = 'flex';
        }

        window.openBatchModal = (categoryName) => {
            // Find all keys in this category
            onValue(ref(db, 'menu'), (snap) => {
                const data = snap.val();
                targetKeys = [];
                Object.entries(data).forEach(([key, val]) => {
                    if (val.category === categoryName) targetKeys.push(key);
                });
                document.getElementById('stock-title').innerText = `Manage Category: ${categoryName}`;
                document.getElementById('stock-modal').style.display = 'flex';
            }, { onlyOnce: true });
        }

        window.closeStockModal = () => document.getElementById('stock-modal').style.display = 'none';

        window.applyStock = (mode) => {
            const updates = {};
            
            targetKeys.forEach(key => {
                if (mode === 'reset') {
                    // Turn ON
                    updates[`menu/${key}/stockStatus`] = 'ACTIVE';
                } else if (mode === 'manual') {
                    // Turn OFF Forever
                    updates[`menu/${key}/stockStatus`] = 'MANUAL_OFF';
                } else {
                    // Timed OFF
                    let duration = 0;
                    if (mode === '1h') duration = 60 * 60 * 1000;
                    if (mode === '2h') duration = 2 * 60 * 60 * 1000;
                    if (mode === '3h') duration = 3 * 60 * 60 * 1000;
                    
                    let returnTime = Date.now() + duration;

                    if (mode === 'next_open') {
                        // Calculate next 2 PM (14:00)
                        const now = new Date();
                        const target = new Date();
                        target.setHours(14, 0, 0, 0);
                        // If 2PM already passed today, set for tomorrow
                        if (Date.now() > target.getTime()) {
                            target.setDate(target.getDate() + 1);
                        }
                        returnTime = target.getTime();
                    }

                    updates[`menu/${key}/stockStatus`] = 'TEMP_OFF';
                    updates[`menu/${key}/stockReturnTime`] = returnTime;
                }
            });

            update(ref(db), updates).then(() => {
                closeStockModal();
            });
        }

        // --- CRUD HELPERS ---
        window.saveItem = () => {
            const key = document.getElementById('edit-key').value;
            const data = {
                name: document.getElementById('inp-name').value,
                price: parseInt(document.getElementById('inp-price').value),
                category: document.getElementById('inp-cat').value,
                type: document.getElementById('inp-type').value,
                stockStatus: 'ACTIVE' // Default new items to Active
            };
            if(key) update(ref(db, 'menu/' + key), data);
            else push(ref(db, 'menu'), data);
            hideForm();
        }
        window.deleteItem = () => { if(confirm("Delete?")) remove(ref(db, 'menu/' + document.getElementById('edit-key').value)).then(hideForm); }
        window.showAddForm = () => { document.getElementById('editor').style.display='block'; window.scrollTo(0,0); }
        window.hideForm = () => document.getElementById('editor').style.display='none';
        window.editItem = (key) => {
            onValue(ref(db, 'menu/'+key), (s) => {
                const d=s.val();
                document.getElementById('edit-key').value=key;
                document.getElementById('inp-name').value=d.name;
                document.getElementById('inp-price').value=d.price;
                document.getElementById('inp-cat').value=d.category;
                document.getElementById('inp-type').value=d.type;
                document.getElementById('editor').style.display='block';
                window.scrollTo(0,0);
            }, {onlyOnce:true});
        }

    </script>
</body>
</html>
