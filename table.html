<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Table Ordering | Cafe Cloud Club</title>
    
    <link rel="icon" type="image/png" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- DARK THEME OVERRIDE --- */
        :root {
            --primary: #3b82f6; 
            --secondary: #f3f4f6;   /* Light Text */
            --bg: #0f1115;          /* Dark Background */
            --white: #181b21;       /* Dark Card Surface */
            --dark-text: #f3f4f6;   /* Light Text */
            --grey-text: #9ca3af;   /* Muted Text */
            --success: #10b981;
            --border: #2f3542;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden; /* Critical for mobile */
            position: relative;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding-bottom: 80px; 
            color: var(--secondary);
            -webkit-tap-highlight-color: transparent;
        }

        /* --- NAVBAR --- */
        .table-navbar {
            background: #181b21;
            border-bottom: 1px solid var(--border);
            padding: 10px 15px;
            position: sticky; top: 0; z-index: 1000;
            display: grid; 
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            height: 60px;
        }

        .nav-left { display: flex; align-items: center; gap: 12px; }
        
        .menu-toggle-btn {
            background: none; border: 1px solid var(--border); color: var(--primary);
            width: 38px; height: 38px; border-radius: 8px; font-size: 1.1rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .menu-toggle-btn:active { background: rgba(59, 130, 246, 0.1); }

        .nav-logo { height: 38px; width: auto; border-radius: 6px; border: 1px solid var(--border); }

        .table-info { text-align: center; white-space: nowrap; }
        .table-info h1 { margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--primary); letter-spacing: 0.5px; }
        .table-info span { font-size: 0.75rem; opacity: 0.8; display: block; margin-top: -2px; }

        /* --- SIDEBAR OVERLAY --- */
        .sidebar-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 11000; backdrop-filter: blur(2px); 
        }
        .sidebar-overlay.active { display: block; }
        
        /* --- LEFT SIDEBAR (TRANSFORM FIX) --- */
        .left-sidebar { 
            position: fixed; top: 0; left: 0; width: 280px; height: 100%; background: var(--white);
            z-index: 12000; 
            /* Use Transform instead of Left/Right to prevent layout breaking */
            transform: translateX(-100%); 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 2px 0 10px rgba(0,0,0,0.5); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 20px; overflow-y: auto;
        }
        .left-sidebar.active { transform: translateX(0); }
        
        .filter-item { 
            padding: 12px 15px; border-radius: 8px; font-size: 0.9rem; cursor: pointer;
            margin-bottom: 5px; color: var(--grey-text); font-weight: 500;
            transition: 0.2s; border: 1px solid transparent; display: flex; align-items: center; justify-content: space-between;
        }
        .filter-item:hover { background: #333; color: var(--primary); }
        .filter-item.active { 
            background: rgba(59, 130, 246, 0.1); color: var(--primary); 
            border: 1px solid var(--primary); font-weight: 700; 
        }

        /* --- RIGHT SIDEBAR / CART (TRANSFORM FIX) --- */
        .order-sidebar {
            position: fixed; top: 0; right: 0; width: 100%; max-width: 400px;
            height: 100dvh; 
            background: var(--bg); z-index: 12000; padding: 20px; border-left: 1px solid var(--border);
            /* Use Transform instead of Right to prevent layout breaking */
            transform: translateX(100%);
            transition: transform 0.3s ease; display: flex; flex-direction: column;
            box-shadow: -5px 0 15px rgba(0,0,0,0.5);
        }
        .order-sidebar.active { transform: translateX(0); }
        
        /* --- SEARCH & FILTERS --- */
        .filter-bar { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .search-box {
            background: var(--white); border: 1px solid var(--border); border-radius: 10px;
            padding: 10px 15px; display: flex; align-items: center; gap: 10px;
        }
        .search-box input {
            background: transparent; border: none; color: white; width: 100%; font-family: inherit; outline: none; font-size: 0.95rem;
        }
        .advanced-filters {
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none;
        }
        .advanced-filters::-webkit-scrollbar { display: none; }
        
        .adv-select {
            padding: 8px 12px; border-radius: 20px; border: 1px solid var(--border);
            background: var(--white); color: var(--secondary); font-size: 0.85rem;
            cursor: pointer; min-width: 100px;
        }

        /* --- MENU GRID --- */
        .menu-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px; padding: 0 15px 15px 15px;
        }
        .food-card {
            background: var(--white); border-radius: 12px; padding: 15px;
            border-left: 4px solid #333; 
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); position: relative;
        }
        .food-card.veg { border-left-color: var(--success); }
        .food-card.non-veg { border-left-color: #c0392b; }

        .card-top { margin-bottom: 10px; }
        .food-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 3px; line-height: 1.3; color: white; }
        .food-meta { font-size: 0.7rem; color: var(--grey-text); text-transform: uppercase; }

        .price-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .price { font-weight: 700; font-size: 1rem; color: white; }
        .add-btn-mini {
            background: #334155; color: white; padding: 8px 14px;
            border-radius: 20px; border: none; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: 0.2s;
        }
        .add-btn-mini:active { transform: scale(0.95); background: var(--primary); }

        /* --- FLOATING CART BTN --- */
        .mobile-cart-btn {
            position: fixed; bottom: 25px; right: 20px;
            background: var(--primary); color: white; border: none;
            padding: 14px 25px; border-radius: 50px; cursor: pointer; font-weight: 600;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.5); z-index: 100;
            display: flex; align-items: center; gap: 10px; transition: transform 0.2s;
            font-size: 1rem;
        }

        /* --- CART ITEMS --- */
        .cart-header-mobile { display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .back-btn { background: none; border: none; font-size: 1rem; color: var(--primary); cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;}
        
        .cart-items-container { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .cart-item { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px dashed #333; padding-bottom: 10px; }
        .qty-btn { background: #333; color: white; border: none; width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; }

        .cart-summary { 
            margin-top: auto; border-top: 2px solid var(--border); 
            padding-top: 15px; padding-bottom: calc(20px + env(safe-area-inset-bottom)); 
            background: var(--bg); 
        }
        .summary-row { display: flex; justify-content: space-between; font-weight: 700; font-size: 1.2rem; margin-bottom: 15px; color: white; }
        
        .checkout-btn { 
            width: 100%; background: var(--primary); color: white; 
            padding: 16px; border: none; border-radius: 12px; 
            font-size: 1.1rem; font-weight: 700; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        .checkout-btn:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 13000; display: none;
            align-items: center; justify-content: center; 
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
        }
        .modal-card {
            background: rgba(24, 27, 33, 0.95); 
            color: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 350px;
            text-align: center; border: 1px solid var(--border); display: flex; flex-direction: column; max-height: 85vh;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        /* NEW: ALIGNMENT & GROUPING FOR INPUTS */
        .input-group { text-align: left; margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.85rem; color: #aaa; margin-bottom: 6px; font-weight: 500; }
        
        .input-field { 
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; 
            font-family: inherit; background: var(--bg); color: white; outline: none; font-size: 1rem;
        }
        .input-field:focus { border-color: var(--primary); }
        /* Style for locked input fields */
        .input-field:read-only {
            background-color: #2f3542;
            color: #ccc;
            cursor: not-allowed;
            border-color: #444;
        }
        
        .modal-scroll-area { overflow-y: auto; flex: 1; text-align: left; margin-bottom: 15px; padding-right: 5px; }
        .custom-option-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #333; font-size: 0.95rem; }
        .modal-footer { border-top: 1px solid var(--border); padding-top: 15px; display: flex; justify-content: space-between; align-items: center; }

        /* --- SUCCESS --- */
        .success-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 14000; display: none;
            flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px;
        }
        .success-icon-container {
            width: 80px; height: 80px; background: var(--success);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px; color: white; font-size: 40px;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        }
        .btn-back-floor {
            background: #1e293b; border: 1px solid var(--primary); color: var(--primary);
            padding: 12px 25px; border-radius: 12px; margin-top: 25px;
            cursor: pointer; font-weight: 600; font-size: 1rem; display: none; transition: all 0.2s;
        }
        .btn-back-floor:hover { background: var(--primary); color: white; }
    </style>
</head>
<body>

    <div class="table-navbar">
        <div class="nav-left">
            <button class="menu-toggle-btn" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <img src="og-image.jpg" alt="Logo" class="nav-logo">
        </div>

        <div class="table-info">
            <h1 id="header-table-num">Table --</h1>
            <span>Dine-In <span id="waiter-badge" style="display:none; color:var(--warning);">‚Ä¢ WAITER</span></span>
        </div>
        
        <div></div> 
    </div>

    <div class="sidebar-overlay" onclick="closeAllSidebars()"></div>

    <div class="left-sidebar" id="left-sidebar">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid var(--border);">
            <img src="og-image.jpg" style="height:30px; border-radius:4px;">
            <h3 style="margin:0; color:white; font-size:1.1rem;">Menu</h3>
        </div>
        
        <div class="filter-item active" onclick="filterCat('All', this)"><span>All Items</span> <i class="fas fa-chevron-right" style="font-size:0.7rem;"></i></div>
        <div class="filter-item" onclick="filterCat('Bun-Tastic Burgers', this)"><span>Burgers</span> <i class="fas fa-hamburger" style="font-size:0.8rem;"></i></div>
        <div class="filter-item" onclick="filterCat('Butcher\'s Best', this)"><span>Steaks</span> <i class="fas fa-drumstick-bite" style="font-size:0.8rem;"></i></div>
        <div class="filter-item" onclick="filterCat('Italian Indulgence', this)"><span>Pastas</span> <i class="fas fa-utensils" style="font-size:0.8rem;"></i></div>
        <div class="filter-item" onclick="filterCat('Freshly Folded', this)"><span>Wraps</span> <i class="fas fa-scroll" style="font-size:0.8rem;"></i></div>
        <div class="filter-item" onclick="filterCat('Rice Harmony', this)"><span>Rice Bowls</span> <i class="fas fa-bowl-rice" style="font-size:0.8rem;"></i></div>
        <div class="filter-item" onclick="filterCat('Salad Symphony', this)"><span>Salads</span> <i class="fas fa-leaf" style="font-size:0.8rem;"></i></div>
        <div class="filter-item" onclick="filterCat('Toasty Treats', this)"><span>Sandwiches</span> <i class="fas fa-bread-slice" style="font-size:0.8rem;"></i></div>
        <div class="filter-item" onclick="filterCat('Warm Whispers', this)"><span>Soups</span> <i class="fas fa-mug-hot" style="font-size:0.8rem;"></i></div>
        <div class="filter-item" onclick="filterCat('Nibbles & Bits', this)"><span>Fries/Sides</span> <i class="fas fa-bacon" style="font-size:0.8rem;"></i></div>
        <div class="filter-item" onclick="filterCat('Whipped Wonders', this)"><span>Shakes</span> <i class="fas fa-ice-cream" style="font-size:0.8rem;"></i></div>
        <div class="filter-item" onclick="filterCat('Mojito Magic', this)"><span>Mojitos</span> <i class="fas fa-cocktail" style="font-size:0.8rem;"></i></div>
        <div class="filter-item" onclick="filterCat('Icy Sips', this)"><span>Cold Drinks</span> <i class="fas fa-glass-whiskey" style="font-size:0.8rem;"></i></div>
        <div class="filter-item" onclick="filterCat('Nature\'s Nectar', this)"><span>Juices</span> <i class="fas fa-apple-alt" style="font-size:0.8rem;"></i></div>
        <div class="filter-item" onclick="filterCat('Frosted Leaf', this)"><span>Ice Teas</span> <i class="fas fa-glass-martini" style="font-size:0.8rem;"></i></div>
        <div class="filter-item" onclick="filterCat('ADD-ON', this)"><span>Add-Ons</span> <i class="fas fa-plus-circle" style="font-size:0.8rem;"></i></div>
        <div class="filter-item" onclick="filterCat('Caf√© Botanical Brews', this)"><span>Botanical Brews</span> <i class="fas fa-mug-hot" style="font-size:0.8rem;"></i></div>
    </div>

    <div class="filter-bar">
        <div class="search-box">
            <i class="fas fa-search" style="color: #666;"></i>
            <input type="text" id="search-input" placeholder="Search for food..." onkeyup="renderMenu()">
        </div>
        <div class="advanced-filters">
            <select class="adv-select" onchange="setSort(this.value)" id="sort-select">
                <option value="default">Sort By...</option>
                <option value="low-high">Price: Low to High</option>
                <option value="high-low">Price: High to Low</option>
            </select>
            <select class="adv-select" onchange="setType(this.value)" id="type-select">
                <option value="all">Diet: All</option>
                <option value="veg">Veg Only</option>
                <option value="non-veg">Non-Veg Only</option>
            </select>
            <select class="adv-select" onchange="setIngredient(this.value)" id="ing-select">
                <option value="all">Ingredient: All</option>
                <option value="Chicken">Chicken</option>
                <option value="Beef">Beef</option>
                <option value="Fish">Fish</option>
                <option value="Panner">Paneer</option>
            </select>
        </div>
    </div>

    <div class="menu-grid" id="menu-root">
        <div style="text-align:center; width:100%; padding:40px; color:#666;">
            <i class="fas fa-circle-notch fa-spin" style="font-size:2rem; margin-bottom:10px;"></i><br>
            Loading Menu...
        </div>
    </div>

    <button class="mobile-cart-btn" onclick="toggleCart()">
        <i class="fas fa-utensils"></i> View Order <span id="cart-count" style="background:white; color:var(--primary); padding:2px 6px; border-radius:10px; font-size:0.8rem; margin-left:5px;">0</span>
    </button>

    <div class="order-sidebar" id="cart-sidebar">
        <div class="cart-header-mobile">
            <button class="back-btn" onclick="toggleCart()"><i class="fas fa-chevron-right"></i> Continue Ordering</button>
            <span style="margin-left:auto; font-weight:700;">Cart</span>
        </div>
        
        <div class="cart-items-container" id="cart-list"></div>
        
        <div class="cart-summary">
            <div class="summary-row">
                <span>Total Bill</span>
                <span id="cart-total">‚Çπ0</span>
            </div>
            <button class="checkout-btn" id="btn-checkout" onclick="openCheckout()" disabled>Place Order</button>
        </div>
    </div>

    <div class="modal-overlay" id="checkout-modal">
        <div class="modal-card">
            <h3 style="margin-top:0; color:var(--primary);">Confirm Order</h3>
            <p id="modal-table-txt" style="font-weight:bold; color:#aaa; font-size:0.9rem; margin-bottom:20px;"></p>
            
            <div class="input-group">
                <label>Guest Name (Required)</label>
                <input type="text" class="input-field" id="cust-name" placeholder="Enter Name">
            </div>

            <div class="input-group">
                <label>Phone Number (10 Digits)</label>
                <input type="tel" class="input-field" id="cust-phone" placeholder="Mobile Number" maxlength="10" inputmode="numeric" pattern="[0-9]*" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>

            <button class="checkout-btn" onclick="placeOrder()">SEND TO KITCHEN üë®‚Äçüç≥</button>
            <button style="width:100%; background:none; border:none; padding:15px; color:#777; cursor:pointer; margin-top:5px; font-size:0.9rem;" onclick="closeCheckout()">Cancel</button>
        </div>
    </div>

    <div class="modal-overlay" id="customization-modal">
        <div class="modal-card">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:15px;">
                <h3 id="cust-title" style="margin:0; font-size:1.1rem; text-align:left; color:white;">Item Name</h3>
                <div style="font-size:1.5rem; cursor:pointer; color:#888;" onclick="closeCustomization()">&times;</div>
            </div>
            
            <div id="cust-options" class="modal-scroll-area"></div>
            
            <div style="text-align:left; margin-bottom:10px;">
                <label style="font-size:0.8rem; color:#888;">Note (Optional)</label>
                <input type="text" id="cust-note" class="input-field" style="margin:5px 0 10px 0; padding:10px;" placeholder="e.g. Less Spicy">
            </div>

            <div class="modal-footer">
                <div style="font-weight:700; color:var(--primary); font-size:1.2rem;" id="cust-total">‚Çπ0</div>
                <button class="checkout-btn" style="width:auto; padding:10px 25px;" onclick="addCustomizedItem()">Add to Order</button>
            </div>
        </div>
    </div>

    <div class="success-screen" id="success-view">
        <div class="success-icon-container"><i class="fas fa-check"></i></div>
        <h1 style="color:white; margin-bottom:10px;">Order Sent!</h1>
        <p id="success-msg" style="color:#aaa; max-width:250px;">The kitchen has received your order.</p>
        
        <button id="btn-back-floor" class="btn-back-floor" onclick="window.location.href='waiter.html'">
            <i class="fas fa-th-large" style="margin-right:8px;"></i> Back to Floor Map
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9d8Seuez7ihaTSAuPyoCwqjKIR1-VFKg",
            authDomain: "cafe-orders-1afa1.firebaseapp.com",
            databaseURL: "https://cafe-orders-1afa1-default-rtdb.firebaseio.com",
            projectId: "cafe-orders-1afa1",
            messagingSenderId: "274410745480",
            appId: "1:274410745480:web:9964c3914d512aed8d793d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- INIT ---
        const params = new URLSearchParams(window.location.search);
        const TABLE_ID = params.get('table') || "1"; 
        const MODE = params.get('mode') || 'customer';

        document.getElementById('header-table-num').innerText = `Table ${TABLE_ID}`;
        document.getElementById('modal-table-txt').innerText = `Ordering for Table ${TABLE_ID}`;
        
        if(MODE === 'waiter') {
            document.getElementById('waiter-badge').style.display = 'inline';
        }

        // --- SMART SESSION MANAGEMENT (NEW) ---
        // Checks local storage and Firebase to determine if the table session is active
        async function initSession() {
            const savedRaw = localStorage.getItem('ccc_table_user');
            if (!savedRaw) return;

            try {
                const savedData = JSON.parse(savedRaw);
                
                // 1. Check Table ID Match
                // If user is scanning a different table, we should NOT auto-fill
                if (savedData.tableId !== TABLE_ID) {
                    // Mismatch: This is a new session on a different table.
                    // We simply ignore the stored data (effectively cleared for this view)
                    return; 
                }

                // 2. Check Firebase for Active Status (Has the manager settled?)
                // We fetch the active orders list to see if this table is still "occupied"
                const snapshot = await get(ref(db, 'orders'));
                let isActive = false;
                
                if (snapshot.exists()) {
                    const orders = snapshot.val();
                    // Check if any active order belongs to this Table ID
                    isActive = Object.values(orders).some(o => 
                        o.customer && 
                        o.customer.name && 
                        o.customer.name.startsWith(`Table ${TABLE_ID}`)
                    );
                }

                if (isActive) {
                    // Session is Active: Auto-fill and LOCK the fields
                    const nameField = document.getElementById('cust-name');
                    const phoneField = document.getElementById('cust-phone');
                    
                    if (nameField && savedData.name) {
                        nameField.value = savedData.name;
                        nameField.readOnly = true;
                    }
                    if (phoneField && savedData.phone) {
                        phoneField.value = savedData.phone;
                        phoneField.readOnly = true;
                    }
                    console.log("Session restored and locked for Table", TABLE_ID);
                } else {
                    // Session is Inactive (Manager Settled): Clear storage
                    localStorage.removeItem('ccc_table_user');
                    console.log("Previous session settled. Starting fresh.");
                }

            } catch (e) {
                console.error("Error checking session:", e);
            }
        }

        // Run the check immediately
        initSession();

        // --- DATA ---
        let menuData = [];
        let cart = {};
        let selectedItem = null;

        let currentCat = 'All';
        let currentSort = 'default';
        let currentType = 'all';
        let currentIng = 'all';

        onValue(ref(db, 'menu'), (snap) => {
            const data = snap.val();
            menuData = [];
            if(data) {
                Object.keys(data).forEach(key => {
                    const item = data[key];
                    if(item.stockStatus !== 'MANUAL_OFF' && item.inStock !== false) menuData.push(item);
                });
            }
            renderMenu();
        });

        // --- SIDEBAR MANAGEMENT ---
        window.closeAllSidebars = () => {
            document.getElementById('left-sidebar').classList.remove('active');
            document.getElementById('cart-sidebar').classList.remove('active');
            document.querySelector('.sidebar-overlay').classList.remove('active');
        };

        window.toggleSidebar = () => {
            const left = document.getElementById('left-sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            // Close Right Sidebar if open
            document.getElementById('cart-sidebar').classList.remove('active');
            
            if(left.classList.contains('active')) {
                left.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                left.classList.add('active');
                overlay.classList.add('active');
            }
        };

        window.toggleCart = () => {
            const right = document.getElementById('cart-sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            // Close Left Sidebar if open
            document.getElementById('left-sidebar').classList.remove('active');

            if(right.classList.contains('active')) {
                right.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                right.classList.add('active');
                overlay.classList.add('active');
            }
        };

        window.filterCat = (cat, btn) => {
            document.querySelectorAll('.filter-item').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            currentCat = cat;
            window.closeAllSidebars();
            renderMenu();
        }

        window.setSort = (val) => { currentSort = val; renderMenu(); }
        window.setType = (val) => { currentType = val; renderMenu(); }
        window.setIngredient = (val) => { currentIng = val; renderMenu(); }

        window.renderMenu = () => {
            const root = document.getElementById('menu-root');
            root.innerHTML = "";
            const searchVal = document.getElementById('search-input').value.toLowerCase();

            let filtered = menuData.filter(item => {
                if(currentCat !== 'All' && item.category !== currentCat) return false;
                if(currentType === 'veg' && item.type !== 'veg') return false;
                if(currentType === 'non-veg' && item.type !== 'non-veg') return false;
                
                if(currentIng !== 'all') {
                    if(currentIng === 'Panner' && !item.name.toLowerCase().includes('paneer')) return false;
                    else if(currentIng !== 'Panner' && !item.name.toLowerCase().includes(currentIng.toLowerCase())) return false;
                }

                if(searchVal && !item.name.toLowerCase().includes(searchVal)) return false;
                return true;
            });

            if(currentSort === 'low-high') filtered.sort((a,b) => a.price - b.price);
            else if(currentSort === 'high-low') filtered.sort((a,b) => b.price - a.price);

            if(filtered.length === 0) {
                root.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:30px; color:#aaa;">No items match your filters.</div>`;
                return;
            }

            filtered.forEach((item) => {
                const div = document.createElement('div');
                div.className = `food-card ${item.type}`;
                div.innerHTML = `
                    <div class="card-top">
                        <div class="food-title">${item.name}</div>
                        <div class="food-meta">${item.category}</div>
                    </div>
                    <div class="price-row">
                        <div class="price">‚Çπ${item.price}</div>
                        <button class="add-btn-mini" onclick="checkOptions('${item.name}')">ADD +</button>
                    </div>
                `;
                root.appendChild(div);
            });
        }

        // --- CUSTOMIZATION & PACKING LOGIC ---
        window.checkOptions = (itemName) => {
            const item = menuData.find(i => i.name === itemName);
            if(!item) return;
            const options = [];
            const cat = item.category;
            const name = item.name;

            // Existing Customization Logic
            if (["Bun-Tastic Burgers", "Italian Indulgence", "Freshly Folded", "Toasty Treats"].includes(cat)) {
                options.push({ name: "Extra Cheese", price: 15 });
            }
            if (cat === "Bun-Tastic Burgers" && !name.includes("Veg")) {
                 options.push({ name: "Add Fried Egg (Non-Veg)", price: 20 });
            }
            if (cat === "Italian Indulgence") {
                options.push({ name: "Garlic Bread", price: 40 });
            }
            if (cat === "Butcher's Best") {
                options.push({ name: "Tossed Rice", price: 40 });
                options.push({ name: "Boiled Veggies", price: 40 });
                options.push({ name: "Sunny Sideup", price: 25 });
            }
            if (cat === "Whipped Wonders") options.push({ name: "Extra Ice Cream", price: 30 });

            // --- WAITER PACKING ADDITION ---
            if (MODE === 'waiter') {
                let packPrice = 10;
                const fiveRsCats = ["Bun-Tastic Burgers", "Freshly Folded", "Toasty Treats"];
                if (fiveRsCats.includes(cat)) packPrice = 5;
                if (cat === 'ADD-ON') packPrice = name.startsWith("Hummus") ? 7 : 5;
                if (name.includes("Tossed Rice") || name.includes("Sorted / Boiled Vegges")) packPrice = 7;
                
                options.push({ name: "Packing", price: packPrice });
            }
            // ----------------------------------

            // Force open modal if options exist OR if it's an ADD-ON OR if it's a waiter
            if (options.length > 0 || cat === "ADD-ON" || MODE === 'waiter') {
                openCustomization(item, options);
            } else {
                addToCartLogic(item.name, item.price, item.type);
            }
        }

        function openCustomization(item, options) {
            selectedItem = item;
            document.getElementById('cust-title').innerText = item.name;
            document.getElementById('cust-note').value = "";
            const container = document.getElementById('cust-options');
            container.innerHTML = "";
            
            if(options.length === 0) container.innerHTML = "<div style='color:#888; font-size:0.9rem;'>No add-ons available.</div>";
            else {
                options.forEach(opt => {
                    container.innerHTML += `
                        <div class="custom-option-row">
                            <label style="display:flex; align-items:center; cursor:pointer; flex:1;">
                                <input type="checkbox" class="opt-check" data-name="${opt.name}" data-price="${opt.price}" onchange="calcTotal()" style="margin-right:12px; accent-color:var(--primary); transform:scale(1.2);">
                                ${opt.name}
                            </label>
                            <span style="color:var(--primary); font-weight:600;">+‚Çπ${opt.price}</span>
                        </div>`;
                });
            }
            calcTotal();
            document.getElementById('customization-modal').style.display = 'flex';
        }

        window.calcTotal = () => {
            if(!selectedItem) return;
            let total = selectedItem.price;
            document.querySelectorAll('.opt-check:checked').forEach(c => total += parseInt(c.dataset.price));
            document.getElementById('cust-total').innerText = "‚Çπ" + total;
        }

        window.addCustomizedItem = () => {
            if(!selectedItem) return;
            let finalPrice = selectedItem.price;
            let mods = [];
            document.querySelectorAll('.opt-check:checked').forEach(c => {
                finalPrice += parseInt(c.dataset.price);
                mods.push(c.dataset.name);
            });
            const note = document.getElementById('cust-note').value.trim();
            let displayName = selectedItem.name;
            if(mods.length > 0) displayName += ` [${mods.join(', ')}]`;
            if(note) displayName += ` (Note: ${note})`;
            addToCartLogic(displayName, finalPrice, selectedItem.type);
            closeCustomization();
        }

        window.closeCustomization = () => document.getElementById('customization-modal').style.display = 'none';

        function addToCartLogic(name, price, type) {
            if(cart[name]) cart[name].qty++;
            else cart[name] = { price, qty: 1, type };
            renderCart();
            const btn = document.querySelector('.mobile-cart-btn');
            btn.style.transform = "scale(1.1)";
            setTimeout(()=> btn.style.transform = "scale(1)", 200);
        }

        window.updateQty = (name, change) => {
            if(cart[name]) {
                cart[name].qty += change;
                if(cart[name].qty <= 0) delete cart[name];
                renderCart();
            }
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            list.innerHTML = "";
            let total = 0; let count = 0;
            for(let key in cart) {
                const item = cart[key];
                total += item.price * item.qty;
                count += item.qty;
                list.innerHTML += `
                    <div class="cart-item">
                        <div class="cart-details">
                            <span class="cart-name" style="font-weight:600; display:block; color:white; font-size:0.95rem;">${key}</span>
                            <div style="font-size:0.85rem; color:#888;">‚Çπ${item.price} x ${item.qty}</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button class="qty-btn" onclick="updateQty('${key}', -1)">‚àí</button>
                            <span style="font-weight:bold; color:white; min-width:20px; text-align:center;">${item.qty}</span>
                            <button class="qty-btn" onclick="updateQty('${key}', 1)">+</button>
                        </div>
                    </div>`;
            }
            document.getElementById('cart-total').innerText = "‚Çπ" + total;
            document.getElementById('cart-count').innerText = count;
            document.getElementById('btn-checkout').disabled = (count === 0);
            
            if(count === 0) list.innerHTML = "<div style='text-align:center; color:#555; margin-top:50px;'>Your cart is empty</div>";
        }

        window.toggleCart = () => {
            const right = document.getElementById('cart-sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            // Close Left Sidebar if open
            document.getElementById('left-sidebar').classList.remove('active');

            if(right.classList.contains('active')) {
                right.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                right.classList.add('active');
                overlay.classList.add('active');
            }
        };

        window.openCheckout = () => document.getElementById('checkout-modal').style.display = 'flex';
        window.closeCheckout = () => document.getElementById('checkout-modal').style.display = 'none';

        // --- FIX: PLACE ORDER WITH VALIDATION ---
        window.placeOrder = () => {
            const nameInput = document.getElementById('cust-name');
            const phoneInput = document.getElementById('cust-phone');
            
            const nameVal = nameInput.value.trim();
            const phoneVal = phoneInput.value.trim();

            // Strict Validation
            if(nameVal.length < 2) {
                alert("Please enter a valid Guest Name.");
                nameInput.focus();
                return;
            }

            if(phoneVal.length !== 10) {
                alert("Please enter a valid 10-digit Phone Number.");
                phoneInput.focus();
                return;
            }

            // --- SAVE IDENTIY TO STORAGE (NEW) ---
            // Stores user details and lock information (tableId) for this session
            localStorage.setItem('ccc_table_user', JSON.stringify({
                name: nameVal,
                phone: phoneVal,
                tableId: TABLE_ID // Saves the table ID to ensure we only lock for THIS table
            }));

            const finalName = `Table ${TABLE_ID} (${nameVal})`;
            
            let total = 0;
            const items = [];
            for(let key in cart) {
                total += cart[key].price * cart[key].qty;
                items.push({ name: key, qty: cart[key].qty, price: cart[key].price, type: cart[key].type });
            }

            const order = {
                orderId: Math.floor(100000 + Math.random() * 900000),
                orderType: 'Dine-In',
                timestamp: Date.now(),
                status: 'pending',
                customer: { name: finalName, phone: phoneVal, address: 'Dine-In', email: '-' },
                items: items,
                financials: { subTotal: total, discountVal: 0, couponCode: "NONE", packingTotal: 0, grandTotal: total },
                globalNote: `Table ${TABLE_ID} - ${MODE === 'waiter' ? 'Waiter' : 'Customer'}`
            };

            push(ref(db, 'orders'), order).then(() => {
                cart = {}; renderCart(); closeCheckout();
                document.getElementById('cart-sidebar').classList.remove('active');
                
                const succ = document.getElementById('success-view');
                succ.style.display = 'flex';
                
                if(MODE === 'waiter') {
                    document.getElementById('success-msg').innerText = "Returning to Floor Map...";
                    document.getElementById('btn-back-floor').style.display = 'inline-block';
                    setTimeout(() => { window.location.href = "waiter.html"; }, 2000);
                } else {
                    setTimeout(() => { window.location.reload(); }, 3000);
                }
            }).catch(e => { alert("Error: " + e.message); console.error(e); });
        }
    </script>
</body>
</html>
