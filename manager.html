<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Manager POS | Cafe Cloud Club</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1115;
            --surface: #181b21;
            --surface-hover: #22262e;
            --border: #2f3542;
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --swiggy: #fc8019;
            --zomato: #cb202d;
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Inter', sans-serif;
            background: var(--bg); color: var(--text-main); margin: 0; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
        }
        
        /* --- HEADER --- */
        .top-bar {
            flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;
            background: var(--surface); padding: 10px 20px; border-bottom: 1px solid var(--border);
            position: relative;
        }
        .app-title { 
            margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px;
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* CENTERED CLOCK */
        .clock-container {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.4); padding: 5px 15px; border-radius: 8px; border: 1px solid var(--border);
        }
        .clock { font-family: 'JetBrains Mono'; font-size: 1.1rem; font-weight: 700; color: var(--text-main); letter-spacing: 1px;}
        
        .header-actions { display: flex; gap: 10px; }
        .btn-header {
            background: var(--surface-hover); color: var(--text-muted); border: 1px solid var(--border);
            padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; text-decoration: none;
        }
        .btn-swiggy-zomato { background: rgba(252, 128, 25, 0.15); color: #fc8019; border-color: #fc8019; }
        .btn-swiggy-zomato:hover { background: #fc8019; color: white; }

        /* --- LAYOUT --- */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .left-pane { width: 40%; min-width: 400px; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: #121418; }
        .right-pane { flex: 1; background: var(--bg); display: flex; flex-direction: column; overflow-y: auto; padding: 20px; }
        .pane-header { padding: 15px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border); font-weight: 800; color: var(--text-muted); display: flex; justify-content: space-between; }
        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; }

        /* --- CARDS --- */
        .order-card {
            background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
            overflow: hidden; margin-bottom: 15px; border-left: 4px solid var(--border);
            display: flex; flex-direction: column;
        }
        .order-card.status-pending { border-left-color: var(--primary); }
        .order-card.status-cooking { border-left-color: var(--warning); }
        .order-card.status-done { border-left-color: var(--success); }
        .order-card.type-swiggy { border-left-color: var(--swiggy); }
        .order-card.type-zomato { border-left-color: var(--zomato); }

        .card-top { padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        .card-id { font-family: 'JetBrains Mono'; font-weight: 800; color: var(--text-muted); }
        .card-type { font-size: 0.7rem; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1); font-weight: 700; }
        .badge-swiggy { background: var(--swiggy); color: white; }
        .badge-zomato { background: var(--zomato); color: white; }

        .card-body { padding: 12px; }
        .info-grid { display: grid; grid-template-columns: auto 1fr; gap: 5px 10px; margin-bottom: 10px; font-size: 0.9rem; }
        .info-label { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; font-weight:700; }
        
        .items-list { margin: 10px 0; border-top: 1px dashed var(--border); padding-top: 10px; }
        .item-row { display: flex; flex-direction: column; font-size: 0.9rem; margin-bottom: 8px; }
        .item-top { display: flex; justify-content: space-between; }
        .item-qty { color: var(--primary); font-weight: 700; margin-right: 5px; }
        .item-custom { font-size: 0.75rem; color: #888; font-style: italic; margin-left: 20px; margin-top: 2px; }
        .item-void { text-decoration: line-through; opacity: 0.5; }

        .fin-box { background: rgba(0,0,0,0.3); border-radius: 6px; padding: 8px; margin-top: 10px; font-size: 0.85rem; }
        .fin-row { display: flex; justify-content: space-between; margin-bottom: 2px; color: var(--text-muted); }
        .fin-row.total { margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border); color: var(--success); font-weight: 800; font-size: 1rem; }

        .card-actions { padding: 10px; display: flex; gap: 10px; border-top: 1px solid var(--border); }
        .btn-act { flex: 1; padding: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: 700; font-size: 0.8rem; }
        .btn-green { background: var(--success); color: white; }
        .btn-red { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .btn-orange { background: var(--swiggy); color: white; }
        .btn-blue { background: rgba(59, 130, 246, 0.2); color: var(--primary); border: 1px solid var(--primary); }

        /* --- TABLE GRID --- */
        .section-label { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin: 20px 0 10px 0; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .table-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; height: 130px; padding: 15px; cursor: pointer; display:flex; flex-direction:column; justify-content:space-between; position:relative; overflow:hidden;}
        
        .t-num { font-size: 2rem; font-weight: 800; font-family: 'JetBrains Mono'; }
        
        .status-free .t-num { color: #666; } 
        .status-fresh { border: 1px solid var(--success); background: rgba(16, 185, 129, 0.1); }
        .status-fresh .t-num { color: var(--success); }
        .status-warning { border: 1px solid var(--warning); background: rgba(245, 158, 11, 0.1); }
        .status-warning .t-num { color: var(--warning); }
        .status-camper { border: 1px solid var(--danger); background: rgba(239, 68, 68, 0.15); animation: pulseRed 2s infinite; }
        .status-camper .t-num { color: var(--danger); }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 5000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-card { background: var(--surface); width: 450px; max-width: 90%; border-radius: 16px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-header { padding: 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        .btn-modal-cancel { flex: 1; padding: 15px; background: transparent; border: 1px solid var(--border); color: var(--text-muted); border-radius: 8px; cursor: pointer; font-weight: 700; }
        .btn-modal-action { flex: 1; padding: 15px; border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: 700; }
        
        .inp, .inp-select { background: var(--bg); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; width: 100%; margin-bottom: 10px; }
        .row-inputs { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; }

        /* CUSTOM OPTIONS STYLES */
        .auto-options-container {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            border-radius: 8px; padding: 10px; margin-bottom: 10px;
        }
        .opt-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px dashed rgba(255,255,255,0.1); }
        .opt-row:last-child { border-bottom: none; }
        .opt-label { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; cursor: pointer; }
        .opt-price { color: var(--primary); font-family: 'JetBrains Mono'; font-size: 0.85rem; }
        
        .ext-item-row { display: flex; justify-content: space-between; align-items: flex-start; background: rgba(255,255,255,0.05); padding: 8px; margin-bottom: 5px; border-radius: 4px; }
        .ext-item-details { font-size: 0.9rem; }
        .ext-mods { font-size: 0.75rem; color: #aaa; margin-top: 2px; }
    </style>
</head>
<body>

    <div id="pin-overlay" style="position:fixed; inset:0; background:#0f1115; z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <h2 style="color:white;">Manager Access</h2>
        <input type="password" id="pin-input" style="font-size:2rem; text-align:center; padding:10px; width:200px; border-radius:8px; border:1px solid #333; background:#181b21; color:white;" maxlength="4" inputmode="numeric">
        <button onclick="checkPin()" style="margin-top:20px; padding:10px 30px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">UNLOCK</button>
    </div>

    <div class="top-bar">
        <h1 class="app-title"> <img src="og-image.jpg" alt="Logo" style="height: 30px; border-radius: 6px;"> MANAGER DECK </h1>
        
        <div class="clock-container">
            <div class="clock" id="clock">00:00:00</div>
        </div>
        
        <div class="header-actions">
            <button class="btn-header btn-swiggy-zomato" onclick="openExtOrderModal()">+ üõµ Swiggy/Zomato</button>
            <a href="history.html" class="btn-header">History</a>
        </div>
    </div>

    <div class="main-container">
        <div class="left-pane">
            <div class="pane-header"><span>KITCHEN QUEUE</span><span id="online-count" style="color:var(--primary)">0</span></div>
            <div class="scroll-area" id="online-list"></div>
        </div>
        <div class="right-pane">
            <div class="pane-header"><span>DINE-IN MAP</span><span id="dinein-count" style="color:var(--success)">0 Occupied</span></div>
            <div class="section-label">Indoor</div>
            <div class="tables-grid" id="grid-main"></div>
            <div class="section-label">AC Room</div>
            <div class="tables-grid" id="grid-ac"></div>
        </div>
    </div>

    <div class="modal-overlay" id="ext-order-modal">
        <div class="modal-card">
            <div class="modal-header">
                <h3 style="margin:0;">New Third-Party Order</h3>
                <div style="cursor:pointer;" onclick="closeModal('ext-order-modal')">&times;</div>
            </div>
            <div class="modal-body">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <select id="ext-platform" class="inp-select">
                        <option value="Swiggy">Swiggy</option>
                        <option value="Zomato">Zomato</option>
                    </select>
                    <input type="text" id="ext-id" class="inp" placeholder="Order ID (Last 4 digits)">
                </div>

                <div style="border-top:1px solid var(--border); margin:15px 0; padding-top:10px;">
                    <label style="font-size:0.8rem; color:var(--text-muted);">ADD ITEM</label>
                    <select id="ext-menu-select" class="inp-select" onchange="extAutoFill()">
                        <option value="">-- Select Item --</option>
                    </select>
                    
                    <div id="ext-options-container" class="auto-options-container" style="display:none;"></div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <input type="number" id="ext-qty" class="inp" value="1" placeholder="Qty">
                        <button class="btn-modal-action" style="background:var(--primary);" onclick="addExtItem()">ADD +</button>
                    </div>
                </div>

                <div id="ext-items-list" style="max-height:150px; overflow-y:auto; margin-bottom:10px;"></div>
                
                <div class="fin-box">
                    <div class="fin-row"><span>Item Total</span><span id="ext-sub">‚Çπ0</span></div>
                    <div class="fin-row"><span>Packing (Auto)</span><span id="ext-pack">‚Çπ0</span></div>
                    <div class="fin-row total"><span>TOTAL REVENUE</span><span id="ext-grand">‚Çπ0</span></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" onclick="closeModal('ext-order-modal')">Cancel</button>
                <button class="btn-modal-action" style="background:var(--success)" onclick="submitExtOrder()">CONFIRM ORDER</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settle-modal">
        <div class="modal-card">
            <div class="modal-header"><h3 style="margin:0;">Settle Table <span id="m-t-id"></span></h3><div onclick="closeModal('settle-modal')" style="cursor:pointer">&times;</div></div>
            <div class="modal-body">
                <div id="m-i-list"></div>
                <div class="fin-box">
                     <div class="fin-row"><span>Subtotal</span><span id="m-sub">‚Çπ0</span></div>
                     <div class="fin-row"><span>Discount</span><span id="m-disc">‚Çπ0</span></div>
                     <div class="fin-row"><span>Packing</span><span id="m-pack">‚Çπ0</span></div>
                     <div class="fin-row total"><span>TOTAL</span><span id="m-tot">‚Çπ0</span></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" onclick="openEditFromTable()">EDIT ORDER ‚úèÔ∏è</button>
                <button class="btn-modal-action" style="background:var(--success)" onclick="settleAndClear()">PAID & CLEAR</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="edit-modal">
        <div class="modal-card">
            <div class="modal-header">
                <h3 style="margin:0;">Edit Order</h3>
                <div style="cursor:pointer;" onclick="closeModal('edit-modal')">&times;</div>
            </div>
            <div class="modal-body">
                <div style="background:rgba(59, 130, 246, 0.1); padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid var(--primary); display: flex; align-items: center; gap: 10px;">
                    <label style="font-size:0.75rem; color:var(--primary); font-weight:800; white-space: nowrap;">MOVE TABLE:</label>
                    <select id="table-transfer-select" class="inp-select" style="border-color:var(--primary); margin:0;"></select>
                    <button class="btn-modal-action" onclick="saveTableMove()" style="width:auto; padding:8px 15px; background:var(--primary);">GO</button>
                </div>

                <div id="edit-list-container"></div>

                <div style="margin-top:20px; padding-top:10px; border-top:1px solid #333;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <label style="font-size:0.8rem; color:var(--text-muted); font-weight:700;">ADD ITEM</label>
                        <button class="btn-modal-action" style="background:var(--warning); width:auto; padding:4px 10px; font-size:0.7rem;" onclick="addParcelToEdit()">
                            üì¶ Add Packing
                        </button>
                    </div>
                    <div class="row-inputs" style="grid-template-columns: 2fr 1fr 0.8fr auto; gap:5px;">
                        <select id="menu-select" class="inp-select" style="margin:0;" onchange="autoFillPrice()">
                            <option value="">-- Select --</option>
                        </select>
                        <input type="number" id="new-item-price" class="inp" style="margin:0;" placeholder="‚Çπ">
                        <input type="number" id="new-item-qty" class="inp" style="margin:0;" value="1">
                        <button class="btn-modal-action" style="background:var(--primary); width:auto; padding:0 15px;" onclick="addNewItemToOrder()">+</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" onclick="closeModal('edit-modal')">Done</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, remove, push, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9d8Seuez7ihaTSAuPyoCwqjKIR1-VFKg",
            authDomain: "cafe-orders-1afa1.firebaseapp.com",
            databaseURL: "https://cafe-orders-1afa1-default-rtdb.firebaseio.com",
            projectId: "cafe-orders-1afa1",
            messagingSenderId: "274410745480",
            appId: "1:274410745480:web:9964c3914d512aed8d793d"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const bell = new Audio('bell.mp3');
        bell.loop = true;

        // --- GLOBAL VARIABLES ---
        let fullMenu = [];
        let extOrderItems = []; 
        let tableData = {};
        let currentSettleTable = null;
        let currentEditKey = null;

        // --- CLOCK FUNCTION ---
        function startClock() {
            const update = () => {
                const now = new Date();
                document.getElementById('clock').innerText = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            };
            setInterval(update, 1000);
            update();
        }
        startClock();

        // --- AUTH ---
        window.checkPin = () => {
            if(document.getElementById('pin-input').value === '2024') {
                document.getElementById('pin-overlay').style.display = 'none';
                bell.play().then(() => { bell.pause(); bell.currentTime = 0; }).catch(e => {});
                init();
            } else alert("Wrong PIN");
        };

        // --- LOGIC: Customization Rules (Replicated from app.js) ---
        const cheeseCats = ["Bun-Tastic Burgers", "Italian Indulgence", "Freshly Folded", "Toasty Treats"];
        const fiveRsCats = ["Bun-Tastic Burgers", "Freshly Folded", "Toasty Treats"];
        const friedEggEligible = [
            "Chicken Slider Burger - Pesto", "Chicken Slider Burger - Tandoori", "Cloud Special Chicken Burger",
            "Egg Burger", "Pesto Chicken Burger", "Tandoori Burger Chicken", "Tandoori Special Chicken Burger",
            "Tropical Beef Burger", "Tropical Pesto Chicken Burger", "Tropical Tandoori Chicken Burger",
            "Classic Beef Burger", "Double Decker Beef Burger"
        ];

        function getOptionsForItem(item) {
            let opts = [];
            
            // 1. Extra Cheese
            if (cheeseCats.includes(item.category)) opts.push({ name: "Extra Cheese", price: 15 });
            
            // 2. Fried Egg
            if (item.category === "Bun-Tastic Burgers" && friedEggEligible.includes(item.name)) {
                opts.push({ name: "Add Fried Egg", price: 20 });
            }

            // 3. Italian Extras
            if (item.category === "Italian Indulgence") {
                opts.push({ name: "Garlic Bread", price: 40 });
                if (item.name.toLowerCase().includes('chicken')) opts.push({ name: "Extra Chicken", price: 60 });
                if (item.name.toLowerCase().includes('shrimp')) opts.push({ name: "Extra Shrimp", price: 90 });
            }

            // 4. Butcher's Best
            if (item.category === "Butcher's Best") {
                opts.push({ name: "Extra Hashbrown", price: 40 });
                opts.push({ name: "Tossed Rice", price: 40 });
                opts.push({ name: "Sorted Vegges", price: 40 });
                opts.push({ name: "Sunny Sideup", price: 25 });
                if (!item.name.toLowerCase().includes('fish')) opts.push({ name: "Hummus", price: 40 });
            }

            // 5. Rice Harmony
            if (item.category === "Rice Harmony") {
                if (item.name.toLowerCase().includes('chicken')) opts.push({ name: "Extra Chicken", price: 40 });
                if (item.type === 'veg') opts.push({ name: "Extra Paneer", price: 30 });
            }

            // 6. Shakes
            if (item.category === "Whipped Wonders") opts.push({ name: "Extra Ice Cream", price: 30 });

            return opts;
        }

        // --- INITIALIZATION ---
        function init() {
            // Load Menu
            onValue(ref(db, 'menu'), snap => {
                const data = snap.val() || {};
                fullMenu = Object.values(data).sort((a,b) => a.name.localeCompare(b.name));
                
                const sel = document.getElementById('ext-menu-select');
                const standardSel = document.getElementById('menu-select');
                sel.innerHTML = '<option value="">-- Select Item --</option>';
                standardSel.innerHTML = '<option value="">-- Select Item --</option>';

                fullMenu.forEach((item, idx) => {
                    // Populate EXT modal (store Index to lookup later)
                    const opt = document.createElement('option');
                    opt.value = idx; 
                    opt.text = item.name;
                    sel.appendChild(opt);

                    // Populate EDIT modal (store Name)
                    const stdOpt = document.createElement('option');
                    stdOpt.value = item.name;
                    stdOpt.dataset.price = item.price;
                    stdOpt.text = item.name;
                    standardSel.appendChild(stdOpt);
                });
            });

            // Load Orders
            onValue(ref(db, 'orders'), snap => {
                const data = snap.val() || {};
                const list = document.getElementById('online-list');
                list.innerHTML = "";
                tableData = {};
                let pending = false;
                let count = 0;

                Object.entries(data).forEach(([key, order]) => {
                    if(order.status === 'completed' || order.status === 'rejected') return;
                    
                    // Sound Trigger
                    if(order.status === 'pending') pending = true;

                    // Table Data Logic
                    if(order.orderType === 'Dine-In' && order.customer && order.customer.name.startsWith('Table')) {
                        const tId = order.customer.name.split(' ')[1];
                        if(!tableData[tId]) tableData[tId] = { 
                            total:0, items:[], keys:[], timestamp: order.timestamp,
                            fins: { sub:0, disc:0, pack:0 } 
                        };
                        
                        const f = order.financials || {grandTotal:0, subTotal:0, discountVal:0, packingTotal:0};
                        tableData[tId].total += (f.grandTotal || 0);
                        tableData[tId].fins.sub += (f.subTotal || 0);
                        tableData[tId].fins.disc += (f.discountVal || 0);
                        tableData[tId].fins.pack += (f.packingTotal || 0);
                        
                        // Keep oldest timestamp for timer
                        if(order.timestamp < tableData[tId].timestamp) tableData[tId].timestamp = order.timestamp;
                        
                        tableData[tId].items.push(...(order.items||[]));
                        tableData[tId].keys.push(key);
                    } 
                    
                    // Render Queue Card (Everything except served Dine-in)
                    let showInQueue = true;
                    if (order.status === 'served') showInQueue = false;
                    if (order.status === 'done' && order.orderType === 'Dine-In') showInQueue = false;

                    if(showInQueue) {
                        count++;
                        renderOrderCard(key, order, list);
                    }
                });

                document.getElementById('online-count').innerText = count;
                renderTables();
                
                if(pending) {
                    if(bell.paused) bell.play().catch(e => console.log("Sound blocked"));
                } else {
                    bell.pause(); bell.currentTime = 0;
                }
            });
        }

        // --- EXTERNAL ORDER MODAL FUNCTIONS ---
        window.openExtOrderModal = () => {
            document.getElementById('ext-order-modal').style.display = 'flex';
            extOrderItems = [];
            document.getElementById('ext-id').value = "";
            renderExtList();
        };

        window.extAutoFill = () => {
            const idx = document.getElementById('ext-menu-select').value;
            const container = document.getElementById('ext-options-container');
            container.innerHTML = "";
            container.style.display = "none";

            if(idx === "") return;
            
            const item = fullMenu[idx];
            const options = getOptionsForItem(item);

            if(options.length > 0) {
                container.style.display = "block";
                options.forEach(opt => {
                    container.innerHTML += `
                        <div class="opt-row">
                            <label class="opt-label">
                                <input type="checkbox" class="ext-opt-cb" value="${opt.name}" data-price="${opt.price}">
                                ${opt.name}
                            </label>
                            <span class="opt-price">+‚Çπ${opt.price}</span>
                        </div>
                    `;
                });
            }
        };

        window.addExtItem = () => {
            const idx = document.getElementById('ext-menu-select').value;
            if(idx === "") return;
            const item = fullMenu[idx];
            const qty = parseInt(document.getElementById('ext-qty').value) || 1;

            // Calculate Base + Mods
            let finalPrice = item.price;
            let modNames = [];
            
            document.querySelectorAll('.ext-opt-cb:checked').forEach(cb => {
                finalPrice += parseInt(cb.dataset.price);
                modNames.push(cb.value);
            });

            // Calculate Packing (Same logic as app.js)
            let packCost = 10;
            if (item.category === 'ADD-ON') packCost = item.name.startsWith("Hummus") ? 7 : 5;
            else if (fiveRsCats.includes(item.category)) packCost = 5;
            // Extra packing logic for specific addons
            if (modNames.includes("Tossed Rice") || modNames.includes("Sorted Vegges")) packCost += 7;

            extOrderItems.push({
                name: item.name,
                category: item.category,
                price: finalPrice, // Unit Price including mods
                basePrice: item.price,
                qty: qty,
                variant: modNames.join(", "),
                packingInfo: packCost // Store unit packing cost
            });

            renderExtList();
            
            // Reset UI
            document.getElementById('ext-menu-select').value = "";
            document.getElementById('ext-qty').value = "1";
            document.getElementById('ext-options-container').innerHTML = "";
            document.getElementById('ext-options-container').style.display = "none";
        };

        function renderExtList() {
            const list = document.getElementById('ext-items-list');
            list.innerHTML = "";
            let itemTotal = 0;
            let packTotal = 0;

            extOrderItems.forEach((item, i) => {
                const rowTotal = item.price * item.qty;
                const rowPack = item.packingInfo * item.qty;
                itemTotal += rowTotal;
                packTotal += rowPack;

                let desc = item.variant ? `<div class="ext-mods">${item.variant}</div>` : '';

                list.innerHTML += `
                    <div class="ext-item-row">
                        <div class="ext-item-details">
                            <b>${item.qty}x ${item.name}</b>
                            ${desc}
                        </div>
                        <div style="text-align:right">
                            <div style="font-weight:bold">‚Çπ${rowTotal}</div>
                            <div style="font-size:0.7rem; color:#888;">+Pack ‚Çπ${rowPack}</div>
                            <button style="color:red;border:none;background:none;cursor:pointer;margin-top:5px;" onclick="remExt(${i})">REMOVE</button>
                        </div>
                    </div>
                `;
            });

            document.getElementById('ext-sub').innerText = `‚Çπ${itemTotal}`;
            document.getElementById('ext-pack').innerText = `‚Çπ${packTotal}`;
            document.getElementById('ext-grand').innerText = `‚Çπ${itemTotal + packTotal}`;
        }

        window.remExt = (i) => { extOrderItems.splice(i,1); renderExtList(); };

        window.submitExtOrder = () => {
            const pid = document.getElementById('ext-id').value;
            if(!pid || extOrderItems.length === 0) return alert("Missing ID or Items");
            const plat = document.getElementById('ext-platform').value;

            // Calculate totals from the items list
            let sub = 0; let pack = 0;
            extOrderItems.forEach(i => {
                sub += (i.price * i.qty);
                pack += (i.packingInfo * i.qty);
            });

            const order = {
                orderId: pid, orderType: plat, timestamp: Date.now(), status: 'cooking',
                customer: { name: `${plat} #${pid}`, phone:'-', address:'Pickup' },
                items: extOrderItems,
                financials: { subTotal: sub, discountVal: 0, packingTotal: pack, grandTotal: sub + pack }
            };

            push(ref(db, 'orders'), order).then(() => closeModal('ext-order-modal'));
        };

        // --- RENDER FUNCTIONS (Standard) ---
        function renderOrderCard(key, order, container) {
            const type = order.orderType;
            let cls = `order-card status-${order.status}`;
            if(type==='Swiggy') cls += ' type-swiggy';
            if(type==='Zomato') cls += ' type-zomato';

            let itemsHtml = (order.items||[]).map(i => {
                if(i.deleted) return `<div class="item-row item-void"><span>${i.qty}x ${i.name}</span><span>VOID</span></div>`;
                let v = i.variant ? `<div class="item-custom">${i.variant}</div>` : '';
                return `<div class="item-row"><div class="item-top"><span><span class="item-qty">${i.qty}x</span>${i.name}</span></div>${v}</div>`;
            }).join('');

            let showEdit = (order.status !== 'done' && order.status !== 'out_for_delivery');
            
            let btns = '';
            if(order.status==='pending') btns = `<button class="btn-act btn-red" onclick="rejectOrder('${key}')">REJECT</button><button class="btn-act btn-green" onclick="upd('${key}','cooking')">ACCEPT</button>`;
            else if(order.status==='cooking') btns = `<button class="btn-act btn-green" onclick="upd('${key}','done')">READY</button>`;
            else if(order.status==='done') {
                if(type === 'Delivery') btns = `<button class="btn-act btn-red" disabled>WAIT DRIVER</button>`;
                else btns = `<button class="btn-act btn-orange" onclick="comp('${key}')">PICKED UP</button>`;
            } 
            else if(order.status==='out_for_delivery') btns = `<button class="btn-act btn-red" onclick="forceComplete('${key}')">COMPLETE</button>`;

            container.innerHTML += `
                <div class="${cls}">
                    <div class="card-top"><span class="card-id">#${order.orderId}</span><span class="card-type ${type==='Swiggy'?'badge-swiggy':(type==='Zomato'?'badge-zomato':'')}">${type}</span></div>
                    <div class="card-body">
                        <div class="info-grid"><span class="info-label">Info</span><span>${order.customer.name}</span></div>
                        <div class="items-list">${itemsHtml}</div>
                    </div>
                    <div class="card-actions">
                         ${showEdit ? `<button class="btn-act btn-blue" style="flex:0.3" onclick="openEditModal('${key}')">EDIT</button>` : ''}
                        ${btns}
                    </div>
                </div>
            `;
        }

        function renderTables() {
            const m = document.getElementById('grid-main');
            const a = document.getElementById('grid-ac');
            m.innerHTML=""; a.innerHTML="";
            document.getElementById('dinein-count').innerText = Object.keys(tableData).length;

            const make = (id, dest, label) => {
                const d = tableData[id];
                let cls = 'table-card status-free';
                let txt = `<div class="t-num">${label || id}</div><div style="color:#666;font-size:0.8rem">Free</div>`;
                
                if(d) {
                    const diff = Date.now() - d.timestamp;
                    const mins = Math.floor(diff/60000);
                    if(mins < 60) cls = 'table-card status-fresh';
                    else if(mins < 90) cls = 'table-card status-warning';
                    else cls = 'table-card status-camper';
                    
                    const h = Math.floor(mins/60);
                    const tm = mins%60;
                    const timeStr = `${h}:${tm.toString().padStart(2,'0')}`;

                    txt = `
                        <div style="display:flex;justify-content:space-between"><div class="t-num">${label || id}</div><div style="font-weight:bold;color:#aaa">‚Çπ${d.total}</div></div>
                        <div style="text-align:center; font-family:'JetBrains Mono'; font-size:1.4rem; font-weight:bold; margin-top:10px;">${timeStr}</div>
                        <div style="text-align:center; font-size:0.7rem; font-weight:bold; opacity:0.7;">OCCUPIED</div>
                    `;
                }
                const div = document.createElement('div');
                div.className = cls;
                div.innerHTML = txt;
                if(d) div.onclick = () => { currentSettleTable=id; document.getElementById('settle-modal').style.display='flex'; renderSettle(); };
                dest.appendChild(div);
            };

            for(let i=1; i<=7; i++) make(i, m);
            make(8, m, "BAR");
            for(let i=9; i<=13; i++) make(i, a);
        }

        function renderSettle() {
            const d = tableData[currentSettleTable];
            document.getElementById('m-t-id').innerText = currentSettleTable;
            document.getElementById('m-i-list').innerHTML = d.items.map(i => `<div style="display:flex;justify-content:space-between;margin-bottom:5px;color:#aaa"><span>${i.qty}x ${i.name}</span><span>‚Çπ${i.price*i.qty}</span></div>`).join('');
            
            document.getElementById('m-sub').innerText = `‚Çπ${d.fins.sub}`;
            document.getElementById('m-disc').innerText = `-‚Çπ${d.fins.disc}`;
            document.getElementById('m-pack').innerText = `‚Çπ${d.fins.pack}`;
            document.getElementById('m-tot').innerText = `‚Çπ${d.total}`;
        }

        window.settleAndClear = async () => {
            const d = tableData[currentSettleTable];
            const master = {
                orderId: Math.floor(100000 + Math.random() * 900000),
                orderType: 'Dine-In', timestamp: Date.now(), status: 'paid',
                customer: { name: `Table ${currentSettleTable}`, phone:'-', address:'Dine-In' },
                items: d.items, financials: { grandTotal: d.total }
            };
            await push(ref(db, 'history'), master);
            for(const k of d.keys) await remove(ref(db, `orders/${k}`));
            closeModal('settle-modal');
        };

        window.autoFillPrice = () => {
            const select = document.getElementById('menu-select');
            const priceInput = document.getElementById('new-item-price');
            const selectedOpt = select.options[select.selectedIndex];
            if(selectedOpt && selectedOpt.dataset.price) priceInput.value = selectedOpt.dataset.price;
        }

        window.openEditFromTable = () => {
            if(!currentSettleTable || !tableData[currentSettleTable]) return;
            const keys = tableData[currentSettleTable].keys;
            if(keys.length > 0) {
                closeModal('settle-modal');
                openEditModal(keys[keys.length - 1]);
            }
        }

        window.openEditModal = async (key) => {
            currentEditKey = key;
            document.getElementById('edit-modal').style.display = 'flex';
            const snap = await get(ref(db, 'orders/' + key));
            if(snap.exists()) {
                const order = snap.val();
                const sel = document.getElementById('table-transfer-select');
                sel.innerHTML = "";
                let currentTableId = "";
                if (order.customer && order.customer.name && order.customer.name.startsWith("Table")) {
                    currentTableId = order.customer.name.split(" ")[1];
                }
                for(let i=1; i<=13; i++) {
                    const opt = document.createElement('option');
                    opt.value = i; opt.text = (i===8)?"Table 8 (BAR)":`Table ${i}`;
                    if(i.toString() === currentTableId) opt.selected = true;
                    sel.appendChild(opt);
                }
                renderEditList(order.items || []);
            }
        }

        function renderEditList(items) {
            const container = document.getElementById('edit-list-container');
            container.innerHTML = "";
            items.forEach((item, index) => {
                const isDel = item.deleted ? 'opacity:0.5; text-decoration:line-through;' : '';
                container.innerHTML += `
                    <div class="edit-row" style="display:flex; justify-content:space-between; margin-bottom:5px; ${isDel}">
                        <div>${item.qty}x ${item.name}</div>
                        <button style="color:red; background:none; border:none; cursor:pointer;" onclick="deleteItem(${index})">üóë</button>
                    </div>`;
            });
        }

        // --- NEW FUNCTION: ADD PARCEL TO EDIT ---
        window.addParcelToEdit = async () => {
            const packingItem = fullMenu.find(i => 
                i.name.toLowerCase().includes("packing") || 
                i.name.toLowerCase().includes("parcel")
            );

            if (!packingItem) {
                alert("‚ùå Error: 'Packing Charge' item not found in Menu.\nPlease add an item named 'Packing Charge' in Admin.");
                return;
            }

            document.getElementById('menu-select').value = packingItem.name;
            document.getElementById('new-item-price').value = packingItem.price;
            document.getElementById('new-item-qty').value = 1;
            
            await addNewItemToOrder();
        };

        window.addNewItemToOrder = async () => {
            const select = document.getElementById('menu-select');
            const name = select.value; 
            const price = parseFloat(document.getElementById('new-item-price').value);
            const qty = parseInt(document.getElementById('new-item-qty').value);
            
            if(!name || isNaN(price)) return;
            const snap = await get(ref(db, 'orders/' + currentEditKey));
            let order = snap.val();
            let items = order.items || [];
            items.push({ name, price, qty, kitchenDone: false });
            
            updateOrderFinancials(order, items);
            await update(ref(db, 'orders/' + currentEditKey), order);
            renderEditList(items);
        }

        window.deleteItem = async (index) => {
            const snap = await get(ref(db, 'orders/' + currentEditKey));
            let order = snap.val();
            if(order.items[index]) {
                order.items[index].deleted = true;
                updateOrderFinancials(order, order.items);
                await update(ref(db, 'orders/' + currentEditKey), order);
                renderEditList(order.items);
            }
        }

        window.saveTableMove = async () => {
            const newTableId = document.getElementById('table-transfer-select').value;
            await update(ref(db, 'orders/' + currentEditKey + '/customer'), { name: `Table ${newTableId}` });
            closeModal('edit-modal');
        }

        function updateOrderFinancials(order, items) {
            order.items = items;
            let sub = 0; let pack = 0;
            const fiveRsCats = ["Bun-Tastic Burgers", "Freshly Folded", "Toasty Treats"];
            items.forEach(i => {
                if(i.deleted) return;
                sub += (i.price * i.qty);
                // Simple packing logic for demo
                pack += (5 * i.qty); 
            });
            order.financials = { subTotal: sub, discountVal: 0, packingTotal: pack, grandTotal: sub + pack };
        }

        window.upd = (k,s) => update(ref(db, `orders/${k}`), {status:s});
        window.rejectOrder = (k) => remove(ref(db, `orders/${k}`));
        window.comp = (k) => {
            get(ref(db, `orders/${k}`)).then(s => {
                if(s.exists()) {
                    let d = s.val(); d.status='completed'; d.completedAt=Date.now();
                    push(ref(db, 'history'), d);
                    remove(ref(db, `orders/${k}`));
                }
            });
        };

        window.forceComplete = (k) => { if(confirm("Force Complete?")) window.comp(k); };
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.remExt = remExt;
    </script>
</body>
</html>
