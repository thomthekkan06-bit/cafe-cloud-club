<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Manager POS | Cafe Cloud Club</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1115;
            --surface: #181b21;
            --surface-hover: #22262e;
            --border: #2f3542;
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --purple: #8b5cf6;
            --swiggy: #fc8019; /* Swiggy Orange */
            --zomato: #cb202d; /* Zomato Red */
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Inter', sans-serif;
            background: var(--bg); 
            color: var(--text-main); 
            margin: 0; 
            height: 100vh; 
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }
        
        /* --- HEADER --- */
        .top-bar {
            flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
            background: var(--surface); padding: 10px 20px; 
            border-bottom: 1px solid var(--border); z-index: 10;
        }
        .app-title { 
            margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px;
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .clock { font-family: 'JetBrains Mono'; font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
        
        .header-actions { display: flex; gap: 10px; }
        .btn-header {
            background: var(--surface-hover); color: var(--text-muted); border: 1px solid var(--border);
            padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; text-decoration: none;
            display: flex; align-items: center; gap: 6px;
        }
        .btn-header:hover { background: var(--border); color: white; }
        .btn-swiggy-zomato { background: rgba(252, 128, 25, 0.15); color: #fc8019; border-color: #fc8019; }
        .btn-swiggy-zomato:hover { background: #fc8019; color: white; }

        /* --- SPLIT LAYOUT --- */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* LEFT SIDE: KITCHEN QUEUE */
        .left-pane {
            width: 40%;
            min-width: 400px; 
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            background: #121418;
        }
        .pane-header {
            padding: 15px; background: rgba(0,0,0,0.2); 
            border-bottom: 1px solid var(--border); font-weight: 800; letter-spacing: 1px; color: var(--text-muted);
            display: flex; justify-content: space-between;
        }
        .scroll-area {
            flex: 1; overflow-y: auto; padding: 15px;
        }

        /* RIGHT SIDE: TABLE MAP */
        .right-pane {
            flex: 1;
            background: var(--bg);
            display: flex; flex-direction: column;
            overflow-y: auto;
            padding: 20px;
        }

        /* --- ORDER CARDS --- */
        .order-card {
            background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
            overflow: hidden; margin-bottom: 15px;
            border-left: 4px solid var(--border);
            display: flex; flex-direction: column;
        }
        .order-card.status-pending { border-left-color: var(--primary); }
        .order-card.status-cooking { border-left-color: var(--warning); }
        .order-card.status-done { border-left-color: var(--success); }
        
        /* Platform Colors */
        .order-card.type-swiggy { border-left-color: var(--swiggy); }
        .order-card.type-zomato { border-left-color: var(--zomato); }

        .card-top { 
            padding: 10px 12px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); 
        }
        .card-id { font-family: 'JetBrains Mono'; font-weight: 800; color: var(--text-muted); }
        .card-type { font-size: 0.7rem; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1); font-weight: 700; }
        
        /* Specific Badges */
        .badge-swiggy { background: var(--swiggy); color: white; }
        .badge-zomato { background: var(--zomato); color: white; }

        .card-body { padding: 12px; }
        
        /* Customer Info */
        .info-grid { display: grid; grid-template-columns: auto 1fr; gap: 5px 10px; margin-bottom: 10px; font-size: 0.9rem; }
        .info-label { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; align-self: center; font-weight:700; }
        .info-val { font-weight: 500; color: #fff; }

        /* Items Section */
        .items-list { margin: 10px 0; border-top: 1px dashed var(--border); padding-top: 10px; }
        .item-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px; }
        .item-qty { color: var(--primary); font-weight: 700; margin-right: 5px; }
        .item-price { font-family: 'JetBrains Mono'; color: var(--text-muted); }
        .item-void { text-decoration: line-through; color: var(--danger); opacity: 0.7; }

        /* Financials Section */
        .fin-box { 
            background: rgba(0,0,0,0.3); border-radius: 6px; padding: 8px; margin-top: 10px; 
            font-size: 0.85rem; 
        }
        .fin-row { display: flex; justify-content: space-between; margin-bottom: 2px; color: var(--text-muted); }
        .fin-row.total { 
            margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border); 
            color: var(--success); font-weight: 800; font-size: 1rem;
        }

        .card-actions { 
            padding: 10px; display: flex; gap: 10px; border-top: 1px solid var(--border); 
        }
        .btn-act { 
            flex: 1; padding: 10px; border-radius: 6px; border: none; cursor: pointer; 
            font-weight: 700; font-size: 0.8rem; transition: opacity 0.2s;
        }
        .btn-act:hover { opacity: 0.9; }
        .btn-green { background: var(--success); color: white; }
        .btn-red { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .btn-blue { background: rgba(59, 130, 246, 0.2); color: var(--primary); border: 1px solid var(--primary); }
        .btn-orange { background: var(--swiggy); color: white; }

        /* --- TABLE GRID --- */
        .section-label { 
            font-size: 0.8rem; font-weight: 700; color: var(--text-muted); 
            text-transform: uppercase; margin: 20px 0 10px 0; border-bottom: 1px solid var(--border); padding-bottom: 5px; 
        }
        .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }

        .table-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; height: 130px;
            display: flex; flex-direction: column; justify-content: space-between; padding: 15px;
            cursor: pointer; transition: 0.2s; position: relative; overflow: hidden;
        }
        .table-card:active { transform: scale(0.95); }
        
        .t-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .t-num { font-size: 2rem; font-weight: 800; font-family: 'JetBrains Mono'; color: #555; transition: color 0.3s; }
        .t-bill { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 6px; }
        .t-timer { font-size: 1.4rem; font-weight: 700; font-family: 'JetBrains Mono'; text-align: center; margin: 5px 0; }
        .t-status { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; text-align: center; opacity: 0.8; }

        /* TABLE STATES */
        .status-free { opacity: 1; border-color: #333; }
        .status-free .t-num { color: #666; }
        .status-free .t-timer, .status-free .t-bill { display: none; }
        .status-free .t-status { color: #555; }

        .status-fresh { border: 1px solid var(--success); background: rgba(16, 185, 129, 0.1); }
        .status-fresh .t-num, .status-fresh .t-timer, .status-fresh .t-bill, .status-fresh .t-status { color: var(--success); }
        .status-warning { border: 1px solid var(--warning); background: rgba(245, 158, 11, 0.1); }
        .status-warning .t-num, .status-warning .t-timer, .status-warning .t-bill, .status-warning .t-status { color: var(--warning); }
        .status-camper { border: 1px solid var(--danger); background: rgba(239, 68, 68, 0.15); animation: pulseRed 2s infinite; }
        .status-camper .t-num, .status-camper .t-timer, .status-camper .t-bill, .status-camper .t-status { color: var(--danger); }
        
        .is-bar { border-style: dashed; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 5000; display: none;
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-card {
            background: var(--surface); width: 450px; max-width: 90%;
            border-radius: 16px; border: 1px solid var(--border); 
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-header { padding: 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        
        .btn-modal-cancel { flex: 1; padding: 15px; background: transparent; border: 1px solid var(--border); color: var(--text-muted); border-radius: 8px; cursor: pointer; font-weight: 700; }
        .btn-modal-action { flex: 1; padding: 15px; border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: 700; }
        
        /* GENERAL MODAL INPUTS */
        .inp, .inp-select { background: var(--bg); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; width: 100%; margin-bottom: 10px; }
        .row-inputs { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; }
        .add-row-btn { width:100%; padding:10px; background:var(--surface-hover); border:1px dashed var(--border); color:var(--text-muted); cursor:pointer; }
        
        /* PIN LOCK */
        #pin-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 17, 21, 0.98); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-input { background: var(--bg); border: 1px solid var(--border); color: white; font-size: 2rem; text-align: center; letter-spacing: 10px; padding: 10px; border-radius: 8px; width: 200px; margin: 20px 0; outline: none; }
        
        /* EXT ORDER ITEM */
        .ext-item-row { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 8px; margin-bottom: 5px; border-radius: 4px; }
        .btn-sm-del { color: var(--danger); background: none; border: none; cursor: pointer; font-size: 1.1rem; }
    </style>
</head>
<body>

    <div id="pin-overlay">
        <h2 style="color:white;">Manager Access</h2>
        <input type="password" id="pin-input" class="pin-input" maxlength="4" inputmode="numeric">
        <button onclick="checkPin()" style="background:var(--primary); border:none; padding:10px 30px; border-radius:6px; color:white; font-weight:bold; cursor:pointer;">UNLOCK</button>
    </div>

    <div class="top-bar">
        <h1 class="app-title"> <img src="og-image.jpg" alt="Logo" style="height: 30px; border-radius: 6px;"> MANAGER DECK </h1>
        
        <div class="header-actions">
            <div class="clock" id="clock">00:00</div>
            <button class="btn-header btn-swiggy-zomato" onclick="openExtOrderModal()">
                + üõµ Swiggy/Zomato
            </button>
            <a href="history.html" class="btn-header">Sales History</a>
        </div>
    </div>

    <div class="main-container">
        <div class="left-pane">
            <div class="pane-header">
                <span>KITCHEN QUEUE</span>
                <span id="online-count" style="color:var(--primary)">0</span>
            </div>
            <div class="scroll-area" id="online-list">
                </div>
        </div>

        <div class="right-pane">
            <div class="pane-header" style="background:transparent; border:none; padding-left:0;">
                <span>FLOOR MAP (DINE-IN)</span>
                <span id="dinein-count" style="color:var(--success)">0 Occupied</span>
            </div>

            <div class="section-label">Indoor Dining (1-7 + Bar)</div>
            <div class="tables-grid" id="grid-main"></div>

            <div class="section-label">Indoor AC (9-13)</div>
            <div class="tables-grid" id="grid-ac"></div>
        </div>
    </div>

    <div class="modal-overlay" id="settle-modal">
        <div class="modal-card">
            <div class="modal-header">
                <h3 style="margin:0;">Settle Table <span id="modal-table-id"></span></h3>
                <div style="cursor:pointer;" onclick="closeModal('settle-modal')">&times;</div>
            </div>
            <div class="modal-body">
                <div id="modal-items-list"></div>
                <div class="fin-box">
                     <div class="fin-row"><span>Subtotal</span><span id="m-sub">‚Çπ0</span></div>
                     <div class="fin-row"><span>Discount</span><span id="m-disc">‚Çπ0</span></div>
                     <div class="fin-row"><span>Packing</span><span id="m-pack">‚Çπ0</span></div>
                     <div class="fin-row total"><span>TOTAL PAYABLE</span><span id="m-total">‚Çπ0</span></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" onclick="openEditFromTable()">EDIT ORDER ‚úèÔ∏è</button>
                <button class="btn-modal-action" style="background:var(--success)" onclick="settleAndClear()">PAID & CLEAR ‚úÖ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="ext-order-modal">
        <div class="modal-card">
            <div class="modal-header">
                <h3 style="margin:0;">New Third-Party Order</h3>
                <div style="cursor:pointer;" onclick="closeModal('ext-order-modal')">&times;</div>
            </div>
            <div class="modal-body">
                <label style="font-size:0.8rem; color:var(--text-muted);">PLATFORM</label>
                <select id="ext-platform" class="inp-select">
                    <option value="Swiggy">Swiggy</option>
                    <option value="Zomato">Zomato</option>
                </select>

                <label style="font-size:0.8rem; color:var(--text-muted);">ORDER ID (Last 4 Digits)</label>
                <input type="text" id="ext-id" class="inp" placeholder="e.g. 4092">

                <div style="border-top:1px solid var(--border); margin:15px 0; padding-top:10px;">
                    <label style="font-size:0.8rem; color:var(--text-muted);">ADD ITEMS</label>
                    <div class="row-inputs">
                        <select id="ext-menu-select" class="inp-select" onchange="extAutoFill()">
                            <option value="">-- Select Item --</option>
                        </select>
                        <input type="number" id="ext-price" class="inp" placeholder="Price">
                    </div>
                    <div class="row-inputs" style="grid-template-columns: 1fr 1fr;">
                        <input type="number" id="ext-qty" class="inp" value="1" placeholder="Qty">
                        <button class="btn-modal-action" style="background:var(--primary); height:42px;" onclick="addExtItem()">ADD +</button>
                    </div>
                </div>

                <div id="ext-items-list" style="max-height:150px; overflow-y:auto; margin-bottom:10px;"></div>
                <div style="text-align:right; font-weight:bold; color:var(--success);">Total: <span id="ext-total-display">‚Çπ0</span></div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" onclick="closeModal('ext-order-modal')">Cancel</button>
                <button class="btn-modal-action" style="background:var(--success)" onclick="submitExtOrder()">CONFIRM & PRINT</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="edit-modal">
        <div class="modal-card">
            <div class="modal-header">
                <h3 style="margin:0;">Edit Order</h3>
                <div style="cursor:pointer;" onclick="closeModal('edit-modal')">&times;</div>
            </div>
            <div class="modal-body">
                <div style="background:rgba(59, 130, 246, 0.1); padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid var(--primary); display: flex; align-items: center; gap: 10px;">
                    <label style="font-size:0.75rem; color:var(--primary); font-weight:800; white-space: nowrap;">MOVE TABLE:</label>
                    <select id="table-transfer-select" class="inp-select" style="border-color:var(--primary); margin:0;"></select>
                    <button class="btn-modal-action" onclick="saveTableMove()" style="width:auto; padding:8px 15px; background:var(--primary);">GO</button>
                </div>

                <div id="edit-list-container"></div>

                <div style="margin-top:20px; padding-top:10px; border-top:1px solid #333;">
                    <label style="font-size:0.8rem; color:var(--text-muted); font-weight:700;">ADD ITEM</label>
                    <div class="row-inputs" style="grid-template-columns: 2fr 1fr 0.8fr auto; gap:5px;">
                        <select id="menu-select" class="inp-select" style="margin:0;" onchange="autoFillPrice()">
                            <option value="">-- Select --</option>
                        </select>
                        <input type="number" id="new-item-price" class="inp" style="margin:0;" placeholder="‚Çπ">
                        <input type="number" id="new-item-qty" class="inp" style="margin:0;" value="1">
                        <button class="btn-modal-action" style="background:var(--primary); width:auto; padding:0 15px;" onclick="addNewItemToOrder()">+</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" onclick="closeModal('edit-modal')">Done</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, remove, get, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9d8Seuez7ihaTSAuPyoCwqjKIR1-VFKg",
            authDomain: "cafe-orders-1afa1.firebaseapp.com",
            databaseURL: "https://cafe-orders-1afa1-default-rtdb.firebaseio.com",
            projectId: "cafe-orders-1afa1",
            messagingSenderId: "274410745480",
            appId: "1:274410745480:web:9964c3914d512aed8d793d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- GLOBAL SOUND CONFIG ---
        const bell = new Audio('bell.mp3');
        bell.loop = true;

        // --- AUTH ---
        window.checkPin = () => {
            if(document.getElementById('pin-input').value === '2024') {
                bell.play().then(() => { bell.pause(); bell.currentTime = 0; }).catch(e => {});
                document.getElementById('pin-overlay').style.display = 'none';
                initData();
                loadMenuForEdit(); 
            } else alert("Wrong PIN");
        }

        // --- STATE ---
        let onlineOrders = [];
        let tableData = {}; 
        let currentSettleTable = null;
        let currentEditKey = null; 
        let fullMenu = []; 
        let extOrderItems = []; // For the Swiggy Modal

        // --- MENU LOADING ---
        function loadMenuForEdit() {
            onValue(ref(db, 'menu'), (snapshot) => {
                const data = snapshot.val() || {};
                fullMenu = Object.values(data);
                fullMenu.sort((a,b) => a.name.localeCompare(b.name));
                
                // Populate Standard Edit
                const select = document.getElementById('menu-select');
                select.innerHTML = '<option value="">-- Select Item --</option>';
                
                // Populate Ext Modal
                const extSelect = document.getElementById('ext-menu-select');
                extSelect.innerHTML = '<option value="">-- Select Item --</option>';

                fullMenu.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.name;
                    opt.dataset.price = item.price;
                    opt.dataset.category = item.category || 'General';
                    opt.innerText = item.name;
                    select.appendChild(opt);
                    extSelect.appendChild(opt.cloneNode(true));
                });
            });
        }

        window.autoFillPrice = () => {
            const select = document.getElementById('menu-select');
            const priceInput = document.getElementById('new-item-price');
            const selectedOpt = select.options[select.selectedIndex];
            if(selectedOpt && selectedOpt.dataset.price) priceInput.value = selectedOpt.dataset.price;
        }

        window.extAutoFill = () => {
            const select = document.getElementById('ext-menu-select');
            const priceInput = document.getElementById('ext-price');
            const selectedOpt = select.options[select.selectedIndex];
            if(selectedOpt && selectedOpt.dataset.price) priceInput.value = selectedOpt.dataset.price;
        }

        // --- EXTERNAL ORDER LOGIC ---
        window.openExtOrderModal = () => {
            document.getElementById('ext-order-modal').style.display = 'flex';
            extOrderItems = [];
            renderExtItems();
            document.getElementById('ext-id').value = "";
        }

        window.addExtItem = () => {
            const select = document.getElementById('ext-menu-select');
            const name = select.value;
            const price = parseFloat(document.getElementById('ext-price').value);
            const qty = parseInt(document.getElementById('ext-qty').value);
            
            if(!name || isNaN(price) || !qty) return;

            extOrderItems.push({ name, price, qty, kitchenDone: false });
            renderExtItems();
        }

        function renderExtItems() {
            const cont = document.getElementById('ext-items-list');
            cont.innerHTML = "";
            let total = 0;
            extOrderItems.forEach((item, idx) => {
                total += (item.price * item.qty);
                cont.innerHTML += `
                    <div class="ext-item-row">
                        <span>${item.qty}x ${item.name}</span>
                        <span>‚Çπ${item.price * item.qty}</span>
                        <button class="btn-sm-del" onclick="removeExtItem(${idx})">&times;</button>
                    </div>
                `;
            });
            document.getElementById('ext-total-display').innerText = `‚Çπ${total}`;
        }
        window.removeExtItem = (idx) => { extOrderItems.splice(idx, 1); renderExtItems(); }

        window.submitExtOrder = () => {
            const platform = document.getElementById('ext-platform').value;
            const idVal = document.getElementById('ext-id').value.trim();
            
            if(!idVal || extOrderItems.length === 0) return alert("Enter ID and add items.");
            
            const total = extOrderItems.reduce((acc, i) => acc + (i.price * i.qty), 0);
            
            const newOrder = {
                orderId: idVal,
                orderType: platform, // 'Swiggy' or 'Zomato'
                timestamp: Date.now(),
                status: 'cooking', // Directly to cooking
                customer: { name: platform + " #" + idVal, phone: "-", address: "Pickup" },
                items: extOrderItems,
                financials: { subTotal: total, discountVal: 0, packingTotal: 0, grandTotal: total }
            };

            push(ref(db, 'orders'), newOrder).then(() => {
                closeModal('ext-order-modal');
            });
        }

        // --- MAIN INIT ---
        function initData() {
            onValue(ref(db, 'orders'), (snapshot) => {
                const data = snapshot.val() || {};
                onlineOrders = [];
                tableData = {};
                let hasPendingOrders = false;

                Object.entries(data).forEach(([key, order]) => {
                    if (!order || !order.status) return;
                    if (order.status === 'completed' || order.status === 'rejected') return;

                    const type = order.orderType || 'Dine-In';

                    // SOUND CHECK
                    if(order.status === 'pending') hasPendingOrders = true;

                    // 1. KITCHEN QUEUE LOGIC
                    let showInQueue = true;
                    if (order.status === 'served') showInQueue = false;
                    // Keep Delivery, Pickup, Swiggy, Zomato in queue until marked done
                    if (order.status === 'done') {
                         if(type === 'Dine-In') showInQueue = false; // Dine-in done = on table
                    }

                    if (showInQueue) {
                        onlineOrders.push({ key, ...order });
                    }

                    // 2. TABLE MAP LOGIC (Dine-In Only)
                    if (type === 'Dine-In') {
                        const customerName = (order.customer && order.customer.name) ? order.customer.name : "Unknown";
                        const match = customerName.match(/Table (\w+)/i);
                        if (match && order.status !== 'pending') {
                            const tId = match[1];
                            if (!tableData[tId]) {
                                tableData[tId] = { 
                                    total: 0, timestamp: order.timestamp, keys: [], items: [],
                                    fins: { sub:0, disc:0, pack:0 }, rawOrders: []
                                };
                            }
                            
                            const f = order.financials || {};
                            tableData[tId].total += (f.grandTotal || 0);
                            tableData[tId].fins.sub += (f.subTotal || 0);
                            tableData[tId].fins.disc += (f.discountVal || 0); 
                            tableData[tId].fins.pack += (f.packingTotal || 0); 
                            if (order.timestamp < tableData[tId].timestamp) tableData[tId].timestamp = order.timestamp;
                            tableData[tId].keys.push(key);
                            tableData[tId].rawOrders.push(order);
                            if(order.items) {
                                const activeItems = order.items.filter(i => !i.deleted);
                                tableData[tId].items.push(...activeItems);
                            }
                        }
                    }
                });

                if(hasPendingOrders) {
                    if(bell.paused) bell.play().catch(e => console.log("Sound blocked"));
                } else {
                    bell.pause(); bell.currentTime = 0;
                }

                onlineOrders.sort((a,b) => a.timestamp - b.timestamp);
                renderOnlineList();
                renderTableGrid();
            });
        }

        function renderOnlineList() {
            const container = document.getElementById('online-list');
            document.getElementById('online-count').innerText = onlineOrders.length;
            container.innerHTML = "";

            onlineOrders.forEach(order => {
                const type = order.orderType || 'Dine-In';
                const c = order.customer || {};
                
                let badgeClass = 'card-type';
                if(type === 'Swiggy') badgeClass += ' badge-swiggy';
                else if(type === 'Zomato') badgeClass += ' badge-zomato';
                
                // Color Code the card based on type
                let cardTypeClass = '';
                if(type === 'Swiggy') cardTypeClass = 'type-swiggy';
                else if(type === 'Zomato') cardTypeClass = 'type-zomato';
                else cardTypeClass = `status-${order.status}`;

                let infoHtml = '';
                if (type === 'Delivery' || type === 'Pickup') {
                    infoHtml = `<div class="info-grid"><span class="info-label">Customer</span><span class="info-val">${c.name}</span></div>`;
                } else if (type === 'Swiggy' || type === 'Zomato') {
                     infoHtml = `<div class="info-grid"><span class="info-label">ID</span><span class="info-val">#${order.orderId}</span></div>`;
                } else {
                    infoHtml = `<div class="info-grid"><span class="info-label">Table</span><span class="info-val" style="color:var(--primary); font-size:1.1rem;">${c.name}</span></div>`;
                }

                let itemsHtml = (order.items || []).map(i => {
                    if(i.deleted) return `<div class="item-row item-void"><span>${i.qty}x ${i.name}</span><span>VOID</span></div>`;
                    return `<div class="item-row"><span><span class="item-qty">${i.qty}x</span> ${i.name}</span><span class="item-price">‚Çπ${i.price * i.qty}</span></div>`;
                }).join('');

                const f = order.financials || {};
                let finHtml = `<div class="fin-box"><div class="fin-row total"><span>TOTAL</span><span>‚Çπ${f.grandTotal || 0}</span></div></div>`;

                let btnHtml = '';
                let showEdit = true;

                if(order.status === 'pending') {
                    btnHtml = `<button class="btn-act btn-red" onclick="rejectOrder('${order.key}')">Reject</button>
                               <button class="btn-act btn-green" onclick="updateStatus('${order.key}', 'cooking')">Accept</button>`;
                } else if (order.status === 'cooking') {
                     btnHtml = `<button class="btn-act btn-green" onclick="updateStatus('${order.key}', 'done')">Ready</button>`;
                } else if (order.status === 'done') {
                    if (type === 'Delivery') {
                         btnHtml = `<button class="btn-act btn-red" disabled>Wait for Driver</button>`;
                         showEdit = false;
                    } else if (type === 'Pickup' || type === 'Swiggy' || type === 'Zomato') {
                         let label = (type === 'Swiggy' || type === 'Zomato') ? "Rider Picked Up" : "Mark Picked Up";
                         btnHtml = `<button class="btn-act btn-orange" onclick="completeOrderSingle('${order.key}')">${label}</button>`;
                         showEdit = false;
                    }
                } else if (order.status === 'out_for_delivery') {
                     btnHtml = `<button class="btn-act btn-red" onclick="forceComplete('${order.key}')">Driver Out</button>`;
                     showEdit = false; 
                } 

                const div = document.createElement('div');
                div.className = `order-card ${cardTypeClass}`;
                div.innerHTML = `
                    <div class="card-top">
                        <span class="card-id">#${order.orderId}</span>
                        <span class="${badgeClass}">${type}</span>
                    </div>
                    <div class="card-body">
                        ${infoHtml}
                        <div class="items-list">${itemsHtml}</div>
                        ${finHtml}
                    </div>
                    <div class="card-actions">
                        ${showEdit ? `<button class="btn-act btn-blue" style="flex:0.3" onclick="openEditModal('${order.key}')">EDIT</button>` : ''}
                        ${btnHtml}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- TABLE GRID (UNCHANGED) ---
        function renderTableGrid() {
            const gridMain = document.getElementById('grid-main');
            const gridAC = document.getElementById('grid-ac');
            gridMain.innerHTML = ""; gridAC.innerHTML = "";

            let occupiedCount = Object.keys(tableData).length;
            document.getElementById('dinein-count').innerText = `${occupiedCount} Occupied`;

            for(let i=1; i<=7; i++) createTableCard(i, gridMain);
            createTableCard(8, gridMain, true, "BAR");
            for(let i=9; i<=13; i++) createTableCard(i, gridAC);
        }

        function createTableCard(id, container, isBar=false, label=null) {
            const data = tableData[id];
            const div = document.createElement('div');
            let statusClass = 'status-free';
            let timeText = ''; let totalText = ''; let statusLabel = 'FREE';

            if (data) {
                const diff = Date.now() - data.timestamp;
                const tm = Math.floor(diff / 60000);
                const h = Math.floor(tm / 60);
                const m = tm % 60;
                timeText = `${h}:${m.toString().padStart(2,'0')}`;
                totalText = `‚Çπ${data.total}`;
                statusLabel = 'OCCUPIED';

                if (tm < 60) statusClass = 'status-fresh';
                else if (tm < 90) statusClass = 'status-warning';
                else statusClass = 'status-camper';
            }

            div.className = `table-card ${statusClass} ${isBar?'is-bar':''}`;
            if(data) div.onclick = () => openSettleModal(id);
            div.innerHTML = `<div class="t-header"><div class="t-num">${label || id}</div><div class="t-bill">${totalText}</div></div>
                             <div class="t-timer">${timeText}</div><div class="t-status">${statusLabel}</div>`;
            container.appendChild(div);
        }

        // --- SETTLE & EDIT LOGIC (Standard) ---
        window.openSettleModal = (tableId) => {
            const data = tableData[tableId];
            if(!data) return;
            currentSettleTable = tableId;
            document.getElementById('settle-modal').style.display = 'flex';
            document.getElementById('modal-table-id').innerText = tableId;
            
            const list = document.getElementById('modal-items-list');
            list.innerHTML = data.items.map(i => `<div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#aaa;"><span>${i.qty}x ${i.name}</span> <span>‚Çπ${i.price * i.qty}</span></div>`).join('');
            document.getElementById('m-sub').innerText = `‚Çπ${data.fins.sub}`;
            document.getElementById('m-disc').innerText = `-‚Çπ${data.fins.disc}`;
            document.getElementById('m-pack').innerText = `‚Çπ${data.fins.pack}`;
            document.getElementById('m-total').innerText = `‚Çπ${data.total}`;
        }

        window.openEditFromTable = () => {
            if(!currentSettleTable || !tableData[currentSettleTable]) return;
            const keys = tableData[currentSettleTable].keys;
            if(keys.length > 0) {
                closeModal('settle-modal');
                openEditModal(keys[keys.length - 1]);
            }
        }

        window.openEditModal = async (key) => {
            currentEditKey = key;
            document.getElementById('edit-modal').style.display = 'flex';
            const snap = await get(ref(db, 'orders/' + key));
            if(snap.exists()) {
                const order = snap.val();
                // Populating Transfer Table dropdown
                const sel = document.getElementById('table-transfer-select');
                sel.innerHTML = "";
                let currentTableId = "";
                if (order.customer && order.customer.name && order.customer.name.startsWith("Table")) {
                    currentTableId = order.customer.name.split(" ")[1];
                }
                for(let i=1; i<=13; i++) {
                    const opt = document.createElement('option');
                    opt.value = i; opt.text = (i===8)?"Table 8 (BAR)":`Table ${i}`;
                    if(i.toString() === currentTableId) opt.selected = true;
                    sel.appendChild(opt);
                }
                renderEditList(order.items || []);
            }
        }

        function renderEditList(items) {
            const container = document.getElementById('edit-list-container');
            container.innerHTML = "";
            items.forEach((item, index) => {
                const isDel = item.deleted ? 'opacity:0.5; text-decoration:line-through;' : '';
                container.innerHTML += `
                    <div class="edit-row" style="display:flex; justify-content:space-between; margin-bottom:5px; ${isDel}">
                        <div>${item.qty}x ${item.name}</div>
                        <button style="color:red; background:none; border:none; cursor:pointer;" onclick="deleteItem(${index})">üóë</button>
                    </div>`;
            });
        }

        window.addNewItemToOrder = async () => {
            const select = document.getElementById('menu-select');
            const name = select.value; 
            const price = parseFloat(document.getElementById('new-item-price').value);
            const qty = parseInt(document.getElementById('new-item-qty').value);
            
            if(!name || isNaN(price)) return;
            const snap = await get(ref(db, 'orders/' + currentEditKey));
            let order = snap.val();
            let items = order.items || [];
            items.push({ name, price, qty, kitchenDone: false });
            
            updateOrderFinancials(order, items);
            await update(ref(db, 'orders/' + currentEditKey), order);
            renderEditList(items);
        }

        // --- HELPER FUNCTIONS ---
        window.deleteItem = async (index) => {
            const snap = await get(ref(db, 'orders/' + currentEditKey));
            let order = snap.val();
            if(order.items[index]) {
                order.items[index].deleted = true;
                updateOrderFinancials(order, order.items);
                await update(ref(db, 'orders/' + currentEditKey), order);
                renderEditList(order.items);
            }
        }

        window.saveTableMove = async () => {
            const newTableId = document.getElementById('table-transfer-select').value;
            await update(ref(db, 'orders/' + currentEditKey + '/customer'), { name: `Table ${newTableId}` });
            closeModal('edit-modal');
        }

        function updateOrderFinancials(order, items) {
            order.items = items;
            let sub = 0; let pack = 0;
            const fiveRsCats = ["Bun-Tastic Burgers", "Freshly Folded", "Toasty Treats"];
            items.forEach(i => {
                if(i.deleted) return;
                sub += (i.price * i.qty);
                // Simple packing logic for demo
                pack += (5 * i.qty); 
            });
            order.financials = { subTotal: sub, discountVal: 0, packingTotal: pack, grandTotal: sub + pack };
        }

        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        
        window.updateStatus = (key, status) => update(ref(db, 'orders/'+key), {status});
        window.rejectOrder = (key) => remove(ref(db, 'orders/'+key)); 
        window.forceComplete = (key) => { if(confirm("Force Complete?")) completeOrderSingle(key); }
        
        window.completeOrderSingle = async (key) => {
            const r = ref(db, 'orders/'+key);
            const s = await get(r);
            if(s.exists()){
                const d = s.val(); d.status='completed'; d.completedAt=Date.now();
                await push(ref(db, 'history'), d); 
                await remove(r);
            }
        };

        window.settleAndClear = async () => {
            if(!currentSettleTable) return;
            const tData = tableData[currentSettleTable];
            const masterBill = {
                orderId: Math.floor(100000 + Math.random() * 900000),
                orderType: 'Dine-In', timestamp: Date.now(), status: 'paid',
                customer: { name: `Table ${currentSettleTable}`, phone: '-', address: 'Dine-In' },
                items: tData.items, 
                financials: { grandTotal: tData.total }
            };
            await push(ref(db, 'history'), masterBill);
            for (const key of tData.keys) await remove(ref(db, 'orders/' + key));
            closeModal('settle-modal');
        };
        
        // Window Exports
        window.openExtOrderModal = openExtOrderModal;
        window.closeModal = closeModal;
        window.addExtItem = addExtItem;
        window.submitExtOrder = submitExtOrder;
        window.removeExtItem = removeExtItem;
    </script>
</body>
</html>
