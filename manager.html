<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen Manager | Caf√© Cloud Club</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        /* --- THEME & BASICS --- */
        :root {
            --bg: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --border: #333;
            --accent-green: #27ae60;
            --accent-red: #c0392b;
            --accent-yellow: #f1c40f; 
            --accent-blue: #2980b9;
            --accent-purple: #8e44ad;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        /* --- LOCK SCREEN --- */
        #pin-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .pin-box {
            background: #1e1e1e; padding: 40px; border-radius: 12px;
            border: 1px solid #333; text-align: center; width: 300px;
        }
        .pin-input {
            width: 100%; padding: 15px; margin: 20px 0;
            background: #121212; border: 1px solid #333;
            color: white; font-size: 1.5rem; text-align: center;
            letter-spacing: 5px; border-radius: 8px;
        }
        .pin-btn {
            width: 100%; padding: 15px;
            background: var(--accent-green); color: white;
            border: none; font-weight: 800; border-radius: 8px; cursor: pointer;
        }

        /* --- HEADER --- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px;
        }
        .live-badge {
            background: rgba(39, 174, 96, 0.2); color: var(--accent-green);
            padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;
            display: inline-block; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* --- GRID LAYOUT --- */
        .kitchen-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        /* --- ORDER CARD --- */
        .order-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            transition: transform 0.2s;
            display: flex; flex-direction: column;
        }
        
        /* FRAUD ALERT STYLE */
        .fraud-alert {
            border: 2px solid #e74c3c !important;
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.4);
        }
        .fraud-badge {
            background: #c0392b; color: white; font-weight: bold;
            text-align: center; padding: 5px; border-radius: 4px;
            margin-bottom: 10px; font-size: 0.9rem;
            animation: flash 1s infinite;
        }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .card-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #333;
        }
        .order-id { font-family: 'Roboto Mono', monospace; font-size: 1.2rem; font-weight: 700; color: #fff; }
        .order-time { font-size: 0.8rem; color: var(--text-muted); }
        
        .customer-info { font-size: 0.9rem; color: #bbb; margin-bottom: 15px; }
        .customer-info span { color: #fff; font-weight: 600; }

        .items-list { margin-bottom: 20px; flex-grow: 1; }
        .item-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }
        .item-qty { color: var(--accent-green); font-weight: 700; margin-right: 8px; }

        .notes-box {
            background: #2c2c2c; padding: 10px; border-radius: 6px;
            font-size: 0.85rem; color: #f1c40f; margin-bottom: 15px;
            border-left: 3px solid #f1c40f;
        }

        .total-row {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 1.1rem; font-weight: 700; color: #fff;
            margin-bottom: 20px; padding-top: 10px; border-top: 1px solid #333;
        }

        /* --- ACTION BUTTONS --- */
        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button {
            padding: 12px; border: none; border-radius: 8px;
            font-weight: 700; cursor: pointer; font-family: inherit;
            color: white; transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }

        .btn-accept { background: var(--accent-blue); grid-column: span 2; }
        .btn-ready { background: var(--accent-green); grid-column: span 2; }
        .btn-delivery { background: var(--accent-purple); grid-column: span 2; }
        
        .btn-reject { background: #2c2c2c; color: #e74c3c; border: 1px solid #e74c3c; }
        .btn-reject:hover { background: #e74c3c; color: white; }
        
        .status-badge {
            position: absolute; top: -10px; right: -10px;
            padding: 5px 10px; border-radius: 20px;
            font-size: 0.75rem; font-weight: 800; text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .st-pending { background: var(--accent-yellow); color: #000; }
        .st-cooking { background: var(--accent-blue); color: #fff; }
        .st-done { background: var(--accent-green); color: #fff; }

    </style>
</head>
<body>

    <div id="pin-overlay">
        <div class="pin-box">
            <h2>üë®‚Äçüç≥ Kitchen Access</h2>
            <input type="password" id="pin-input" class="pin-input" placeholder="****" maxlength="4">
            <button class="pin-btn" onclick="checkPin()">Enter Kitchen</button>
        </div>
    </div>

    <div class="header">
        <div>
            <h1 style="margin:0;">Kitchen Manager</h1>
            <div class="live-badge">‚óè Live Orders</div>
        </div>
        <div>
            <a href="history.html" style="color: #aaa; text-decoration: none; margin-right: 20px;">üìú History</a>
            <a href="admin.html" style="color: var(--accent-green); text-decoration: none;">‚öôÔ∏è Menu</a>
        </div>
    </div>

    <audio id="alert-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.m4a"></audio>

    <div id="orders-container" class="kitchen-grid">
        <div style="color:#666; padding:20px;">Waiting for orders...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, remove, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9d8Seuez7ihaTSAuPyoCwqjKIR1-VFKg",
            authDomain: "cafe-orders-1afa1.firebaseapp.com",
            databaseURL: "https://cafe-orders-1afa1-default-rtdb.firebaseio.com",
            projectId: "cafe-orders-1afa1",
            storageBucket: "cafe-orders-1afa1.firebasestorage.app",
            messagingSenderId: "274410745480",
            appId: "1:274410745480:web:9964c3914d512aed8d793d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- SECURITY ---
        const PIN = "2025";
        window.checkPin = () => {
            if(document.getElementById('pin-input').value === PIN) {
                document.getElementById('pin-overlay').style.display = 'none';
                initManager();
            } else {
                alert("WRONG PIN");
            }
        };

        // --- FRAUD DETECTION: FETCH MENU PRICES ---
        let globalMenu = {};
        function initManager() {
            // 1. Fetch Menu for Price Verification
            onValue(ref(db, 'menu'), (snapshot) => {
                if(snapshot.exists()) {
                    const data = snapshot.val();
                    // Create a simple map: "Burger" -> 150
                    Object.values(data).forEach(item => {
                        globalMenu[item.name] = parseInt(item.price);
                    });
                    console.log("Menu prices loaded for fraud check:", globalMenu);
                }
            });

            // 2. Listen for Orders
            onValue(ref(db, 'orders'), (snapshot) => {
                const container = document.getElementById('orders-container');
                container.innerHTML = "";
                const data = snapshot.val();

                if(!data) {
                    container.innerHTML = "<div style='grid-column:1/-1; text-align:center; margin-top:50px; color:#444;'><h3>No Active Orders</h3><p>Time to clean the kitchen!</p></div>";
                    return;
                }

                // Process Orders
                Object.entries(data).forEach(([key, order]) => {
                    renderOrderCard(key, order, container);
                });
            });
        }

        function renderOrderCard(key, order, container) {
            // --- FRAUD CHECK LOGIC ---
            let fraudDetected = false;
            let calculatedFoodCost = 0;
            
            if(order.items && Array.isArray(order.items)) {
                order.items.forEach(item => {
                    const realPrice = globalMenu[item.name]; // Look up price in menu
                    if (realPrice) {
                        calculatedFoodCost += (realPrice * item.qty);
                    } else {
                        // If item not found in menu (maybe deleted?), assume order price is real to avoid false alarm
                        calculatedFoodCost += (item.price * item.qty); 
                    }
                });
            }

            // We compare Calculated vs Paid. 
            // Paid should be >= Calculated (because of Packing fees etc).
            // If Paid is LESS than just the raw food cost, it's a Hack.
            const paidAmount = order.financials ? order.financials.grandTotal : 0;
            
            // Allow a small buffer of 5 rupees just in case
            if (paidAmount < (calculatedFoodCost - 5)) {
                fraudDetected = true;
            }
            // -------------------------

            const statusColors = {
                'pending': 'st-pending',
                'cooking': 'st-cooking',
                'done': 'st-done'
            };

            const card = document.createElement('div');
            card.className = `order-card ${fraudDetected ? 'fraud-alert' : ''}`; // Add red border if fraud

            // Play sound if new pending order
            if(order.status === 'pending') playSound();

            let itemsHtml = order.items.map(i => `
                <div class="item-row">
                    <div><span class="item-qty">${i.qty}x</span> ${i.name}</div>
                    <div style="color:#777;">‚Çπ${i.price * i.qty}</div>
                </div>
            `).join('');

            // Action Buttons Logic
            let buttonsHtml = '';
            if(order.status === 'pending') {
                buttonsHtml = `
                    <button class="btn-reject" onclick="window.rejectOrder('${key}')">Reject</button>
                    <button class="btn-accept" onclick="window.acceptOrder('${key}')">Accept & Cook</button>
                `;
            } else if (order.status === 'cooking') {
                buttonsHtml = `
                    <button class="btn-ready" onclick="window.markReady('${key}')">‚úÖ Mark Ready</button>
                `;
            } else if (order.status === 'done') {
                const btnText = order.orderType === 'Delivery' ? 'üöÄ Send for Delivery' : 'üì¶ Complete Order';
                const action = order.orderType === 'Delivery' ? `window.markOutForDelivery('${key}')` : `window.archiveOrder('${key}')`;
                buttonsHtml = `
                    <button class="btn-delivery" onclick="${action}">${btnText}</button>
                `;
            }

            card.innerHTML = `
                ${fraudDetected ? '<div class="fraud-badge">‚ö†Ô∏è SUSPICIOUS PRICE DETECTED ‚ö†Ô∏è</div>' : ''}
                <div class="status-badge ${statusColors[order.status] || ''}">${order.status}</div>
                
                <div class="card-header">
                    <div>
                        <div class="order-id">#${order.orderId}</div>
                        <div class="order-time">${new Date(order.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:bold; color:var(--accent-green);">${order.orderType}</div>
                    </div>
                </div>

                <div class="customer-info">
                    <span>${order.customer.name}</span><br>
                    <a href="tel:${order.customer.phone}" style="color:#aaa; text-decoration:none;">üìû ${order.customer.phone}</a>
                </div>

                <div class="items-list">
                    ${itemsHtml}
                </div>

                ${order.notes ? `<div class="notes-box">üìù "${order.notes}"</div>` : ''}

                <div class="total-row">
                    <span>Total Bill:</span>
                    <span style="${fraudDetected ? 'color:#e74c3c; text-decoration:line-through;' : ''}">‚Çπ${paidAmount}</span>
                    ${fraudDetected ? `<span style='color:#fff; font-size:0.8rem; margin-left:10px;'>(Real: ‚Çπ${calculatedFoodCost})</span>` : ''}
                </div>

                <div class="actions">
                    ${buttonsHtml}
                </div>
            `;
            container.appendChild(card);
        }

        // --- SOUND UTILS ---
        let isRinging = false;
        const bell = document.getElementById('alert-sound');
        function playSound() {
            if(isRinging) return;
            // Only play if user interacted (browsers block auto-audio)
            bell.play().catch(e => console.log("Sound blocked until interaction"));
        }

        // --- ACTIONS ---
        
        // 1. Accept
        window.acceptOrder = (key) => {
            update(ref(db, 'orders/' + key), { status: 'cooking' });
        };

        // 2. Reject (SECURE VERSION: MOVES TO HISTORY)
        window.rejectOrder = (key) => {
            if(confirm("REJECT this order? It will be marked as REJECTED in history.")) {
                const orderRef = ref(db, 'orders/' + key);
                get(orderRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        data.status = 'rejected';
                        data.rejectedAt = Date.now();
                        // Move to history
                        set(ref(db, 'history/' + key), data)
                            .then(() => remove(orderRef))
                            .catch((err) => alert("Error: " + err));
                    }
                });
            }
        };

        // 3. Mark Ready
        window.markReady = (key) => {
             update(ref(db, 'orders/' + key), { status: 'done' });
        };

        // 4. Out for Delivery (For Delivery Boy)
        window.markOutForDelivery = (key) => {
            update(ref(db, 'orders/' + key), { status: 'out_for_delivery' });
        };

        // 5. Complete (For Pickups)
        window.archiveOrder = (key) => {
            const orderRef = ref(db, 'orders/' + key);
            if(confirm("Complete this order?")) {
                get(orderRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        data.completedAt = Date.now(); 
                        data.status = 'delivered'; // normalized status
                        set(ref(db, 'history/' + key), data)
                            .then(() => remove(orderRef))
                            .catch((err) => alert("Error: " + err));
                    }
                });
            }
        };

    </script>
</body>
</html>
