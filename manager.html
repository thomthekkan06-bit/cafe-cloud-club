<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Manager POS | Cafe Cloud Club</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1115;
            --surface: #181b21;
            --surface-hover: #22262e;
            --border: #2f3542;
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --purple: #8b5cf6;
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Inter', sans-serif;
            background: var(--bg); 
            color: var(--text-main); 
            margin: 0; 
            height: 100vh; 
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }
        
        /* --- HEADER --- */
        .top-bar {
            flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
            background: var(--surface); padding: 10px 20px; 
            border-bottom: 1px solid var(--border); z-index: 10;
        }
        .app-title { 
            margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px;
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .clock { font-family: 'JetBrains Mono'; font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
        .btn-history {
            background: var(--surface-hover); color: var(--text-muted); border: 1px solid var(--border);
            padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; text-decoration: none;
        }

        /* --- SPLIT LAYOUT --- */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* LEFT SIDE: KITCHEN QUEUE */
        .left-pane {
            width: 40%;
            min-width: 400px; 
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            background: #121418;
        }
        .pane-header {
            padding: 15px; background: rgba(0,0,0,0.2); 
            border-bottom: 1px solid var(--border); font-weight: 800; letter-spacing: 1px; color: var(--text-muted);
            display: flex; justify-content: space-between;
        }
        .scroll-area {
            flex: 1; overflow-y: auto; padding: 15px;
        }

        /* RIGHT SIDE: TABLE MAP */
        .right-pane {
            flex: 1;
            background: var(--bg);
            display: flex; flex-direction: column;
            overflow-y: auto;
            padding: 20px;
        }

        /* --- ORDER CARDS --- */
        .order-card {
            background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
            overflow: hidden; margin-bottom: 15px;
            border-left: 4px solid var(--border);
            display: flex; flex-direction: column;
        }
        .order-card.status-pending { border-left-color: var(--primary); }
        .order-card.status-cooking { border-left-color: var(--warning); }
        .order-card.status-done { border-left-color: var(--success); } /* Added Done State */
        .order-card.status-out_for_delivery { border-left-color: var(--purple); }

        .card-top { 
            padding: 10px 12px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); 
        }
        .card-id { font-family: 'JetBrains Mono'; font-weight: 800; color: var(--text-muted); }
        .card-type { font-size: 0.7rem; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1); font-weight: 700; }
        
        .card-body { padding: 12px; }
        
        /* Customer Info */
        .info-grid { display: grid; grid-template-columns: auto 1fr; gap: 5px 10px; margin-bottom: 10px; font-size: 0.9rem; }
        .info-label { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; align-self: center; font-weight:700; }
        .info-val { font-weight: 500; color: #fff; }

        /* Items Section */
        .items-list { margin: 10px 0; border-top: 1px dashed var(--border); padding-top: 10px; }
        .item-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px; }
        .item-qty { color: var(--primary); font-weight: 700; margin-right: 5px; }
        .item-price { font-family: 'JetBrains Mono'; color: var(--text-muted); }

        /* Financials Section */
        .fin-box { 
            background: rgba(0,0,0,0.3); border-radius: 6px; padding: 8px; margin-top: 10px; 
            font-size: 0.85rem; 
        }
        .fin-row { display: flex; justify-content: space-between; margin-bottom: 2px; color: var(--text-muted); }
        .fin-row.total { 
            margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border); 
            color: var(--success); font-weight: 800; font-size: 1rem;
        }

        .card-actions { 
            padding: 10px; display: flex; gap: 10px; border-top: 1px solid var(--border); 
        }
        .btn-act { 
            flex: 1; padding: 10px; border-radius: 6px; border: none; cursor: pointer; 
            font-weight: 700; font-size: 0.8rem; transition: opacity 0.2s;
        }
        .btn-act:hover { opacity: 0.9; }
        .btn-green { background: var(--success); color: white; }
        .btn-yellow { background: var(--warning); color: black; }
        .btn-purple { background: var(--purple); color: white; } /* Added Purple Button */
        .btn-red { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .btn-blue { background: rgba(59, 130, 246, 0.2); color: var(--primary); border: 1px solid var(--primary); }

        /* --- TABLE GRID --- */
        .section-label { 
            font-size: 0.8rem; font-weight: 700; color: var(--text-muted); 
            text-transform: uppercase; margin: 20px 0 10px 0; border-bottom: 1px solid var(--border); padding-bottom: 5px; 
        }
        .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }

        .table-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; height: 130px;
            display: flex; flex-direction: column; justify-content: space-between; padding: 15px;
            cursor: pointer; transition: 0.2s; position: relative; overflow: hidden;
        }
        .table-card:active { transform: scale(0.95); }
        
        .t-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .t-num { font-size: 2rem; font-weight: 800; font-family: 'JetBrains Mono'; color: #555; transition: color 0.3s; }
        .t-bill { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 6px; }
        .t-timer { font-size: 1.4rem; font-weight: 700; font-family: 'JetBrains Mono'; text-align: center; margin: 5px 0; }
        .t-status { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; text-align: center; opacity: 0.8; }

        /* TABLE STATES */
        .status-free { opacity: 1; border-color: #333; }
        .status-free .t-num { color: #666; }
        .status-free .t-timer, .status-free .t-bill { display: none; }
        .status-free .t-status { color: #555; }

        .status-fresh { border: 1px solid var(--success); background: rgba(16, 185, 129, 0.1); }
        .status-fresh .t-num, .status-fresh .t-timer, .status-fresh .t-bill, .status-fresh .t-status { color: var(--success); }
        .status-warning { border: 1px solid var(--warning); background: rgba(245, 158, 11, 0.1); }
        .status-warning .t-num, .status-warning .t-timer, .status-warning .t-bill, .status-warning .t-status { color: var(--warning); }
        .status-camper { border: 1px solid var(--danger); background: rgba(239, 68, 68, 0.15); animation: pulseRed 2s infinite; }
        .status-camper .t-num, .status-camper .t-timer, .status-camper .t-bill, .status-camper .t-status { color: var(--danger); }
        
        .is-bar { border-style: dashed; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 5000; display: none;
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-card {
            background: var(--surface); width: 450px; max-width: 90%;
            border-radius: 16px; border: 1px solid var(--border); 
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-header { padding: 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        
        .btn-modal-cancel { flex: 1; padding: 15px; background: transparent; border: 1px solid var(--border); color: var(--text-muted); border-radius: 8px; cursor: pointer; font-weight: 700; }
        .btn-modal-action { flex: 1; padding: 15px; border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: 700; }
        
        /* EDIT MODAL SPECIFIC */
        .edit-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .edit-inputs { display: grid; grid-template-columns: 2fr 1fr 0.8fr auto; gap: 5px; margin-top: 15px; }
        .inp, .inp-select { background: var(--bg); border: 1px solid var(--border); color: white; padding: 8px; border-radius: 4px; width: 100%; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.2rem; }
        .btn-trash { color: var(--danger); }
        .btn-add { background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* PIN LOCK */
        #pin-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 17, 21, 0.98); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-input { background: var(--bg); border: 1px solid var(--border); color: white; font-size: 2rem; text-align: center; letter-spacing: 10px; padding: 10px; border-radius: 8px; width: 200px; margin: 20px 0; outline: none; }
    </style>
</head>
<body>

    <div id="pin-overlay">
        <h2 style="color:white;">Manager Access</h2>
        <input type="password" id="pin-input" class="pin-input" maxlength="4" inputmode="numeric">
        <button onclick="checkPin()" style="background:var(--primary); border:none; padding:10px 30px; border-radius:6px; color:white; font-weight:bold; cursor:pointer;">UNLOCK</button>
    </div>

    <div class="top-bar">
        <h1 class="app-title"> <img src="og-image.jpg" alt="Logo" style="height: 30px; border-radius: 6px;"> MANAGER DECK </h1>
        <div class="clock" id="clock">00:00</div>
        <a href="history.html" class="btn-history">Sales History</a>
    </div>

    <div class="main-container">
        <div class="left-pane">
            <div class="pane-header">
                <span>KITCHEN QUEUE</span>
                <span id="online-count" style="color:var(--primary)">0</span>
            </div>
            <div class="scroll-area" id="online-list">
                </div>
        </div>

        <div class="right-pane">
            <div class="pane-header" style="background:transparent; border:none; padding-left:0;">
                <span>FLOOR MAP (DINE-IN)</span>
                <span id="dinein-count" style="color:var(--success)">0 Occupied</span>
            </div>

            <div class="section-label">Indoor Dining (1-7 + Bar)</div>
            <div class="tables-grid" id="grid-main"></div>

            <div class="section-label">Indoor AC (9-13)</div>
            <div class="tables-grid" id="grid-ac"></div>
        </div>
    </div>

    <div class="modal-overlay" id="settle-modal">
        <div class="modal-card">
            <div class="modal-header">
                <h3 style="margin:0;">Settle Table <span id="modal-table-id"></span></h3>
                <div style="cursor:pointer;" onclick="closeModal('settle-modal')">&times;</div>
            </div>
            <div class="modal-body">
                <div id="modal-items-list"></div>
                <div class="fin-box">
                     <div class="fin-row"><span>Subtotal</span><span id="m-sub">‚Çπ0</span></div>
                     <div class="fin-row"><span>Discount</span><span id="m-disc">‚Çπ0</span></div>
                     <div class="fin-row"><span>Packing</span><span id="m-pack">‚Çπ0</span></div>
                     <div class="fin-row total"><span>TOTAL PAYABLE</span><span id="m-total">‚Çπ0</span></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" onclick="openEditFromTable()">EDIT ORDER ‚úèÔ∏è</button>
                <button class="btn-modal-action" style="background:var(--success)" onclick="settleAndClear()">PAID & CLEAR ‚úÖ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="edit-modal">
        <div class="modal-card">
            <div class="modal-header">
                <h3 style="margin:0;">Edit Order</h3>
                <div style="cursor:pointer;" onclick="closeModal('edit-modal')">&times;</div>
            </div>
            <div class="modal-body">
                <div id="edit-list-container">
                    </div>

                <div style="margin-top:20px; padding-top:10px; border-top:1px solid #333;">
                    <label style="font-size:0.8rem; color:var(--text-muted); font-weight:700;">ADD ITEM FROM MENU</label>
                    <div class="edit-inputs">
                        <select id="menu-select" class="inp-select" onchange="autoFillPrice()">
                            <option value="">-- Loading Menu... --</option>
                        </select>
                        
                        <input type="number" id="new-item-price" class="inp" placeholder="‚Çπ Price">
                        <input type="number" id="new-item-qty" class="inp" value="1" placeholder="Qty">
                        <button class="btn-add" onclick="addNewItemToOrder()">+</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" onclick="closeModal('edit-modal')">Done</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, remove, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9d8Seuez7ihaTSAuPyoCwqjKIR1-VFKg",
            authDomain: "cafe-orders-1afa1.firebaseapp.com",
            databaseURL: "https://cafe-orders-1afa1-default-rtdb.firebaseio.com",
            projectId: "cafe-orders-1afa1",
            messagingSenderId: "274410745480",
            appId: "1:274410745480:web:9964c3914d512aed8d793d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- AUTH ---
        window.checkPin = () => {
            if(document.getElementById('pin-input').value === '2024') {
                document.getElementById('pin-overlay').style.display = 'none';
                initData();
                loadMenuForEdit(); // Load Menu dynamically
            } else alert("Wrong PIN");
        }

        // --- STATE ---
        let onlineOrders = [];
        let tableData = {}; 
        let currentSettleTable = null;
        let currentEditKey = null; 
        let fullMenu = []; // Store fetched menu

        // --- FETCH MENU FOR DROPDOWN ---
        function loadMenuForEdit() {
            onValue(ref(db, 'menu'), (snapshot) => {
                const data = snapshot.val() || {};
                fullMenu = Object.values(data);
                
                // Sort by Name
                fullMenu.sort((a,b) => a.name.localeCompare(b.name));

                const select = document.getElementById('menu-select');
                select.innerHTML = '<option value="">-- Select Item --</option>';
                
                fullMenu.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.name;
                    opt.dataset.price = item.price;
                    opt.dataset.category = item.category || 'General';
                    opt.innerText = item.name;
                    select.appendChild(opt);
                });
            });
        }

        window.autoFillPrice = () => {
            const select = document.getElementById('menu-select');
            const priceInput = document.getElementById('new-item-price');
            const selectedOpt = select.options[select.selectedIndex];
            if(selectedOpt && selectedOpt.dataset.price) {
                priceInput.value = selectedOpt.dataset.price;
            } else {
                priceInput.value = "";
            }
        }

        function initData() {
            onValue(ref(db, 'orders'), (snapshot) => {
                const data = snapshot.val() || {};
                onlineOrders = [];
                tableData = {};

                Object.entries(data).forEach(([key, order]) => {
                    if (!order || !order.status) return;
                    if (order.status === 'completed' || order.status === 'rejected') return;

                    const type = order.orderType || 'Dine-In';
                    const customerName = (order.customer && order.customer.name) ? order.customer.name : "Unknown";

                    // 1. LEFT LIST: KITCHEN QUEUE
                    onlineOrders.push({ key, ...order });

                    // 2. RIGHT MAP: DINE-IN TABLES (Only active if approved)
                    if (type !== 'Delivery' && type !== 'Pickup') {
                        const match = customerName.match(/Table (\w+)/i);
                        if (match && order.status !== 'pending') {
                            const tId = match[1];
                            
                            if (!tableData[tId]) {
                                tableData[tId] = { 
                                    total: 0, 
                                    timestamp: order.timestamp, 
                                    keys: [], 
                                    items: [],
                                    fins: { sub:0, disc:0, pack:0 } 
                                };
                            }
                            
                            const f = order.financials || {};
                            tableData[tId].total += (f.grandTotal || 0);
                            tableData[tId].fins.sub += (f.subTotal || 0);
                            tableData[tId].fins.disc += (f.discountVal || f.discountAmount || 0);
                            tableData[tId].fins.pack += (f.packingTotal || f.packingCharge || 0);

                            if (order.timestamp < tableData[tId].timestamp) tableData[tId].timestamp = order.timestamp;
                            
                            tableData[tId].keys.push(key);
                            if(order.items) tableData[tId].items.push(...order.items);
                        }
                    }
                });

                onlineOrders.sort((a,b) => a.timestamp - b.timestamp);
                renderOnlineList();
                renderTableGrid();
            });
        }

        // --- RENDER LEFT LIST (SMART CARDS) ---
        function renderOnlineList() {
            const container = document.getElementById('online-list');
            document.getElementById('online-count').innerText = onlineOrders.length;
            container.innerHTML = "";

            onlineOrders.forEach(order => {
                const time = new Date(order.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                const type = order.orderType || 'Dine-In';
                const c = order.customer || {};
                
                // --- 1. CUSTOMER INFO LOGIC ---
                let infoHtml = '';
                
                if (type === 'Delivery' || type === 'Pickup') {
                    // SHOW: Name, Phone, Address
                    infoHtml = `
                        <div class="info-grid">
                            <span class="info-label">Customer</span> <span class="info-val">${c.name || 'Guest'}</span>
                            <span class="info-label">Phone</span>    <span class="info-val">${c.phone || '--'}</span>
                            <span class="info-label">Loc</span>      <span class="info-val" style="font-size:0.8rem; line-height:1.2;">${c.address || c.location || '--'}</span>
                        </div>
                    `;
                } else {
                    // DINE-IN: Show Table & Name ONLY
                    infoHtml = `
                        <div class="info-grid">
                            <span class="info-label">Table</span>    <span class="info-val" style="color:var(--primary); font-size:1.1rem;">${c.name || 'Table ?'}</span>
                        </div>
                    `;
                }

                // --- 2. ITEMS LOGIC ---
                let itemsHtml = (order.items || []).map(i => `
                    <div class="item-row">
                        <span><span class="item-qty">${i.qty}x</span> ${i.name}</span>
                        <span class="item-price">‚Çπ${i.price * i.qty}</span>
                    </div>
                `).join('');

                // --- 3. FINANCIALS LOGIC (UPDATED VARIABLE NAMES) ---
                const f = order.financials || { subTotal:0, discountVal:0, packingTotal:0, grandTotal:0 };
                // Fallbacks for older data structure compatibility
                const discount = f.discountVal || f.discountAmount || 0;
                const packing = f.packingTotal || f.packingCharge || 0;
                
                const discountText = f.couponCode && f.couponCode !== "NONE" ? `Discount (${f.couponCode})` : 'Discount';
                
                let finHtml = `
                    <div class="fin-box">
                        <div class="fin-row"><span>Subtotal</span> <span>‚Çπ${f.subTotal || 0}</span></div>
                        ${(discount > 0) ? `<div class="fin-row" style="color:var(--warning)"><span>${discountText}</span> <span>-‚Çπ${discount}</span></div>` : ''}
                        ${(packing > 0) ? `<div class="fin-row"><span>Packing</span> <span>‚Çπ${packing}</span></div>` : ''}
                        <div class="fin-row total"><span>TOTAL</span> <span>‚Çπ${f.grandTotal || 0}</span></div>
                    </div>
                `;

                // --- 4. ACTIONS (UPDATED FLOW) ---
                let btnHtml = '';
                if(order.status === 'pending') {
                    btnHtml = `<button class="btn-act btn-red" onclick="rejectOrder('${order.key}')">Reject</button>
                               <button class="btn-act btn-green" onclick="updateStatus('${order.key}', 'cooking')">Accept</button>`;
                } else if (order.status === 'cooking') {
                    // Changing from "Mark Ready" (direct to out) to "Mark Ready" (sets status DONE)
                     btnHtml = `<button class="btn-act btn-yellow" onclick="updateStatus('${order.key}', 'done')">Mark Ready</button>`;
                } else if (order.status === 'done') {
                    // NEW STATE: Ready -> Out For Delivery
                     btnHtml = `<button class="btn-act btn-purple" onclick="updateStatus('${order.key}', 'out_for_delivery')">Out For Delivery</button>`;
                } else {
                     btnHtml = `<button class="btn-act btn-green" onclick="completeOrder('${order.key}')">Complete</button>`;
                }

                // Inject Card
                const div = document.createElement('div');
                div.className = `order-card status-${order.status}`;
                div.innerHTML = `
                    <div class="card-top">
                        <span class="card-id">#${order.orderId}</span>
                        <span class="card-type">${type}</span>
                    </div>
                    <div class="card-body">
                        ${infoHtml}
                        <div class="items-list">${itemsHtml}</div>
                        ${finHtml}
                    </div>
                    <div class="card-actions">
                        <button class="btn-act btn-blue" style="flex:0.3" onclick="openEditModal('${order.key}')">EDIT</button>
                        ${btnHtml}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- RENDER RIGHT MAP ---
        function renderTableGrid() {
            const gridMain = document.getElementById('grid-main');
            const gridAC = document.getElementById('grid-ac');
            gridMain.innerHTML = "";
            gridAC.innerHTML = "";

            let occupiedCount = Object.keys(tableData).length;
            document.getElementById('dinein-count').innerText = `${occupiedCount} Occupied`;

            for(let i=1; i<=7; i++) createTableCard(i, gridMain);
            createTableCard(8, gridMain, true, "BAR");
            for(let i=9; i<=13; i++) createTableCard(i, gridAC);
        }

        function createTableCard(id, container, isBar=false, label=null) {
            const data = tableData[id];
            const div = document.createElement('div');
            
            let statusClass = 'status-free';
            let timeText = ''; let totalText = ''; let statusLabel = 'FREE';

            if (data) {
                const diff = Date.now() - data.timestamp;
                const tm = Math.floor(diff / 60000);
                const h = Math.floor(tm / 60);
                const m = tm % 60;
                timeText = `${h}:${m.toString().padStart(2,'0')}`;
                totalText = `‚Çπ${data.total}`;
                statusLabel = 'OCCUPIED';

                if (tm < 60) statusClass = 'status-fresh';
                else if (tm < 90) statusClass = 'status-warning';
                else statusClass = 'status-camper';
            }

            div.className = `table-card ${statusClass} ${isBar?'is-bar':''}`;
            if(data) div.onclick = () => openSettleModal(id);

            div.innerHTML = `
                <div class="t-header">
                    <div class="t-num">${label || id}</div>
                    <div class="t-bill">${totalText}</div>
                </div>
                <div class="t-timer">${timeText}</div>
                <div class="t-status">${statusLabel}</div>
            `;
            container.appendChild(div);
        }

        // --- SETTLE MODAL ---
        window.openSettleModal = (tableId) => {
            const data = tableData[tableId];
            if(!data) return;
            currentSettleTable = tableId;
            document.getElementById('settle-modal').style.display = 'flex';
            document.getElementById('modal-table-id').innerText = tableId;
            
            // Render Items
            const list = document.getElementById('modal-items-list');
            list.innerHTML = data.items.map(i => 
                `<div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#aaa;">
                    <span>${i.qty}x ${i.name}</span> <span>‚Çπ${i.price * i.qty}</span>
                </div>`
            ).join('');

            // Render Financials
            document.getElementById('m-sub').innerText = `‚Çπ${data.fins.sub}`;
            document.getElementById('m-disc').innerText = `-‚Çπ${data.fins.disc}`;
            document.getElementById('m-pack').innerText = `‚Çπ${data.fins.pack}`;
            document.getElementById('m-total').innerText = `‚Çπ${data.total}`;
        }

        window.openEditFromTable = () => {
            if(!currentSettleTable || !tableData[currentSettleTable]) return;
            const keys = tableData[currentSettleTable].keys;
            if(keys.length > 0) {
                const lastKey = keys[keys.length - 1];
                closeModal('settle-modal');
                openEditModal(lastKey);
            }
        }

        // --- EDITING LOGIC ---
        window.openEditModal = async (key) => {
            currentEditKey = key;
            document.getElementById('edit-modal').style.display = 'flex';
            
            document.getElementById('new-item-price').value = "";
            document.getElementById('new-item-qty').value = "1";
            document.getElementById('menu-select').value = "";

            const snap = await get(ref(db, 'orders/' + key));
            if(snap.exists()) {
                const order = snap.val();
                renderEditList(order.items || []);
            }
        }

        function renderEditList(items) {
            const container = document.getElementById('edit-list-container');
            container.innerHTML = "";
            items.forEach((item, index) => {
                container.innerHTML += `
                    <div class="edit-row">
                        <button class="btn-icon btn-trash" onclick="deleteItem(${index})">üóë</button>
                        <div style="flex:1">
                            <div style="font-weight:bold">${item.name}</div>
                            <div style="font-size:0.8rem; color:#888;">‚Çπ${item.price} x ${item.qty}</div>
                        </div>
                        <div style="font-family:'JetBrains Mono'">‚Çπ${item.price * item.qty}</div>
                    </div>
                `;
            });
        }

        // --- EDIT ACTIONS (ADD/DELETE) ---
        window.deleteItem = async (index) => {
            if(!currentEditKey) return;
            const orderRef = ref(db, 'orders/' + currentEditKey);
            const snap = await get(orderRef);
            if(!snap.exists()) return;

            let order = snap.val();
            let items = order.items || [];
            items.splice(index, 1); // Remove
            updateOrderFinancials(order, items);
            await update(orderRef, order);
            renderEditList(items);
        }

        window.addNewItemToOrder = async () => {
            if(!currentEditKey) return;
            const select = document.getElementById('menu-select');
            const name = select.value; 
            const selectedOpt = select.options[select.selectedIndex];
            const category = selectedOpt ? selectedOpt.dataset.category : "General";
            
            const price = parseFloat(document.getElementById('new-item-price').value);
            const qty = parseInt(document.getElementById('new-item-qty').value);

            if(!name || !price || !qty) return alert("Select an item and check price");

            const orderRef = ref(db, 'orders/' + currentEditKey);
            const snap = await get(orderRef);
            if(!snap.exists()) return;

            let order = snap.val();
            let items = order.items || [];
            
            // Add Item with Category logic for packing
            items.push({ name, price, qty, category: category });
            
            updateOrderFinancials(order, items);
            await update(orderRef, order);
            renderEditList(items);
            
            // Reset fields
            select.value = "";
            document.getElementById('new-item-price').value = "";
            document.getElementById('new-item-qty').value = "1";
        }

        function updateOrderFinancials(order, items) {
            order.items = items;
            
            // 1. Recalculate Subtotal
            let sub = 0;
            let pack = 0;
            
            // 2. Recalculate Packing Charge (Smart Logic)
            const fiveRsCats = ["Bun-Tastic Burgers", "Freshly Folded", "Toasty Treats"];
            
            items.forEach(i => {
                sub += (i.price * i.qty);
                
                // Smart Packing Calculation
                let charge = 10; // Default
                if(i.category) {
                    if (i.category === 'ADD-ON') charge = i.name.startsWith("Hummus") ? 7 : 5;
                    else if (fiveRsCats.includes(i.category)) charge = 5;
                }
                
                // Add Logic for Rice extras
                if (i.name && (i.name.includes("Tossed Rice") || i.name.includes("Sorted / Boiled"))) {
                    pack += (7 * i.qty);
                } else {
                    pack += (charge * i.qty);
                }
            });
            
            // Keep existing Discount Code logic
            let disc = order.financials ? (order.financials.discountVal || order.financials.discountAmount) : 0;
            let code = order.financials ? order.financials.couponCode : null;

            order.financials = {
                subTotal: sub,
                discountVal: disc,
                couponCode: code,
                packingTotal: pack,
                grandTotal: (sub + pack) - disc
            };
        }

        window.closeModal = (id) => {
            document.getElementById(id).style.display = 'none';
            if(id === 'edit-modal') currentEditKey = null;
        }

        window.updateStatus = (key, status) => update(ref(db, 'orders/'+key), {status});
        window.rejectOrder = (key) => remove(ref(db, 'orders/'+key)); 
        window.completeOrder = async (key) => {
            const r = ref(db, 'orders/'+key);
            const s = await get(r);
            if(s.exists()){
                const d = s.val(); d.status='completed'; d.completedAt=Date.now();
                await set(ref(db, 'history/'+key), d);
                await remove(r);
            }
        };
        window.settleAndClear = async () => {
            if(!currentSettleTable || !tableData[currentSettleTable]) return;
            const keys = tableData[currentSettleTable].keys;
            for (const key of keys) {
                await completeOrder(key);
            }
            closeModal('settle-modal');
        }

        setInterval(() => { renderTableGrid(); document.getElementById('clock').innerText = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }, 60000);
        document.getElementById('clock').innerText = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    </script>
</body>
</html>
